<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Applicants - FunaGig</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <header class="navbar">
        <div class="brand">
            <div class="logo"></div> FunaGig
        </div>
    </header>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="title" style="display:flex; align-items:center; gap:10px;">
                <div class="cover-img" style="width:36px;height:36px;">TS</div> Tech Solutions Inc.
            </div>
            <nav class="navlist">
                <a class="navitem" href="business-dashboard.html">Dashboard</a>
                <a class="navitem" href="business-post-gig.html">Post Gig</a>
                <a class="navitem" href="business-posted-gigs.html">My Gigs</a>
                <a class="navitem active" href="business-applicants.html">Applicants</a>
                <a class="navitem" href="business-messaging.html">Messages</a>
                <a class="navitem" href="business-profile.html">Profile</a>
                <a class="navitem" href="#" onclick="Auth.logout(); return false;">Log out</a>
            </nav>
        </aside>
        <main class="content">
            <div class="flex items-center justify-between mb-20">
                <div>
                    <h1 class="h1" style="font-size:28px; margin:0;">Applicants</h1>
                    <p class="subtle">Review and manage applications for your gigs</p>
                </div>
                <div class="flex gap-10">
                    <a href="business-posted-gigs.html" class="btn secondary">View My Gigs</a>
                    <a href="business-dashboard.html" class="btn ghost">Back to Dashboard</a>
                </div>
            </div>

            <!-- Filter and Search -->
            <div class="section mb-20">
                <div class="flex items-center gap-10" style="flex-wrap: wrap;">
                    <div class="field" style="flex: 1; min-width: 200px;">
                        <input type="text" class="input" placeholder="Search applicants..." id="searchInput">
                    </div>
                    <div class="field">
                        <select class="select" id="gigFilter">
                            <option value="">All Gigs</option>
                            <option value="1">Website Development</option>
                            <option value="2">Social Media Management</option>
                            <option value="3">Mobile App Development</option>
                        </select>
                    </div>
                    <div class="field">
                        <select class="select" id="statusFilter">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="accepted">Accepted</option>
                            <option value="rejected">Rejected</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div class="field">
                        <select class="select" id="sortBy">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="name_asc">Name: A to Z</option>
                            <option value="name_desc">Name: Z to A</option>
                        </select>
                    </div>
                    <button class="btn secondary">Filter</button>
                </div>
            </div>

            <!-- Applicants List -->
            <div class="section">
                <h2 class="h2 mb-20">All Applicants</h2>
                <div id="applicantsList">
                    <!-- Sample Applicant Cards -->
                    <div class="card-compact mb-20">
                        <div class="flex items-center justify-between" style="flex-wrap: wrap; gap: 20px;">
                            <div style="flex: 1; min-width: 300px;">
                                <div class="flex items-center gap-10 mb-10">
                                    <div class="cover-img" style="width:50px;height:50px;font-size:20px;">AP</div>
                                    <div>
                                        <h3 style="margin: 0; font-size: 18px;">Amanya Peter</h3>
                                        <p class="subtle" style="margin: 4px 0;">Makerere University ‚Ä¢ Computer Science</p>
                                        <p class="subtle" style="font-size: 12px;">Applied for: <strong>Website Development</strong></p>
                                    </div>
                                </div>
                                <div class="mb-10">
                                    <p class="subtle" style="margin-bottom: 8px;"><strong>Application Message:</strong></p>
                                    <p class="subtle">I am a passionate developer with 3 years of experience in web development. I have worked on various projects using JavaScript, React, and Node.js. I am excited about this opportunity and would love to contribute to your project.</p>
                                </div>
                                <div class="flex items-center gap-10" style="flex-wrap: wrap;">
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Skills:</span>
                                        <span>JavaScript, React, Node.js, HTML/CSS</span>
                                    </div>
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Applied:</span>
                                        <span>2 days ago</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-10" style="flex-direction: column;">
                                <span class="pill yellow">Pending</span>
                                <div class="flex gap-10">
                                    <button class="btn">Accept</button>
                                    <button class="btn ghost" style="color: var(--danger);">Reject</button>
                                </div>
                                <button class="btn secondary">View Profile</button>
                                <button class="btn ghost">Message</button>
                            </div>
                        </div>
                    </div>

                    <div class="card-compact mb-20">
                        <div class="flex items-center justify-between" style="flex-wrap: wrap; gap: 20px;">
                            <div style="flex: 1; min-width: 300px;">
                                <div class="flex items-center gap-10 mb-10">
                                    <div class="cover-img" style="width:50px;height:50px;font-size:20px;">AK</div>
                                    <div>
                                        <h3 style="margin: 0; font-size: 18px;">Alex Kiprotich</h3>
                                        <p class="subtle" style="margin: 4px 0;">University of Nairobi ‚Ä¢ Business Administration</p>
                                        <p class="subtle" style="font-size: 12px;">Applied for: <strong>Social Media Management</strong></p>
                                    </div>
                                </div>
                                <div class="mb-10">
                                    <p class="subtle" style="margin-bottom: 8px;"><strong>Application Message:</strong></p>
                                    <p class="subtle">I have extensive experience in social media management and content creation. I have managed multiple social media accounts and created engaging content that increased engagement by 300%.</p>
                                </div>
                                <div class="flex items-center gap-10" style="flex-wrap: wrap;">
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Skills:</span>
                                        <span>Social Media, Content Writing, Marketing</span>
                                    </div>
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Applied:</span>
                                        <span>5 days ago</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-10" style="flex-direction: column;">
                                <span class="pill green">Accepted</span>
                                <div class="flex gap-10">
                                    <button class="btn secondary">View Details</button>
                                </div>
                                <button class="btn secondary">View Profile</button>
                                <button class="btn ghost">Message</button>
                            </div>
                        </div>
                    </div>

                    <div class="card-compact mb-20">
                        <div class="flex items-center justify-between" style="flex-wrap: wrap; gap: 20px;">
                            <div style="flex: 1; min-width: 300px;">
                                <div class="flex items-center gap-10 mb-10">
                                    <div class="cover-img" style="width:50px;height:50px;font-size:20px;">SM</div>
                                    <div>
                                        <h3 style="margin: 0; font-size: 18px;">Sarah Mwangi</h3>
                                        <p class="subtle" style="margin: 4px 0;">Kenyatta University ‚Ä¢ Software Engineering</p>
                                        <p class="subtle" style="font-size: 12px;">Applied for: <strong>Mobile App Development</strong></p>
                                    </div>
                                </div>
                                <div class="mb-10">
                                    <p class="subtle" style="margin-bottom: 8px;"><strong>Application Message:</strong></p>
                                    <p class="subtle">I am a mobile app developer with expertise in React Native and Flutter. I have developed several successful mobile applications and I am confident I can deliver high-quality work for your project.</p>
                                </div>
                                <div class="flex items-center gap-10" style="flex-wrap: wrap;">
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Skills:</span>
                                        <span>React Native, Flutter, JavaScript, Mobile Development</span>
                                    </div>
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Applied:</span>
                                        <span>1 week ago</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-10" style="flex-direction: column;">
                                <span class="pill yellow">Pending</span>
                                <div class="flex gap-10">
                                    <button class="btn">Accept</button>
                                    <button class="btn ghost" style="color: var(--danger);">Reject</button>
                                </div>
                                <button class="btn secondary">View Profile</button>
                                <button class="btn ghost">Message</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" style="display: none; text-align: center; padding: 40px;">
                    <p class="subtle" style="font-size: 18px;">No applicants found</p>
                    <a href="business-posted-gigs.html" class="btn mt-10">View My Gigs</a>
                </div>
            </div>
        </main>
    </div>

    <script src="app.js"></script>
    <script>
        let allApplicants = []; // Store all applicants for filtering
        let allGigs = []; // Store all gigs for filter dropdown
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentSort = 'newest';
        
        // Load user data and update sidebar
        document.addEventListener('DOMContentLoaded', async function() {
            // Verify session and check user type
            if (!Auth.requireUserType('business')) {
                return;
            }
            
            // Verify session is still valid
            const user = await Auth.verifySession();
            if (!user) {
                return; // verifySession already handles logout/redirect
            }
            
            if (user) {
                
                const userName = user.name;
                const userInitials = userName.split(' ').map(n => n[0]).join('').toUpperCase();
                
                const sidebarTitle = document.querySelector('.sidebar .title');
                if (sidebarTitle) {
                    sidebarTitle.innerHTML = `<div class="cover-img" style="width:36px;height:36px;">${userInitials}</div> ${userName}`;
                }
                
                // Load gigs first (for filter dropdown), then applicants
                loadGigs().then(() => {
                    loadApplicants();
                    setupSearchAndFilter();
                });
            }
        });
        
        // Load gigs for filter dropdown
        async function loadGigs() {
            try {
                const response = await apiFetch('/gigs/active');
                if (response.success && response.gigs) {
                    allGigs = response.gigs;
                    populateGigFilter();
                }
            } catch (error) {
                console.error('Failed to load gigs:', error);
            }
        }
        
        // Populate gig filter dropdown
        function populateGigFilter() {
            const gigFilter = document.getElementById('gigFilter');
            if (!gigFilter) return;
            
            // Keep "All Gigs" option
            gigFilter.innerHTML = '<option value="">All Gigs</option>';
            
            // Add gig options
            allGigs.forEach(gig => {
                const option = document.createElement('option');
                option.value = gig.id;
                option.textContent = gig.title;
                gigFilter.appendChild(option);
            });
            
            // URL parameter handling is done in setupSearchAndFilter()
        }
        
        // Load applicants from API
        async function loadApplicants() {
            const applicantsList = document.getElementById('applicantsList');
            if (!applicantsList) return;
            
            // Show loading state
            Loading.show(applicantsList, 'Loading applicants...');
            
            try {
                // Check if filtering by specific gig (from URL or dropdown)
                const gigFilter = document.getElementById('gigFilter');
                const selectedGigId = gigFilter ? gigFilter.value : null;
                const urlGigId = URLState.get('gig');
                const finalGigId = urlGigId || selectedGigId;
                
                let endpoint = '/applicants';
                if (finalGigId) {
                    endpoint += `?gig_id=${finalGigId}`;
                }
                
                const response = await apiFetch(endpoint);
                Loading.hide(applicantsList);
                
                if (response.success && response.applicants) {
                    allApplicants = response.applicants;
                    if (allApplicants.length === 0) {
                        EmptyState.show(
                            applicantsList,
                            'üë•',
                            'No Applicants Yet',
                            'You don\'t have any applicants at the moment. Post gigs to start receiving applications from students.',
                            '<a href="business-post-gig.html" class="btn">Post a Gig</a>'
                        );
                    } else {
                        // Apply current filters after reload
                        filterApplicants();
                    }
                } else if (response.success && response.applications) {
                    // Handle if API returns 'applications' instead of 'applicants'
                    allApplicants = response.applications;
                    if (allApplicants.length === 0) {
                        EmptyState.show(
                            applicantsList,
                            'üë•',
                            'No Applicants Yet',
                            'You don\'t have any applicants at the moment. Post gigs to start receiving applications from students.',
                            '<a href="business-post-gig.html" class="btn">Post a Gig</a>'
                        );
                    } else {
                        // Apply current filters after reload
                        filterApplicants();
                    }
                } else {
                    EmptyState.show(
                        applicantsList,
                        '‚ö†Ô∏è',
                        'Unable to Load Applicants',
                        'There was an error loading applicants. Please try refreshing the page.',
                        '<button class="btn" onclick="loadApplicants()">Retry</button>'
                    );
                }
            } catch (error) {
                Loading.hide(applicantsList);
                console.error('Failed to load applicants:', error);
                ErrorRecovery.handleApiError(
                    error,
                    applicantsList,
                    loadApplicants,
                    { maxRetries: 3 }
                );
            }
        }
        
        // Display applicants in the list with pagination
        function displayApplicants(applicants, resetPage = false) {
            const applicantsList = document.getElementById('applicantsList');
            const emptyState = document.getElementById('emptyState');
            
            if (!applicantsList) return;
            
            // Reset to first page when filtering
            if (resetPage) {
                currentPage = 1;
            }
            
            if (!applicants || applicants.length === 0) {
                EmptyState.show(
                    applicantsList,
                    'üîç',
                    'No Applicants Found',
                    'No applicants match your current filters. Try adjusting your search or filters.',
                    '<button class="btn secondary" onclick="document.getElementById(\'searchInput\').value=\'\'; document.getElementById(\'gigFilter\').value=\'\'; document.getElementById(\'statusFilter\').value=\'\'; filterApplicants();">Clear Filters</button>'
                );
                return;
            }
            
            // Hide empty state if it exists
            if (emptyState) emptyState.style.display = 'none';
            applicantsList.style.display = 'block';
            
            // Paginate the results
            const paginated = Pagination.paginate(applicants, currentPage, itemsPerPage);
            
            // Generate applicant cards for current page
            applicantsList.innerHTML = paginated.data.map(applicant => {
                const statusColors = {
                    'pending': 'yellow',
                    'accepted': 'green',
                    'rejected': 'red',
                    'completed': 'blue'
                };
                
                const statusColor = statusColors[applicant.status] || 'yellow';
                const studentName = applicant.student_name || 'Unknown Student';
                const initials = getInitials(studentName);
                const appliedDate = formatDate(applicant.applied_at);
                const skills = applicant.skills || 'Not specified';
                
                return `
                    <div class="card-compact mb-20">
                        <div class="flex items-center justify-between" style="flex-wrap: wrap; gap: 20px;">
                            <div style="flex: 1; min-width: 300px;">
                                <div class="flex items-center gap-10 mb-10">
                                    <div class="cover-img" style="width:50px;height:50px;font-size:20px;">${initials}</div>
                                    <div>
                                        <h3 style="margin: 0; font-size: 18px;">${escapeHtml(studentName)}</h3>
                                        <p class="subtle" style="margin: 4px 0;">${escapeHtml(applicant.university || '')} ${applicant.university && applicant.major ? '‚Ä¢' : ''} ${escapeHtml(applicant.major || '')}</p>
                                        <p class="subtle" style="font-size: 12px;">Applied for: <strong>${escapeHtml(applicant.gig_title || 'Unknown Gig')}</strong></p>
                                    </div>
                                </div>
                                ${applicant.message ? `
                                <div class="mb-10">
                                    <p class="subtle" style="margin-bottom: 8px;"><strong>Application Message:</strong></p>
                                    <p class="subtle">${escapeHtml(applicant.message)}</p>
                                </div>
                                ` : ''}
                                <div class="flex items-center gap-10" style="flex-wrap: wrap;">
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Skills:</span>
                                        <span>${escapeHtml(skills)}</span>
                                    </div>
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Applied:</span>
                                        <span>${appliedDate}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-10" style="flex-direction: column;">
                                <span class="pill ${statusColor}">${applicant.status || 'pending'}</span>
                                ${applicant.status === 'pending' ? `
                                <div class="flex gap-10">
                                    <button class="btn" onclick="acceptApplicant(${applicant.id}, '${escapeHtml(studentName)}')">Accept</button>
                                    <button class="btn ghost" style="color: var(--danger);" onclick="rejectApplicant(${applicant.id}, '${escapeHtml(studentName)}')">Reject</button>
                                </div>
                                ` : applicant.status === 'accepted' ? `
                                <div class="flex gap-10">
                                    <button class="btn secondary">View Details</button>
                                </div>
                                ` : ''}
                                <button class="btn secondary" onclick="viewStudentProfile(${applicant.user_id})">View Profile</button>
                                <button class="btn ghost" onclick="messageStudent(${applicant.user_id}, '${escapeHtml(studentName)}')">Message</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Remove existing pagination
            const existingPagination = document.getElementById('applicantsPagination');
            if (existingPagination) existingPagination.remove();
            
            // Add pagination if needed
            if (paginated.totalPages > 1) {
                const paginationContainer = Pagination.create(
                    currentPage,
                    paginated.totalPages,
                    (page) => {
                        currentPage = page;
                        displayApplicants(applicants, false);
                        // Scroll to top of list
                        applicantsList.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                );
                paginationContainer.id = 'applicantsPagination';
                applicantsList.parentElement.appendChild(paginationContainer);
            }
        }
        
        // Setup search and filter functionality
        function setupSearchAndFilter() {
            const searchInput = document.getElementById('searchInput');
            const gigFilter = document.getElementById('gigFilter');
            const statusFilter = document.getElementById('statusFilter');
            const sortBy = document.getElementById('sortBy');
            const filterBtn = document.querySelector('.section .btn.secondary');
            
            // Load state from URL on page load
            const urlSearch = URLState.get('search', '');
            const urlGig = URLState.get('gig', '');
            const urlStatus = URLState.get('status', '');
            const urlSort = URLState.get('sort', 'newest');
            
            if (urlSearch && searchInput) {
                searchInput.value = urlSearch;
            }
            if (urlGig && gigFilter) {
                gigFilter.value = urlGig;
            }
            if (urlStatus && statusFilter) {
                statusFilter.value = urlStatus;
            }
            if (urlSort && sortBy) {
                sortBy.value = urlSort;
                currentSort = urlSort;
            }
            
            // Search functionality with debouncing and loading indicator
            if (searchInput) {
                const debouncedFilter = Debounce.create(() => {
                    // Update URL with search term
                    URLState.set('search', searchInput.value || null);
                    filterApplicants();
                }, 300, {
                    showLoading: true,
                    loadingElement: searchInput
                });
                
                searchInput.addEventListener('input', debouncedFilter);
            }
            
            // Gig filter
            if (gigFilter) {
                gigFilter.addEventListener('change', function() {
                    // Update URL with gig filter
                    URLState.set('gig', this.value || null);
                    filterApplicants();
                });
            }
            
            // Status filter
            if (statusFilter) {
                statusFilter.addEventListener('change', function() {
                    // Update URL with status filter
                    URLState.set('status', this.value || null);
                    filterApplicants();
                });
            }
            
            // Sort functionality
            if (sortBy) {
                sortBy.addEventListener('change', function() {
                    currentSort = this.value;
                    // Update URL with sort option
                    URLState.set('sort', this.value || null);
                    filterApplicants();
                });
            }
            
            // Filter button
            if (filterBtn) {
                filterBtn.addEventListener('click', function() {
                    filterApplicants();
                });
            }
            
            // Watch for URL changes (browser back/forward)
            URLState.watch(() => {
                const urlSearch = URLState.get('search', '');
                const urlGig = URLState.get('gig', '');
                const urlStatus = URLState.get('status', '');
                const urlSort = URLState.get('sort', 'newest');
                
                if (searchInput && urlSearch !== searchInput.value) {
                    searchInput.value = urlSearch;
                }
                if (gigFilter && urlGig !== gigFilter.value) {
                    gigFilter.value = urlGig;
                }
                if (statusFilter && urlStatus !== statusFilter.value) {
                    statusFilter.value = urlStatus;
                }
                if (sortBy && urlSort !== sortBy.value) {
                    sortBy.value = urlSort;
                    currentSort = urlSort;
                }
                
                filterApplicants();
            });
        }
        
        // Sort applicants based on selected sort option
        function sortApplicants(applicants) {
            if (!applicants || applicants.length === 0) return applicants;
            
            let sorted = [...applicants];
            
            switch (currentSort) {
                case 'newest':
                    sorted = Sort.byDate(sorted, 'applied_at', 'desc');
                    break;
                case 'oldest':
                    sorted = Sort.byDate(sorted, 'applied_at', 'asc');
                    break;
                case 'name_asc':
                    sorted = Sort.byString(sorted, 'student_name', 'asc');
                    break;
                case 'name_desc':
                    sorted = Sort.byString(sorted, 'student_name', 'desc');
                    break;
                default:
                    sorted = Sort.byDate(sorted, 'applied_at', 'desc');
            }
            
            return sorted;
        }
        
        // Filter applicants based on search, gig, and status
        function filterApplicants() {
            const searchTerm = (document.getElementById('searchInput')?.value || '').toLowerCase();
            const gigFilter = document.getElementById('gigFilter')?.value || '';
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            
            let filtered = allApplicants;
            
            // Filter by gig
            if (gigFilter) {
                filtered = filtered.filter(applicant => {
                    // Check if applicant has gig_id or if we need to match by gig_title
                    return applicant.gig_id == gigFilter || 
                           (allGigs.find(g => g.id == gigFilter && g.title === applicant.gig_title));
                });
            }
            
            // Filter by status
            if (statusFilter) {
                filtered = filtered.filter(applicant => applicant.status === statusFilter);
            }
            
            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(applicant => {
                    const name = (applicant.student_name || '').toLowerCase();
                    const university = (applicant.university || '').toLowerCase();
                    const major = (applicant.major || '').toLowerCase();
                    const skills = (applicant.skills || '').toLowerCase();
                    const message = (applicant.message || '').toLowerCase();
                    const gigTitle = (applicant.gig_title || '').toLowerCase();
                    
                    return name.includes(searchTerm) || 
                           university.includes(searchTerm) || 
                           major.includes(searchTerm) || 
                           skills.includes(searchTerm) || 
                           message.includes(searchTerm) ||
                           gigTitle.includes(searchTerm);
                });
            }
            
            // Sort the filtered results
            filtered = sortApplicants(filtered);
            
            displayApplicants(filtered, true); // Reset to page 1 when filtering
        }
        
        // Get initials from name
        function getInitials(name) {
            if (!name) return '?';
            const parts = name.trim().split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }
        
        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diffTime = Math.abs(now - date);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) return 'Today';
                if (diffDays === 1) return 'Yesterday';
                if (diffDays < 7) return `${diffDays} days ago`;
                if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
                
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            } catch (e) {
                return 'Unknown';
            }
        }
        
        // Accept applicant
        async function acceptApplicant(applicationId, studentName) {
            const confirmed = await Confirm.action(
                'Accept Applicant',
                `Accept ${studentName}'s application? This will notify the student and create a conversation.`,
                'Accept'
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                const response = await apiFetch('/applicants/accept', {
                    method: 'POST',
                    body: JSON.stringify({
                        application_id: applicationId
                    })
                });
                
                if (response.success) {
                    showNotification(`${studentName}'s application has been accepted!`, 'success');
                    
                    // Find the applicant to get student_id for conversation
                    const applicant = allApplicants.find(a => a.id === applicationId);
                    if (applicant && applicant.user_id) {
                        // Create or get conversation with the student
                        await createConversationIfNeeded(applicant.user_id);
                    }
                    
                    // Reload applicants to show updated status
                    await loadApplicants();
                } else {
                    showNotification('Failed to accept application. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error accepting applicant:', error);
                showNotification('Failed to accept application. Please try again.', 'error');
            }
        }
        
        // Reject applicant
        async function rejectApplicant(applicationId, studentName) {
            const confirmed = await Confirm.action(
                'Reject Applicant',
                `Reject ${studentName}'s application? This will notify the student.`,
                'Reject'
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                const response = await apiFetch('/applicants/reject', {
                    method: 'POST',
                    body: JSON.stringify({
                        application_id: applicationId
                    })
                });
                
                if (response.success) {
                    showNotification(`${studentName}'s application has been rejected.`, 'info');
                    
                    // Reload applicants to show updated status
                    await loadApplicants();
                } else {
                    showNotification('Failed to reject application. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error rejecting applicant:', error);
                showNotification('Failed to reject application. Please try again.', 'error');
            }
        }
        
        // Create conversation if it doesn't exist
        async function createConversationIfNeeded(studentId) {
            try {
                // Check if conversation already exists by trying to get conversations
                const conversationsResponse = await apiFetch('/conversations');
                if (conversationsResponse.success) {
                    const existingConversation = conversationsResponse.conversations.find(
                        conv => conv.other_user_id == studentId
                    );
                    
                    if (!existingConversation) {
                        // Create new conversation
                        await apiFetch('/conversations', {
                            method: 'POST',
                            body: JSON.stringify({
                                user_id: studentId
                            })
                        });
                    }
                }
            } catch (error) {
                console.error('Error creating conversation:', error);
                // Don't show error - conversation creation is optional
            }
        }
        
        // View student profile (placeholder)
        function viewStudentProfile(studentId) {
            showNotification('Student profile view coming soon', 'info');
            // TODO: Implement profile view modal or redirect
        }
        
        // Message student - create conversation and redirect
        async function messageStudent(studentId, studentName) {
            try {
                // Create conversation if it doesn't exist
                await createConversationIfNeeded(studentId);
                
                // Redirect to messaging page
                window.location.href = 'business-messaging.html';
            } catch (error) {
                console.error('Error messaging student:', error);
                showNotification('Failed to open conversation. Please try again.', 'error');
            }
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

