<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Post a New Gig - FunaGig</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <header class="navbar">
        <div class="brand">
            <div class="logo"></div> FunaGig
        </div>
    </header>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="title" style="display:flex; align-items:center; gap:10px;">
                <div class="cover-img" style="width:36px;height:36px;">TS</div> Tech Solutions Inc.
            </div>
            <nav class="navlist">
                <a class="navitem" href="business-dashboard.html">Dashboard</a>
                <a class="navitem active" href="business-post-gig.html">Post Gig</a>
                <a class="navitem" href="business-posted-gigs.html">My Gigs</a>
                <a class="navitem" href="business-applicants.html">Applicants</a>
                <a class="navitem" href="business-messaging.html">Messages</a>
                <a class="navitem" href="business-profile.html">Profile</a>
                <a class="navitem" href="#" onclick="Auth.logout(); return false;">Log out</a>
            </nav>
        </aside>
        <main class="content">
            <div class="section">
                <div class="flex items-center justify-between mb-20">
                    <div>
                        <h1 class="h1" style="font-size:28px; margin:0;">Post a New Gig</h1>
                        <p class="subtle">Create an engaging gig post to attract the best student talent</p>
                    </div>
                    <div class="flex gap-10">
                        <a href="business-posted-gigs.html" class="btn secondary">View My Gigs</a>
                        <a href="business-dashboard.html" class="btn ghost">Back to Dashboard</a>
                    </div>
                </div>

                <form id="post-gig-form" class="card-lg">
                    <!-- Basic Information -->
                    <div class="form-section">
                        <h2>Basic Information</h2>
                        <div class="form-grid">
                            <div class="field">
                                <label for="gigTitle" class="label">Gig Title *</label>
                                <input type="text" id="gigTitle" class="input" placeholder="e.g., Software Engineer Intern" required>
                                <div class="error-message" id="gigTitleError"></div>
                            </div>

                            <div class="field">
                                <label for="gigDescription" class="label">Description *</label>
                                <textarea id="gigDescription" class="textarea" rows="4" placeholder="Describe the role, responsibilities, and what students will learn..." required></textarea>
                                <div class="error-message" id="gigDescriptionError"></div>
                            </div>

                            <div class="field">
                                <label for="gigType" class="label">Type *</label>
                                <select id="gigType" class="select" required>
                                    <option value="">Select type</option>
                                    <option value="one-time">One-time</option>
                                    <option value="ongoing">Ongoing</option>
                                    <option value="contract">Contract</option>
                                </select>
                                <div class="error-message" id="gigTypeError"></div>
                            </div>

                            <div class="field">
                                <label for="skills" class="label">Required Skills *</label>
                                <textarea id="skills" class="textarea" rows="3" placeholder="e.g., JavaScript, React, Node.js" required></textarea>
                                <div class="error-message" id="skillsError"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Compensation & Timeline -->
                    <div class="form-section">
                        <h2>Compensation & Timeline</h2>
                        <div class="form-grid">
                            <div class="field">
                                <label for="budget" class="label">Budget (UGX) *</label>
                                <input type="number" id="budget" class="input" placeholder="e.g., 500000" min="0" required>
                                <div class="error-message" id="budgetError"></div>
                            </div>

                            <div class="field">
                                <label for="deadline" class="label">Deadline *</label>
                                <input type="date" id="deadline" class="input" required>
                                <div class="error-message" id="deadlineError"></div>
                            </div>

                            <div class="field">
                                <label for="location" class="label">Location</label>
                                <input type="text" id="location" class="input" placeholder="e.g., Remote, Kampala">
                                <div class="error-message" id="locationError"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="form-navigation mt-20">
                        <div class="flex gap-10">
                            <button type="button" class="btn ghost" id="saveDraftBtn">Save as Draft</button>
                            <button type="submit" class="btn">Post Gig</button>
                        </div>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script src="app.js"></script>
    <script>
        // Load user data and update sidebar
        document.addEventListener('DOMContentLoaded', async function() {
            // Verify session and check user type
            if (!Auth.requireUserType('business')) {
                return;
            }
            
            // Verify session is still valid
            const user = await Auth.verifySession();
            if (!user) {
                return; // verifySession already handles logout/redirect
            }
            
            if (user) {
                
                const userName = user.name;
                const userInitials = userName.split(' ').map(n => n[0]).join('').toUpperCase();
                
                const sidebarTitle = document.querySelector('.sidebar .title');
                if (sidebarTitle) {
                    sidebarTitle.innerHTML = `<div class="cover-img" style="width:36px;height:36px;">${userInitials}</div> ${userName}`;
                }
                
                // Set minimum date for deadline (today)
                const deadlineInput = document.getElementById('deadline');
                if (deadlineInput) {
                    const today = new Date().toISOString().split('T')[0];
                    deadlineInput.setAttribute('min', today);
                }
                
                // Setup form submission
                setupFormSubmission();
                // Setup real-time validation
                setupRealTimeValidation();
            }
        });
        
        // Setup form submission handler
        function setupFormSubmission() {
            const form = document.getElementById('post-gig-form');
            if (!form) return;
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Validate form
                if (!validateForm()) {
                    return;
                }
                
                // Submit form
                await submitGig();
            });
            
            // Save as draft button (placeholder)
            const saveDraftBtn = document.getElementById('saveDraftBtn');
            if (saveDraftBtn) {
                saveDraftBtn.addEventListener('click', function() {
                    showNotification('Draft functionality coming soon', 'info');
                    // TODO: Implement draft saving
                });
            }
        }
        
        // Setup real-time validation
        function setupRealTimeValidation() {
            // Title validation
            const titleInput = document.getElementById('gigTitle');
            if (titleInput) {
                titleInput.addEventListener('blur', function() {
                    const value = this.value.trim();
                    if (!value) {
                        showError('gigTitleError', 'Gig title is required');
                    } else if (value.length < 5) {
                        showError('gigTitleError', 'Title must be at least 5 characters');
                    } else {
                        clearFieldError('gigTitleError', 'gigTitle');
                    }
                });
                titleInput.addEventListener('input', function() {
                    if (this.value.trim().length >= 5) {
                        clearFieldError('gigTitleError', 'gigTitle');
                    }
                });
            }
            
            // Description validation
            const descInput = document.getElementById('gigDescription');
            if (descInput) {
                descInput.addEventListener('blur', function() {
                    const value = this.value.trim();
                    if (!value) {
                        showError('gigDescriptionError', 'Description is required');
                    } else if (value.length < 20) {
                        showError('gigDescriptionError', 'Description must be at least 20 characters');
                    } else {
                        clearFieldError('gigDescriptionError', 'gigDescription');
                    }
                });
                descInput.addEventListener('input', function() {
                    if (this.value.trim().length >= 20) {
                        clearFieldError('gigDescriptionError', 'gigDescription');
                    }
                });
            }
            
            // Type validation
            const typeInput = document.getElementById('gigType');
            if (typeInput) {
                typeInput.addEventListener('change', function() {
                    if (this.value) {
                        clearFieldError('gigTypeError', 'gigType');
                    }
                });
            }
            
            // Skills validation
            const skillsInput = document.getElementById('skills');
            if (skillsInput) {
                skillsInput.addEventListener('blur', function() {
                    const value = this.value.trim();
                    if (!value) {
                        showError('skillsError', 'Required skills are required');
                    } else {
                        clearFieldError('skillsError', 'skills');
                    }
                });
                skillsInput.addEventListener('input', function() {
                    if (this.value.trim()) {
                        clearFieldError('skillsError', 'skills');
                    }
                });
            }
            
            // Budget validation
            const budgetInput = document.getElementById('budget');
            if (budgetInput) {
                budgetInput.addEventListener('blur', function() {
                    const value = parseFloat(this.value);
                    if (!this.value) {
                        showError('budgetError', 'Budget is required');
                    } else if (isNaN(value) || value <= 0) {
                        showError('budgetError', 'Budget must be greater than 0');
                    } else if (value < 10000) {
                        showError('budgetError', 'Budget must be at least 10,000 UGX');
                    } else {
                        clearFieldError('budgetError', 'budget');
                    }
                });
                budgetInput.addEventListener('input', function() {
                    const value = parseFloat(this.value);
                    if (value && value >= 10000) {
                        clearFieldError('budgetError', 'budget');
                    }
                });
            }
            
            // Deadline validation
            const deadlineInput = document.getElementById('deadline');
            if (deadlineInput) {
                deadlineInput.addEventListener('change', function() {
                    if (this.value) {
                        const deadlineDate = new Date(this.value);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        if (deadlineDate <= today) {
                            showError('deadlineError', 'Deadline must be in the future');
                        } else {
                            clearFieldError('deadlineError', 'deadline');
                        }
                    }
                });
            }
        }
        
        // Clear error for a specific field
        function clearFieldError(errorElementId, inputElementId) {
            const errorElement = document.getElementById(errorElementId);
            if (errorElement) {
                errorElement.textContent = '';
                errorElement.style.display = 'none';
            }
            
            const input = document.getElementById(inputElementId);
            if (input) {
                input.classList.remove('error');
            }
        }
        
        // Validate form
        function validateForm() {
            let isValid = true;
            
            // Clear previous errors
            clearErrors();
            
            // Get form values
            const title = document.getElementById('gigTitle').value.trim();
            const description = document.getElementById('gigDescription').value.trim();
            const type = document.getElementById('gigType').value;
            const skills = document.getElementById('skills').value.trim();
            const budget = document.getElementById('budget').value;
            const deadline = document.getElementById('deadline').value;
            const location = document.getElementById('location').value.trim();
            
            // Validate title
            if (!title) {
                showError('gigTitleError', 'Gig title is required');
                isValid = false;
            } else if (title.length < 5) {
                showError('gigTitleError', 'Title must be at least 5 characters');
                isValid = false;
            }
            
            // Validate description
            if (!description) {
                showError('gigDescriptionError', 'Description is required');
                isValid = false;
            } else if (description.length < 20) {
                showError('gigDescriptionError', 'Description must be at least 20 characters');
                isValid = false;
            }
            
            // Validate type
            if (!type) {
                showError('gigTypeError', 'Please select a gig type');
                isValid = false;
            }
            
            // Validate skills
            if (!skills) {
                showError('skillsError', 'Required skills are required');
                isValid = false;
            }
            
            // Validate budget
            if (!budget) {
                showError('budgetError', 'Budget is required');
                isValid = false;
            } else if (parseFloat(budget) <= 0) {
                showError('budgetError', 'Budget must be greater than 0');
                isValid = false;
            } else if (parseFloat(budget) < 10000) {
                showError('budgetError', 'Budget must be at least 10,000 UGX');
                isValid = false;
            }
            
            // Validate deadline
            if (!deadline) {
                showError('deadlineError', 'Deadline is required');
                isValid = false;
            } else {
                const deadlineDate = new Date(deadline);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (deadlineDate <= today) {
                    showError('deadlineError', 'Deadline must be in the future');
                    isValid = false;
                }
            }
            
            return isValid;
        }
        
        // Submit gig to API
        async function submitGig() {
            const submitBtn = document.querySelector('#post-gig-form button[type="submit"]');
            const form = document.getElementById('post-gig-form');
            
            try {
                // Show loading state on button
                Loading.setButtonLoading(submitBtn, true);
                submitBtn.textContent = 'Posting...';
                
                // Get form values
                const gigData = {
                    title: document.getElementById('gigTitle').value.trim(),
                    description: document.getElementById('gigDescription').value.trim(),
                    type: document.getElementById('gigType').value,
                    skills: document.getElementById('skills').value.trim(),
                    budget: parseFloat(document.getElementById('budget').value),
                    deadline: document.getElementById('deadline').value,
                    location: document.getElementById('location').value.trim() || 'Remote'
                };
                
                // Submit to API
                const response = await apiFetch('/gigs', {
                    method: 'POST',
                    body: JSON.stringify(gigData)
                });
                
                if (response.success) {
                    showNotification('Gig posted successfully!', 'success');
                    
                    // Redirect to posted gigs page after short delay
                    setTimeout(() => {
                        window.location.href = 'business-posted-gigs.html';
                    }, 1500);
                } else {
                    showNotification(response.error || 'Failed to post gig', 'error');
                    Loading.setButtonLoading(submitBtn, false);
                }
            } catch (error) {
                console.error('Error posting gig:', error);
                showNotification('Failed to post gig. Please try again.', 'error');
                Loading.setButtonLoading(submitBtn, false);
            }
        }
        
        // Show error message
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                errorElement.style.color = 'var(--danger)';
            }
            
            // Add error class to input
            const inputId = elementId.replace('Error', '');
            const input = document.getElementById(inputId);
            if (input) {
                input.classList.add('error');
            }
        }
        
        // Clear all errors
        function clearErrors() {
            const errorElements = document.querySelectorAll('.error-message');
            errorElements.forEach(el => {
                el.textContent = '';
                el.style.display = 'none';
            });
            
            // Remove error class from inputs
            const inputs = document.querySelectorAll('.input, .textarea, .select');
            inputs.forEach(input => {
                input.classList.remove('error');
            });
        }
    </script>
</body>
</html>

