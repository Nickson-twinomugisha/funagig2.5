<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Messages - FunaGig</title>
    <link rel="stylesheet" href="css/styles.css" />
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <header class="navbar">
        <div class="brand">
            <div class="logo"></div> FunaGig
        </div>
    </header>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="title" style="display:flex; align-items:center; gap:10px;">
                <div class="cover-img" style="width:36px;height:36px;">TS</div> Tech Solutions Inc.
            </div>
            <nav class="navlist">
                <a class="navitem" href="business-dashboard.html">Dashboard</a>
                <a class="navitem" href="business-post-gig.html">Post Gig</a>
                <a class="navitem" href="business-posted-gigs.html">My Gigs</a>
                <a class="navitem" href="business-applicants.html">Applicants</a>
                <a class="navitem active" href="business-messaging.html">Messages</a>
                <a class="navitem" href="business-profile.html">Profile</a>
                <a class="navitem" href="#" onclick="Auth.logout(); return false;">Log out</a>
            </nav>
        </aside>
        <main class="messaging-container">
            <!-- Conversations Sidebar -->
            <div class="conversations-sidebar">
                <div class="conversations-header">
                    <h2>Messages</h2>
                    <input type="text" id="searchConversations" placeholder="Search conversations..." />
                </div>
                <div id="conversationsList" class="conversations-list">
                    <!-- Conversations will be loaded here via JavaScript -->
                    <div class="no-conversations">
                        <p class="subtle">No conversations yet</p>
                        <p class="subtle" style="font-size: 12px;">Start chatting with students who applied to your gigs</p>
                    </div>
                </div>
            </div>
            
            <!-- Chat Area -->
            <div class="chat-area">
                <div id="chatHeader" class="chat-header" style="display:none;">
                    <div class="chat-user-info">
                        <div id="chatUserAvatar" class="chat-user-avatar">S</div>
                        <div class="chat-user-details">
                            <h3 id="chatUserName">Student Name</h3>
                            <p id="chatUserEmail" class="subtle">student@example.com</p>
                            <p id="chatUserUniversity" class="subtle" style="font-size: 12px;">University ‚Ä¢ Major</p>
                        </div>
                    </div>
                    <div class="chat-actions" style="display: flex; gap: 10px; align-items: center;">
                        <div class="message-search-container" style="position: relative;">
                            <input type="text" id="messageSearchInput" class="input" placeholder="Search messages..." style="width: 200px; padding: 8px 30px 8px 12px; font-size: 13px;" />
                            <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: var(--muted); pointer-events: none;">üîç</span>
                            <div id="messageSearchResults" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid var(--border); border-radius: 8px; padding: 8px; margin-top: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 100; max-width: 300px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span class="subtle" style="font-size: 12px;" id="searchResultsCount">0 results</span>
                                    <div style="display: flex; gap: 4px;">
                                        <button class="btn-icon" id="prevSearchResult" onclick="navigateSearchResult(-1)" style="padding: 4px 8px; font-size: 12px;" title="Previous">‚Üë</button>
                                        <button class="btn-icon" id="nextSearchResult" onclick="navigateSearchResult(1)" style="padding: 4px 8px; font-size: 12px;" title="Next">‚Üì</button>
                                        <button class="btn-icon" id="closeSearch" onclick="closeMessageSearch()" style="padding: 4px 8px; font-size: 12px;" title="Close">√ó</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="btn secondary" onclick="viewStudentProfile()">View Profile</button>
                        <button class="btn ghost" onclick="viewGigDetails()">View Gig</button>
                    </div>
                </div>
                
                <div id="chatMessages" class="chat-messages">
                    <div id="typingIndicator" class="typing-indicator" style="display: none;">
                        <div class="typing-dots">
                            <span></span><span></span><span></span>
                        </div>
                        <span class="typing-text"></span>
                    </div>
                    <div class="no-conversation">
                        <h3>Select a Conversation</h3>
                        <p class="subtle">Choose a conversation from the list to start messaging</p>
                    </div>
                </div>
                
                <div id="chatInputArea" class="chat-input-area" style="display:none;">
                    <div id="filePreview" class="file-preview-container" style="display:none;">
                        <div class="file-preview-item">
                            <span id="filePreviewName" class="file-preview-name"></span>
                            <button type="button" class="file-preview-remove" id="filePreviewRemove" onclick="removeSelectedFile()">√ó</button>
                        </div>
                    </div>
                    <div class="chat-input-row">
                        <input type="file" id="fileInput" accept="image/*,application/pdf,.doc,.docx,.txt" style="display:none;" />
                        <button class="btn-icon" id="attachBtn" onclick="document.getElementById('fileInput').click()" title="Attach File">üìé</button>
                        <textarea id="messageInput" placeholder="Type your message..." rows="1"></textarea>
                        <button id="sendBtn" class="btn-icon" onclick="sendMessage()" title="Send">‚û§</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/app.js"></script>
    <script src="js/messaging.js"></script>
    <script>
        // Global variables
        let currentConversationId = null;
        let currentStudentId = null;
        let messagingSystem = null;
        let messagePollInterval = null;
        let conversationPollInterval = null;
        let allMessages = []; // Store all messages for client-side search
        let searchResults = []; // Store search results
        let currentSearchIndex = -1; // Current highlighted search result

        // Load user data and initialize messaging
        document.addEventListener('DOMContentLoaded', async function() {
            // Verify session and check user type
            if (!Auth.requireUserType('business')) {
                return;
            }
            
            // Verify session is still valid
            const user = await Auth.verifySession();
            if (!user) {
                return; // verifySession already handles logout/redirect
            }
            
            if (user) {
                // Update user name in sidebar
                const userName = user.name;
                const userInitials = userName.split(' ').map(n => n[0]).join('').toUpperCase();
                
                // Update sidebar
                const sidebarTitle = document.querySelector('.sidebar .title');
                if (sidebarTitle) {
                    sidebarTitle.innerHTML = `<div class="cover-img" style="width:36px;height:36px;">${userInitials}</div> ${userName}`;
                }
                
                // Initialize messaging system
                initializeMessaging();
                
                // Load conversations
                loadConversations();
                
                // Poll conversations every 10 seconds to check for new messages
                conversationPollInterval = setInterval(() => {
                    loadConversations();
                }, 10000);
            }
        });
        
        // Typing indicator functionality
        let typingTimeout = null;
        let typingPollInterval = null;
        let isTyping = false;
        let lastTypingSent = 0;
        
        // Setup typing detection
        function setupTypingIndicator() {
            const messageInput = document.getElementById('messageInput');
            if (!messageInput) return;
            
            // Debounced function to send typing status
            const sendTypingStatus = Debounce.create((typing) => {
                if (!currentConversationId) return;
                
                const now = Date.now();
                // Throttle: only send typing status every 2 seconds
                if (typing && (now - lastTypingSent < 2000)) return;
                
                lastTypingSent = now;
                isTyping = typing;
                
                apiFetch('/typing', {
                    method: 'POST',
                    body: JSON.stringify({
                        conversation_id: currentConversationId,
                        is_typing: typing
                    }),
                    silent: true,
                    retry: false
                }).catch(err => {
                    // Silently fail - typing indicator is not critical
                    console.warn('Failed to send typing status:', err);
                });
            }, 500);
            
            // Detect typing
            messageInput.addEventListener('input', () => {
                if (!currentConversationId) return;
                
                const user = Auth.getUser();
                const userName = user ? user.name : 'User';
                
                // Use WebSocket if available, otherwise fallback to API
                if (WebSocketClient.isConnected()) {
                    WebSocketClient.sendTyping(currentConversationId, true, userName);
                    
                    // Clear existing timeout
                    if (typingTimeout) {
                        clearTimeout(typingTimeout);
                    }
                    
                    // Set timeout to send typing = false after 3 seconds of no typing
                    typingTimeout = setTimeout(() => {
                        WebSocketClient.sendTyping(currentConversationId, false, userName);
                    }, 3000);
                } else {
                    // Fallback to API
                    sendTypingStatus(true);
                    
                    // Clear existing timeout
                    if (typingTimeout) {
                        clearTimeout(typingTimeout);
                    }
                    
                    // Set timeout to send typing = false after 3 seconds of no typing
                    typingTimeout = setTimeout(() => {
                        sendTypingStatus(false);
                    }, 3000);
                }
            });
        }
        
        // Poll for other user's typing status
        function startTypingPoll() {
            if (typingPollInterval) {
                clearInterval(typingPollInterval);
            }
            
            typingPollInterval = setInterval(async () => {
                if (!currentConversationId) return;
                
                try {
                    const response = await apiFetch(`/typing?conversation_id=${currentConversationId}`, {
                        silent: true,
                        retry: false
                    });
                    
                    if (response.success) {
                        const typingIndicator = document.getElementById('typingIndicator');
                        const typingText = typingIndicator?.querySelector('.typing-text');
                        
                        if (response.is_typing && response.user_name) {
                            if (typingIndicator) typingIndicator.style.display = 'flex';
                            if (typingText) typingText.textContent = `${response.user_name} is typing...`;
                            
                            // Auto-scroll to show typing indicator
                            const chatMessages = document.getElementById('chatMessages');
                            if (chatMessages) {
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                            }
                        } else {
                            if (typingIndicator) typingIndicator.style.display = 'none';
                        }
                    }
                } catch (error) {
                    // Silently fail - typing indicator is not critical
                    console.warn('Failed to check typing status:', error);
                }
            }, 2000); // Check every 2 seconds
        }
        
        // Setup WebSocket event handlers for messaging
        function setupWebSocketHandlers(conversationId) {
            // Remove previous handlers if any
            if (currentConversationWebSocketHandlers) {
                Object.keys(currentConversationWebSocketHandlers).forEach(event => {
                    WebSocketClient.off(event, currentConversationWebSocketHandlers[event]);
                });
            }
            
            currentConversationWebSocketHandlers = {};
            
            // Handle new message received
            const messageHandler = (data) => {
                if (data.conversationId === conversationId) {
                    // Reload messages to show new message
                    loadMessages(conversationId);
                    
                    // Show notification if not in current conversation
                    if (data.conversationId !== currentConversationId) {
                        Toast.info('New message received');
                    }
                }
            };
            WebSocketClient.on('message_received', messageHandler);
            currentConversationWebSocketHandlers['message_received'] = messageHandler;
            
            // Handle typing indicator
            const typingHandler = (data) => {
                if (data.conversationId === conversationId && data.userId !== getCurrentUserId()) {
                    const typingIndicator = document.getElementById('typingIndicator');
                    const typingText = typingIndicator?.querySelector('.typing-text');
                    
                    if (data.isTyping) {
                        if (typingIndicator) typingIndicator.style.display = 'flex';
                        if (typingText) typingText.textContent = `${data.userName || 'User'} is typing...`;
                        
                        // Auto-scroll to show typing indicator
                        const chatMessages = document.getElementById('chatMessages');
                        if (chatMessages) {
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                    } else {
                        if (typingIndicator) typingIndicator.style.display = 'none';
                    }
                }
            };
            WebSocketClient.on('user_typing', typingHandler);
            currentConversationWebSocketHandlers['user_typing'] = typingHandler;
        }
        
        // Stop typing poll
        function stopTypingPoll() {
            if (typingPollInterval) {
                clearInterval(typingPollInterval);
                typingPollInterval = null;
            }
            
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) typingIndicator.style.display = 'none';
        }
        
        // Setup typing indicator on page load if conversation is already selected
        setTimeout(() => {
            if (currentConversationId) {
                setupTypingIndicator();
                startTypingPoll();
            }
        }, 1000);
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (messagePollInterval) {
                clearInterval(messagePollInterval);
            }
            if (conversationPollInterval) {
                clearInterval(conversationPollInterval);
            }
            if (typingPollInterval) {
                clearInterval(typingPollInterval);
            }
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            // Send stop typing status
            if (isTyping && currentConversationId) {
                apiFetch('/typing', {
                    method: 'POST',
                    body: JSON.stringify({
                        conversation_id: currentConversationId,
                        is_typing: false
                    }),
                    silent: true,
                    retry: false
                }).catch(() => {});
            }
        });

        // Initialize messaging functionality
        function initializeMessaging() {
            // Setup search functionality with debouncing and loading indicator
            const searchInput = document.getElementById('searchConversations');
            if (searchInput) {
                const debouncedFilter = Debounce.create(() => {
                    filterConversations(searchInput.value);
                }, 300, {
                    showLoading: false // Don't show loading for conversation search
                });
                
                searchInput.addEventListener('input', debouncedFilter);
            }

            // Setup message input auto-resize and Enter key
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });

                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });
            }
            
            // Setup file input handler
            const fileInput = document.getElementById('fileInput');
            let selectedFile = null;
            
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // Validate file size (5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        Toast.error('File size must be less than 5MB');
                        fileInput.value = '';
                        return;
                    }
                    
                    // Show file preview
                    selectedFile = file;
                    const filePreview = document.getElementById('filePreview');
                    const filePreviewName = document.getElementById('filePreviewName');
                    
                    if (filePreview && filePreviewName) {
                        filePreviewName.textContent = file.name;
                        filePreview.style.display = 'block';
                    }
                });
            }
            
            // Make selectedFile accessible globally
            window.selectedFile = null;
            window.removeSelectedFile = function() {
                selectedFile = null;
                window.selectedFile = null;
                const fileInput = document.getElementById('fileInput');
                const filePreview = document.getElementById('filePreview');
                if (fileInput) fileInput.value = '';
                if (filePreview) filePreview.style.display = 'none';
            };
        }

        // Load conversations for business
        async function loadConversations() {
            try {
                const response = await apiFetch('/conversations', {
                    silent: !!conversationPollInterval, // Don't show error notifications during polling
                    retry: false // Disable retry for polling to avoid delays
                });
                if (response.success) {
                    const conversations = response.conversations || [];
                    updateConversationsList(conversations);
                    
                    if (conversations.length === 0) {
                        showEmptyConversations();
                    }
                }
            } catch (error) {
                console.error('Failed to load conversations:', error);
                // Only show error if not polling
                if (!conversationPollInterval && !error.silent) {
                    showNotification('Failed to load conversations', 'error');
                }
            }
        }

        // Update conversations list
        function updateConversationsList(conversations) {
            const conversationsList = document.getElementById('conversationsList');
            if (!conversationsList) return;

            if (conversations.length === 0) {
                showEmptyConversations();
                return;
            }

            conversationsList.innerHTML = conversations.map(conv => {
                const otherUserName = conv.other_user_name || 'Student';
                const otherUserId = conv.other_user_id || (conv.user1_id === getCurrentUserId() ? conv.user2_id : conv.user1_id);
                const initials = otherUserName.charAt(0).toUpperCase();
                const lastMessage = conv.last_message || 'No messages yet';
                const lastMessageTime = conv.last_message_time ? 
                    formatMessageTime(conv.last_message_time) : '';
                const unreadCount = conv.unread_count || 0;

                const unreadClass = unreadCount > 0 ? 'unread' : '';
                
                return `
                    <div class="conversation-item ${unreadClass}" data-conversation-id="${conv.id}" data-student-id="${otherUserId}" data-student-name="${escapeHtml(otherUserName)}" data-student-email="${escapeHtml(conv.other_user_email || '')}" data-student-university="${escapeHtml(conv.other_user_university || '')}" data-student-major="${escapeHtml(conv.other_user_major || '')}">
                        <div class="conversation-avatar">${initials}</div>
                        <div class="conversation-content">
                            <div class="conversation-name">${escapeHtml(otherUserName)}</div>
                            <div class="conversation-preview">${escapeHtml(lastMessage.substring(0, 50))}${lastMessage.length > 50 ? '...' : ''}</div>
                        </div>
                        <div class="conversation-meta">
                            <div class="conversation-time">${lastMessageTime}</div>
                            ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount > 99 ? '99+' : unreadCount}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Add click event listeners to conversation items
            conversationsList.querySelectorAll('.conversation-item').forEach(item => {
                item.addEventListener('click', function() {
                    const conversationId = parseInt(this.dataset.conversationId);
                    const studentId = parseInt(this.dataset.studentId);
                    const studentName = this.dataset.studentName;
                    const studentEmail = this.dataset.studentEmail;
                    const studentUniversity = this.dataset.studentUniversity;
                    const studentMajor = this.dataset.studentMajor;
                    
                    selectConversation(conversationId, studentId, studentName, studentEmail, studentUniversity, studentMajor);
                });
            });
        }

        // Show empty conversations state
        function showEmptyConversations() {
            const conversationsList = document.getElementById('conversationsList');
            if (conversationsList) {
                conversationsList.innerHTML = `
                    <div class="no-conversations" style="text-align: center; padding: 40px;">
                        <p class="subtle">No conversations yet</p>
                        <p class="subtle" style="font-size: 12px; margin-top: 8px;">Start chatting with students who applied to your gigs</p>
                        <a href="business-applicants.html" class="btn mt-20">View Applicants</a>
                    </div>
                `;
            }
        }

        // Filter conversations by search term
        function filterConversations(searchTerm) {
            const conversationItems = document.querySelectorAll('.conversation-item');
            searchTerm = searchTerm.toLowerCase();

            conversationItems.forEach(item => {
                const name = item.querySelector('.conversation-name').textContent.toLowerCase();
                const preview = item.querySelector('.conversation-preview').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || preview.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Select a conversation
        async function selectConversation(conversationId, studentId, studentName, studentEmail, studentUniversity, studentMajor) {
            currentConversationId = conversationId;
            currentStudentId = studentId;

            // Clear previous message polling
            if (messagePollInterval) {
                clearInterval(messagePollInterval);
                messagePollInterval = null;
            }

            // Update active conversation UI and remove unread styling
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
                if (parseInt(item.dataset.conversationId) === conversationId) {
                    item.classList.add('active');
                    item.classList.remove('unread'); // Remove unread styling when opened
                    // Remove unread badge
                    const badge = item.querySelector('.unread-badge');
                    if (badge) badge.remove();
                }
            });

            // Update student info in chat header
            updateStudentInfo(studentName, studentEmail, studentUniversity, studentMajor);

            // Load messages for this conversation
            await loadMessages(conversationId);

            // Show chat area
            showChatArea();
            
            // Start polling for new messages every 3 seconds
            messagePollInterval = setInterval(() => {
                if (currentConversationId) {
                    loadMessages(currentConversationId);
                }
            }, 3000);
            
            // Setup typing indicator for this conversation
            setupTypingIndicator();
            startTypingPoll();
        }

        // Load messages for a conversation
        async function loadMessages(conversationId) {
            try {
                const response = await apiFetch(`/messages/${conversationId}`, {
                    silent: !!messagePollInterval, // Don't show error notifications during polling
                    retry: false // Disable retry for polling to avoid delays
                });
                if (response.success) {
                    const messages = response.messages || [];
                    updateMessagesList(messages);
                    scrollToBottom();
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
                // Error notification is handled by apiFetch if not silent
            }
        }

        // Update messages list
        function updateMessagesList(messages) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;

            // Store messages for search
            allMessages = messages;

            if (messages.length === 0) {
                chatMessages.innerHTML = `
                    <div class="no-messages">
                        <p class="subtle">No messages yet. Start the conversation!</p>
                    </div>
                `;
                return;
            }

            const currentUserId = getCurrentUserId();
            const searchTerm = document.getElementById('messageSearchInput')?.value.trim() || '';

            chatMessages.innerHTML = messages.map((msg, index) => {
                const isOwnMessage = msg.sender_id === currentUserId;
                const senderInitials = (msg.sender_name || 'U').charAt(0).toUpperCase();
                const messageTime = formatMessageTime(msg.created_at);
                const attachments = msg.attachments || [];
                
                // Highlight search term in message content
                let messageContent = msg.content || '';
                let isSearchResult = false;
                if (searchTerm && messageContent.toLowerCase().includes(searchTerm.toLowerCase())) {
                    isSearchResult = true;
                    const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
                    messageContent = messageContent.replace(regex, '<mark class="search-highlight">$1</mark>');
                } else {
                    messageContent = escapeHtml(messageContent);
                }

                // Render attachments
                let attachmentsHtml = '';
                if (attachments.length > 0) {
                    attachmentsHtml = attachments.map(att => {
                        const isImage = att.file_type && ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(att.file_type.toLowerCase());
                        const fileUrl = att.file_url || ('/' + att.file_path);
                        const fileSize = att.file_size ? formatFileSize(att.file_size) : '';
                        
                        if (isImage) {
                            return `
                                <div class="message-attachment">
                                    <a href="${fileUrl}" target="_blank" class="attachment-link">
                                        <img src="${fileUrl}" alt="${escapeHtml(att.file_name)}" class="attachment-image" />
                                    </a>
                                    <div class="attachment-info">
                                        <span class="attachment-name">${escapeHtml(att.file_name)}</span>
                                        ${fileSize ? `<span class="attachment-size">${fileSize}</span>` : ''}
                                    </div>
                                </div>
                            `;
                        } else {
                            return `
                                <div class="message-attachment">
                                    <a href="${fileUrl}" target="_blank" download="${escapeHtml(att.file_name)}" class="attachment-link">
                                        <div class="attachment-icon">üìÑ</div>
                                        <div class="attachment-info">
                                            <span class="attachment-name">${escapeHtml(att.file_name)}</span>
                                            ${fileSize ? `<span class="attachment-size">${fileSize}</span>` : ''}
                                        </div>
                                    </a>
                                </div>
                            `;
                        }
                    }).join('');
                }

                const searchClass = isSearchResult ? ' search-result' : '';
                const searchDataAttr = isSearchResult ? ` data-search-result="${index}"` : '';

                return `
                    <div class="message ${isOwnMessage ? 'own' : ''}${searchClass}" data-message-id="${msg.id}"${searchDataAttr}>
                        ${!isOwnMessage ? `<div class="message-avatar">${senderInitials}</div>` : ''}
                        <div class="message-content">
                            ${messageContent ? `<div class="message-text">${messageContent}</div>` : ''}
                            ${attachmentsHtml ? `<div class="message-attachments">${attachmentsHtml}</div>` : ''}
                            <div class="message-time">${messageTime}</div>
                        </div>
                        ${isOwnMessage ? `<div class="message-avatar">${senderInitials}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            // Highlight current search result
            if (searchTerm && currentSearchIndex >= 0 && currentSearchIndex < searchResults.length) {
                highlightSearchResult(currentSearchIndex);
            } else {
                scrollToBottom();
            }
        }
        
        // Escape regex special characters
        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // Search messages within conversation
        function searchMessages(searchTerm) {
            if (!searchTerm || !allMessages.length) {
                searchResults = [];
                currentSearchIndex = -1;
                updateSearchResultsUI();
                // Re-render messages without highlighting
                updateMessagesList(allMessages);
                return;
            }
            
            const term = searchTerm.toLowerCase();
            searchResults = allMessages
                .map((msg, index) => ({ msg, index }))
                .filter(({ msg }) => {
                    const content = (msg.content || '').toLowerCase();
                    return content.includes(term);
                });
            
            currentSearchIndex = searchResults.length > 0 ? 0 : -1;
            updateSearchResultsUI();
            
            // Re-render messages with highlighting
            updateMessagesList(allMessages);
            
            // Scroll to first result
            if (searchResults.length > 0) {
                highlightSearchResult(0);
            }
        }
        
        // Update search results UI
        function updateSearchResultsUI() {
            const resultsContainer = document.getElementById('messageSearchResults');
            const resultsCount = document.getElementById('searchResultsCount');
            
            if (!resultsContainer || !resultsCount) return;
            
            if (searchResults.length > 0) {
                resultsCount.textContent = `${currentSearchIndex + 1} of ${searchResults.length} results`;
                resultsContainer.style.display = 'block';
                
                // Enable/disable navigation buttons
                const prevBtn = document.getElementById('prevSearchResult');
                const nextBtn = document.getElementById('nextSearchResult');
                if (prevBtn) prevBtn.disabled = currentSearchIndex <= 0;
                if (nextBtn) nextBtn.disabled = currentSearchIndex >= searchResults.length - 1;
            } else {
                const searchInput = document.getElementById('messageSearchInput');
                const searchTerm = searchInput ? searchInput.value.trim() : '';
                resultsCount.textContent = 'No results';
                resultsContainer.style.display = searchTerm ? 'block' : 'none';
            }
        }
        
        // Navigate search results
        function navigateSearchResult(direction) {
            if (searchResults.length === 0) return;
            
            currentSearchIndex += direction;
            if (currentSearchIndex < 0) currentSearchIndex = searchResults.length - 1;
            if (currentSearchIndex >= searchResults.length) currentSearchIndex = 0;
            
            updateSearchResultsUI();
            highlightSearchResult(currentSearchIndex);
        }
        
        // Highlight a specific search result
        function highlightSearchResult(index) {
            if (index < 0 || index >= searchResults.length) return;
            
            // Remove previous highlights
            document.querySelectorAll('.message.search-highlighted').forEach(msg => {
                msg.classList.remove('search-highlighted');
            });
            
            // Highlight current result
            const result = searchResults[index];
            const messageElement = document.querySelector(`[data-message-id="${result.msg.id}"]`);
            if (messageElement) {
                messageElement.classList.add('search-highlighted');
                messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        // Close message search
        function closeMessageSearch() {
            const searchInput = document.getElementById('messageSearchInput');
            const resultsContainer = document.getElementById('messageSearchResults');
            
            if (searchInput) searchInput.value = '';
            if (resultsContainer) resultsContainer.style.display = 'none';
            
            searchResults = [];
            currentSearchIndex = -1;
            
            // Re-render messages without highlighting
            if (allMessages.length > 0) {
                updateMessagesList(allMessages);
            }
        }
        
        // Setup message search
        function setupMessageSearch() {
            const searchInput = document.getElementById('messageSearchInput');
            if (!searchInput) return;
            
            // Debounced search
            const debouncedSearch = Debounce.create(() => {
                const searchTerm = searchInput.value.trim();
                searchMessages(searchTerm);
            }, 300);
            
            searchInput.addEventListener('input', debouncedSearch);
            
            // Keyboard shortcuts
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (e.shiftKey) {
                        navigateSearchResult(-1); // Shift+Enter for previous
                    } else {
                        navigateSearchResult(1); // Enter for next
                    }
                } else if (e.key === 'Escape') {
                    closeMessageSearch();
                    searchInput.blur();
                }
            });
        }

        // Update student information in chat header
        function updateStudentInfo(studentName, studentEmail, studentUniversity, studentMajor) {
            const chatUserName = document.getElementById('chatUserName');
            const chatUserEmail = document.getElementById('chatUserEmail');
            const chatUserUniversity = document.getElementById('chatUserUniversity');
            const chatUserAvatar = document.getElementById('chatUserAvatar');

            if (chatUserName) chatUserName.textContent = studentName || 'Student';
            if (chatUserEmail) chatUserEmail.textContent = studentEmail || 'student@example.com';
            
            let universityText = '';
            if (studentUniversity) universityText += studentUniversity;
            if (studentMajor) {
                if (universityText) universityText += ' ‚Ä¢ ';
                universityText += studentMajor;
            }
            if (chatUserUniversity) {
                chatUserUniversity.textContent = universityText || 'University ‚Ä¢ Major';
                chatUserUniversity.style.display = universityText ? 'block' : 'none';
            }
            
            const initials = (studentName || 'S').charAt(0).toUpperCase();
            if (chatUserAvatar) chatUserAvatar.textContent = initials;
        }

        // Show chat area
        function showChatArea() {
            const chatHeader = document.getElementById('chatHeader');
            const chatInputArea = document.getElementById('chatInputArea');
            const chatMessages = document.getElementById('chatMessages');

            if (chatHeader) chatHeader.style.display = 'flex';
            if (chatInputArea) chatInputArea.style.display = 'flex';
            
            // Remove no-conversation message if it exists
            const noConversation = chatMessages.querySelector('.no-conversation');
            if (noConversation) {
                noConversation.remove();
            }
            
            // Setup message search when chat area is shown
            setupMessageSearch();
        }

        // Send message
        async function sendMessage() {
            // Stop typing status before sending message
            if (isTyping && currentConversationId) {
                try {
                    await apiFetch('/typing', {
                        method: 'POST',
                        body: JSON.stringify({
                            conversation_id: currentConversationId,
                            is_typing: false
                        }),
                        silent: true,
                        retry: false
                    });
                } catch (err) {
                    // Silently fail
                }
                isTyping = false;
            }
            if (typingTimeout) {
                clearTimeout(typingTimeout);
                typingTimeout = null;
            }
            
            const messageInput = document.getElementById('messageInput');
            if (!messageInput || !currentConversationId) return;

            const message = messageInput.value.trim();
            const file = window.selectedFile || selectedFile;
            
            // Must have either message or file
            if (!message && !file) return;

            const sendBtn = document.getElementById('sendBtn');
            const originalText = sendBtn?.textContent;
            if (sendBtn) {
                sendBtn.disabled = true;
                sendBtn.textContent = 'Sending...';
            }

            try {
                // First, send the message (even if empty, we need message_id for attachment)
                const messageText = message || (file ? `üìé ${file.name}` : '');
                
                const response = await apiFetch('/messages', {
                    method: 'POST',
                    body: JSON.stringify({
                        conversation_id: currentConversationId,
                        message: messageText
                    })
                });

                if (response.success && response.message_id) {
                    // If there's a file, upload it as attachment
                    if (file) {
                        try {
                            await FileUpload.upload(file, 'message', {
                                messageId: response.message_id
                            });
                        } catch (uploadError) {
                            console.error('File upload error:', uploadError);
                            Toast.error('Message sent but file upload failed: ' + (uploadError.message || 'Unknown error'));
                        }
                    }
                    
                    // Send WebSocket event for real-time update
                    const user = Auth.getUser();
                    if (WebSocketClient && WebSocketClient.isConnected() && user) {
                        WebSocketClient.sendMessageEvent(
                            currentConversationId,
                            response.message_id,
                            user.id,
                            messageText
                        );
                    }
                    
                    // Clear inputs
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                    removeSelectedFile();
                    
                    // Reload messages immediately (WebSocket will also trigger update)
                    await loadMessages(currentConversationId);
                    // Also reload conversations to update last message
                    await loadConversations();
                } else {
                    Toast.error('Failed to send message');
                }
            } catch (error) {
                console.error('Send message error:', error);
                Toast.error('Failed to send message: ' + (error.message || 'Unknown error'));
            } finally {
                if (sendBtn) {
                    sendBtn.disabled = false;
                    sendBtn.textContent = originalText || '‚û§';
                }
            }
        }

        // View student profile
        function viewStudentProfile() {
            if (currentStudentId) {
                // In a full implementation, navigate to student profile page
                showNotification('Student profile view coming soon', 'info');
            }
        }

        // View gig details
        function viewGigDetails() {
            // In a full implementation, navigate to gig details page
            showNotification('Gig details view coming soon', 'info');
        }

        // Get current user ID
        function getCurrentUserId() {
            const user = Auth.getUser();
            return user ? user.id : null;
        }

        // Format file size
        function formatFileSize(bytes) {
            if (!bytes) return '';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        // Format message time
        function formatMessageTime(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString();
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Scroll to bottom of messages
        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
    </script>

    <style>
        /* Messaging specific styles */
        .messaging-container {
            display: flex;
            height: calc(100vh - 60px);
            background: var(--bg);
        }

        .conversations-sidebar {
            width: 350px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .conversations-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .conversations-header h2 {
            margin: 0 0 15px 0;
            font-size: 24px;
        }

        .conversations-header input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
        }

        .conversation-item {
            display: flex;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .conversation-item:hover {
            background: var(--bg);
        }

        .conversation-item.active {
            background: var(--bg);
            border-left: 3px solid var(--primary);
        }
        
        .conversation-item.unread {
            background: rgba(18, 150, 234, 0.05);
            font-weight: 600;
        }
        
        .conversation-item.unread .conversation-name {
            font-weight: 600;
            color: var(--text);
        }
        
        .unread-badge {
            background: var(--primary);
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
            margin-top: 4px;
        }

        .conversation-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .conversation-content {
            flex: 1;
            min-width: 0;
        }

        .conversation-name {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .conversation-preview {
            font-size: 13px;
            color: var(--muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .conversation-time {
            font-size: 12px;
            color: var(--muted);
        }

        .unread-badge {
            background: var(--primary);
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--panel);
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--panel);
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--success);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .chat-user-details h3 {
            margin: 0;
            font-size: 16px;
        }

        .chat-actions {
            display: flex;
            gap: 10px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .no-conversation,
        .no-messages {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }

        .no-conversation h3,
        .no-messages h3 {
            margin-bottom: 10px;
        }

        .message {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .message.own {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message.own .message-avatar {
            background: var(--success);
        }

        .message-content {
            max-width: 60%;
            background: var(--bg);
            padding: 10px 15px;
            border-radius: 12px;
        }

        .message.own .message-content {
            background: var(--primary);
            color: white;
        }

        .message-text {
            margin-bottom: 5px;
            word-wrap: break-word;
        }

        .message-time {
            font-size: 11px;
            color: var(--muted);
        }

        .message.own .message-time {
            color: rgba(255, 255, 255, 0.7);
        }

        .chat-input-area {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: flex-end;
            gap: 10px;
            background: var(--panel);
        }

        .chat-input-area textarea {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 20px;
            resize: none;
            max-height: 120px;
            font-family: inherit;
            font-size: 14px;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--bg);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: background 0.2s;
        }

        .btn-icon:hover {
            background: var(--border);
        }

        .no-conversations {
            padding: 40px 20px;
            text-align: center;
        }
    </style>
</body>
</html>

