<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Profile - FunaGig</title>
    <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
    <header class="navbar">
        <div class="brand">
            <div class="logo"></div> FunaGig
        </div>
    </header>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="title" style="display:flex; align-items:center; gap:10px;">
                <div class="cover-img" style="width:36px;height:36px;">AP</div> Amanya Peter
            </div>
            <nav class="navlist">
                <a class="navitem" href="student-dashboard.html">Dashboard</a>
                <a class="navitem" href="student-gigs.html">Gigs</a>
                <a class="navitem" href="student-messaging.html">Messages</a>
                <a class="navitem active" href="student-profile.html">Profile</a>
                <a class="navitem" href="index.html">Log out</a>
            </nav>
        </aside>
        <main class="content">
            <h1 class="h1">Profile</h1>
            <form id="profile-form">
                <div class="section">
                    <h2>Personal Info</h2>
                    <div class="flex items-center gap-10">
                        <div class="cover-img" id="profile-avatar" style="position: relative; overflow: hidden;">
                            <img id="profile-image" src="" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%; display: none; position: absolute; top: 0; left: 0; z-index: 2; background: #fff;" />
                        </div>
                        <div>
                            <button type="button" class="btn secondary" id="change-photo-btn">Change Photo</button>
                            <input type="file" id="profile-photo-input" accept="image/*" style="display: none;" />
                            <div id="upload-progress" style="display: none; margin-top: 8px;">
                                <div style="background: #eee; height: 4px; border-radius: 2px; overflow: hidden;">
                                    <div id="progress-bar" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
                                </div>
                                <div class="subtle" style="font-size: 12px; margin-top: 4px;">Uploading...</div>
                            </div>
                        </div>
                    </div>
                    <input class="input mt-10" name="name" value="Amanya Peter" placeholder="Full Name" />
                    <input class="input mt-10" name="email" value="john@example.com" placeholder="Email" />
                    <input class="input mt-10" name="phone" value="+256 123 456 789" placeholder="Phone" />
                </div>
                <div class="section mt-20">
                    <h2>Academic Info</h2>
                    <input class="input" name="university" value="Makerere University" placeholder="University" />
                    <input class="input mt-10" name="major" value="Computer Science" placeholder="Major" />
                    <select class="select mt-10" name="year"><option>Year 2</option></select>
                </div>
                <div class="section mt-20">
                    <h2>Skills</h2>
                    <div class="flex flex-wrap gap-8">
                        <span class="pill blue">Web Dev</span> <!-- Add/remove via JS -->
                    </div>
                    <input class="input mt-10" placeholder="Add Skill" />
                </div>
                <div class="section mt-20">
                    <h2>Availability & Payment</h2>
                    <select class="select" name="availability"><option>Part-Time</option></select>
                    <input class="input mt-10" name="payment" value="Bank ****1234" placeholder="Payment Info" />
                </div>
                <button type="submit" class="btn mt-20">Save Changes</button>
            </form>

            <div id="applications" class="section mt-40">
                <h2>Applications History</h2>
                <div class="filters flex gap-10">
                    <select><option>Status: All</option></select>
                    <select><option>Sort: Newest</option></select>
                    <input placeholder="Search" />
                </div>
                <table class="table mt-10">
                    <thead><tr><th>Gig</th><th>Status</th><th>Date</th></tr></thead>
                    <tbody>
                        <tr><td>Web Dev</td><td><span class="pill yellow">Pending</span></td><td>2024-09-15</td></tr>
                        <!-- More rows -->
                    </tbody>
                </table>
                <div class="text-right subtle mt-10">1 2 3 â€¦ 10 Â»</div>
            </div>

            <div class="section mt-20">
                <h2>Completed Gigs</h2>
                <table class="table">
                    <thead><tr><th>Gig</th><th>Client</th><th>Earnings</th><th>Date</th></tr></thead>
                    <tbody>
                        <tr><td>Poster Design</td><td>Events Committee</td><td>sh.200,000</td><td>2025-06-12</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Reviews Section -->
            <div id="reviews-section" class="section mt-40">
                <div class="flex items-center justify-between mb-20">
                    <h2>Reviews & Ratings</h2>
                    <div id="rating-summary" class="text-right">
                        <div style="font-size: 24px; font-weight: 600;" id="avg-rating">-</div>
                        <div class="subtle" id="total-reviews">0 reviews</div>
                    </div>
                </div>
                
                <!-- Rating Breakdown -->
                <div id="rating-breakdown" class="mb-20" style="display: none;">
                    <div class="flex items-center gap-10 mb-8">
                        <span>5â˜…</span>
                        <div class="flex-1" style="background: #eee; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div id="five-star-bar" style="background: #28a745; height: 100%; width: 0%;"></div>
                        </div>
                        <span id="five-star-count" class="subtle">0</span>
                    </div>
                    <div class="flex items-center gap-10 mb-8">
                        <span>4â˜…</span>
                        <div class="flex-1" style="background: #eee; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div id="four-star-bar" style="background: #28a745; height: 100%; width: 0%;"></div>
                        </div>
                        <span id="four-star-count" class="subtle">0</span>
                    </div>
                    <div class="flex items-center gap-10 mb-8">
                        <span>3â˜…</span>
                        <div class="flex-1" style="background: #eee; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div id="three-star-bar" style="background: #ffc107; height: 100%; width: 0%;"></div>
                        </div>
                        <span id="three-star-count" class="subtle">0</span>
                    </div>
                    <div class="flex items-center gap-10 mb-8">
                        <span>2â˜…</span>
                        <div class="flex-1" style="background: #eee; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div id="two-star-bar" style="background: #ff9800; height: 100%; width: 0%;"></div>
                        </div>
                        <span id="two-star-count" class="subtle">0</span>
                    </div>
                    <div class="flex items-center gap-10 mb-8">
                        <span>1â˜…</span>
                        <div class="flex-1" style="background: #eee; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div id="one-star-bar" style="background: #dc3545; height: 100%; width: 0%;"></div>
                        </div>
                        <span id="one-star-count" class="subtle">0</span>
                    </div>
                </div>
                
                <!-- Reviews List -->
                <div id="reviews-list">
                    <div class="empty-state">
                        <p>No reviews yet.</p>
                    </div>
                </div>
            </div>

            <!-- Portfolio Section -->
            <div id="portfolio-section" class="section mt-40">
                <div class="flex items-center justify-between mb-20">
                    <h2>Portfolio</h2>
                    <button type="button" class="btn secondary" id="add-portfolio-btn">+ Add Item</button>
                </div>
                
                <div id="portfolio-gallery" class="portfolio-gallery">
                    <!-- Portfolio items will be loaded here -->
                    <div class="empty-state">
                        <p>No portfolio items yet. Add your projects and work samples.</p>
                    </div>
                </div>
            </div>

            <!-- Portfolio Upload Modal -->
            <div id="portfolio-upload-modal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Add Portfolio Item</h3>
                        <button type="button" class="modal-close" onclick="closePortfolioModal()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <form id="portfolio-upload-form">
                            <div class="field">
                                <label class="label">File</label>
                                <input type="file" id="portfolio-file-input" accept="image/*,application/pdf,.doc,.docx" class="input" required />
                                <div class="subtle" style="font-size: 12px; margin-top: 4px;">Supported: Images, PDF, DOC, DOCX (Max 5MB)</div>
                            </div>
                            <div class="field">
                                <label class="label">Category</label>
                                <select id="portfolio-category" class="select">
                                    <option value="portfolio">Portfolio</option>
                                    <option value="certificate">Certificate</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="field">
                                <label class="label">Description</label>
                                <textarea id="portfolio-description" class="textarea" rows="3" placeholder="Describe this project or file..."></textarea>
                            </div>
                            <div id="portfolio-upload-progress" style="display: none; margin-bottom: 16px;">
                                <div class="progress-bar">
                                    <div id="portfolio-progress-fill" class="progress-fill" style="width: 0%;"></div>
                                </div>
                                <div class="subtle" style="font-size: 12px; margin-top: 4px;">Uploading...</div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn secondary" onclick="closePortfolioModal()">Cancel</button>
                        <button type="button" class="btn" id="portfolio-upload-submit" onclick="uploadPortfolioItem()">Upload</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script src="js/app.js"></script>
    <script>
        // Load user data and update profile
        document.addEventListener('DOMContentLoaded', async function() {
            // Verify session and check user type
            if (!Auth.requireUserType('student')) {
                return;
            }
            
            // Verify session is still valid
            const user = await Auth.verifySession();
            if (!user) {
                return; // verifySession already handles logout/redirect
            }
            
            if (user) {
                // Update user name in sidebar
                const userName = user.name;
                const userInitials = userName.split(' ').map(n => n[0]).join('').toUpperCase();
                
                // Update sidebar
                const sidebarTitle = document.querySelector('.sidebar .title');
                if (sidebarTitle) {
                    sidebarTitle.innerHTML = `<div class="cover-img" style="width:36px;height:36px;">${userInitials}</div> ${userName}`;
                }
                
                // Load profile data from API
                loadProfileData();
                
                // Load applications and completed gigs
                loadApplications();
                loadCompletedGigs();
                loadReviews();
                loadPortfolio();
                
                // Setup profile photo upload
                setupProfilePhotoUpload();
            }
        });
        
        function updateProfileForm(user) {
            // Update form fields with user data
            const nameField = document.querySelector('input[name="name"]');
            const emailField = document.querySelector('input[name="email"]');
            const phoneField = document.querySelector('input[name="phone"]');
            const universityField = document.querySelector('input[name="university"]');
            const majorField = document.querySelector('input[name="major"]');
            
            if (nameField) nameField.value = user.name || '';
            if (emailField) emailField.value = user.email || '';
            if (phoneField) phoneField.value = user.phone || '';
            if (universityField) universityField.value = user.university || '';
            if (majorField) majorField.value = user.major || '';
            
            // Update skills if available
            if (user.skills) {
                const skillsContainer = document.querySelector('.flex.flex-wrap.gap-8');
                if (skillsContainer) {
                    const skills = user.skills.split(',').map(s => s.trim());
                    skillsContainer.innerHTML = skills.map(skill => 
                        `<span class="pill blue">${escapeHtml(skill)}</span>`
                    ).join('');
                }
            }
            
            // Update avatar initials and image
            const avatar = document.getElementById('profile-avatar');
            const profileImage = document.getElementById('profile-image');
            if (avatar) {
                if (user.profile_image) {
                    // Show profile image if available
                    if (profileImage) {
                        // Construct image URL - handle both absolute and relative paths
                        let imageUrl = user.profile_image;
                        
                        // Normalize the URL to include /funagig/ prefix
                        if (imageUrl.startsWith('http://localhost/funagig/')) {
                            imageUrl = imageUrl.replace('http://localhost/funagig', '');
                        } else if (!imageUrl.startsWith('/funagig/') && !imageUrl.startsWith('http')) {
                            // Add /funagig/ prefix if not present
                            if (imageUrl.startsWith('/')) {
                                imageUrl = '/funagig' + imageUrl;
                            } else {
                                imageUrl = '/funagig/' + imageUrl;
                            }
                        }
                        
                        // Clear text immediately
                        avatar.textContent = '';
                        avatar.style.color = 'transparent';
                        avatar.style.fontSize = '0';
                        
                        // Set up image styles before loading
                        profileImage.style.position = 'absolute';
                        profileImage.style.top = '0';
                        profileImage.style.left = '0';
                        profileImage.style.width = '100%';
                        profileImage.style.height = '100%';
                        profileImage.style.zIndex = '999';
                        profileImage.style.objectFit = 'cover';
                        profileImage.style.borderRadius = '50%';
                        
                        // Add cache busting timestamp
                        const timestamp = new Date().getTime();
                        
                        // Set up load handler BEFORE setting src
                        profileImage.onload = function() {
                            console.log('Profile image loaded successfully (initial load):', imageUrl);
                            
                            // Remove all text nodes
                            Array.from(avatar.childNodes).forEach(child => {
                                if (child.nodeType === Node.TEXT_NODE) {
                                    child.remove();
                                }
                            });
                            avatar.textContent = '';
                            
                            // Set image styles with !important to ensure visibility
                            profileImage.setAttribute('style', 
                                'display: block !important; ' +
                                'visibility: visible !important; ' +
                                'opacity: 1 !important; ' +
                                'z-index: 999 !important; ' +
                                'position: absolute !important; ' +
                                'top: 0 !important; ' +
                                'left: 0 !important; ' +
                                'width: 100% !important; ' +
                                'height: 100% !important; ' +
                                'object-fit: cover !important; ' +
                                'border-radius: 50% !important;'
                            );
                            
                            avatar.style.background = 'transparent';
                            avatar.style.color = 'transparent';
                            avatar.style.fontSize = '0';
                            
                            // Force repaint
                            void avatar.offsetHeight;
                            void profileImage.offsetHeight;
                        };
                        
                        // Handle image load errors
                        profileImage.onerror = function() {
                            console.error('Failed to load profile image:', imageUrl);
                            // Try alternative paths
                            const altUrl = imageUrl.includes('/funagig/') 
                                ? imageUrl.replace('/funagig/', '/')
                                : '/funagig/' + imageUrl.replace(/^\//, '');
                            
                            console.log('Trying alternative URL:', altUrl);
                            profileImage.src = altUrl + '?t=' + timestamp;
                            
                            // If still fails, fallback to initials
                            profileImage.onerror = function() {
                                console.error('All image URLs failed');
                                profileImage.style.display = 'none';
                                avatar.textContent = user.name ? user.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'U';
                                avatar.style.fontSize = '';
                                avatar.style.color = '';
                                avatar.style.background = '#e2e8f0';
                            };
                        };
                        
                        // Now set the image source
                        profileImage.src = imageUrl + '?t=' + timestamp;
                        profileImage.style.display = 'block';
                        profileImage.style.visibility = 'visible';
                        profileImage.style.opacity = '1';
                    }
                } else {
                    // Show initials
                avatar.textContent = user.name ? user.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'U';
                    if (profileImage) {
                        profileImage.style.display = 'none';
                    }
                }
            }
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function loadApplications() {
            try {
                const response = await apiFetch('/applications');
                if (response.success) {
                    updateApplicationsTable(response.applications || []);
                }
            } catch (error) {
                console.error('Failed to load applications:', error);
                // Don't show error notification for empty results, just log it
                if (!error.message || !error.message.includes('404')) {
                    // Only show error for actual failures, not empty results
                    console.log('Applications may be empty or endpoint not available');
                }
            }
        }
        
        function updateApplicationsTable(applications) {
            const tbody = document.querySelector('#applications tbody');
            if (tbody) {
                if (applications && applications.length > 0) {
                tbody.innerHTML = applications.map(app => `
                    <tr>
                        <td>${app.gig_title || 'N/A'}</td>
                        <td><span class="pill ${getStatusClass(app.status)}">${app.status}</span></td>
                            <td>${app.applied_at ? new Date(app.applied_at).toLocaleDateString() : 'N/A'}</td>
                    </tr>
                `).join('');
                } else {
                    // Keep default sample data if no applications
                    tbody.innerHTML = '<tr><td>Web Dev</td><td><span class="pill yellow">Pending</span></td><td>2024-09-15</td></tr>';
                }
            }
        }
        
        async function loadCompletedGigs() {
            try {
                const response = await apiFetch('/applications?status=completed');
                if (response.success) {
                    updateCompletedGigsTable(response.applications || []);
                }
            } catch (error) {
                console.error('Failed to load completed gigs:', error);
                // Don't show error for empty results
            }
        }
        
        function updateCompletedGigsTable(completedGigs) {
            const tbody = document.querySelector('.section:last-child tbody');
            if (tbody) {
                if (completedGigs && completedGigs.length > 0) {
                tbody.innerHTML = completedGigs.map(gig => `
                    <tr>
                        <td>${gig.gig_title || 'N/A'}</td>
                        <td>${gig.business_name || 'N/A'}</td>
                            <td>sh.${parseInt(gig.budget || 0).toLocaleString()}</td>
                            <td>${gig.completed_at ? new Date(gig.completed_at).toLocaleDateString() : 'N/A'}</td>
                    </tr>
                `).join('');
                } else {
                    // Keep default sample data if no completed gigs
                    tbody.innerHTML = '<tr><td>Poster Design</td><td>Events Committee</td><td>sh.200,000</td><td>2025-06-12</td></tr>';
                }
            }
        }
        
        async function loadReviews() {
            try {
                const user = await Auth.verifySession();
                if (!user) return;
                
                const response = await apiFetch(`/reviews/${user.id}`);
                if (response.success) {
                    displayReviews(response.reviews || [], response.rating_stats || {});
                }
            } catch (error) {
                console.error('Failed to load reviews:', error);
                const reviewsSection = document.getElementById('reviews-section');
                if (reviewsSection) reviewsSection.style.display = 'none';
            }
        }
        
        function displayReviews(reviews, ratingStats) {
            const reviewsSection = document.getElementById('reviews-section');
            if (!reviewsSection) return;
            
            const avgRatingEl = document.getElementById('avg-rating');
            const totalReviewsEl = document.getElementById('total-reviews');
            
            if (ratingStats.total_reviews > 0) {
                avgRatingEl.textContent = `${ratingStats.average_rating.toFixed(1)}/5`;
                totalReviewsEl.textContent = `${ratingStats.total_reviews} review${ratingStats.total_reviews !== 1 ? 's' : ''}`;
                
                const breakdown = document.getElementById('rating-breakdown');
                if (breakdown && ratingStats.total_reviews > 0) {
                    breakdown.style.display = 'block';
                    const total = ratingStats.total_reviews;
                    
                    document.getElementById('five-star-bar').style.width = `${(ratingStats.five_star / total) * 100}%`;
                    document.getElementById('four-star-bar').style.width = `${(ratingStats.four_star / total) * 100}%`;
                    document.getElementById('three-star-bar').style.width = `${(ratingStats.three_star / total) * 100}%`;
                    document.getElementById('two-star-bar').style.width = `${(ratingStats.two_star / total) * 100}%`;
                    document.getElementById('one-star-bar').style.width = `${(ratingStats.one_star / total) * 100}%`;
                    
                    document.getElementById('five-star-count').textContent = ratingStats.five_star;
                    document.getElementById('four-star-count').textContent = ratingStats.four_star;
                    document.getElementById('three-star-count').textContent = ratingStats.three_star;
                    document.getElementById('two-star-count').textContent = ratingStats.two_star;
                    document.getElementById('one-star-count').textContent = ratingStats.one_star;
                }
            } else {
                avgRatingEl.textContent = 'No ratings';
                totalReviewsEl.textContent = '0 reviews';
            }
            
            const reviewsList = document.getElementById('reviews-list');
            if (!reviewsList) return;
            
            if (reviews.length === 0) {
                reviewsList.innerHTML = '<div class="empty-state"><p>No reviews yet.</p></div>';
                return;
            }
            
            reviewsList.innerHTML = reviews.map(review => {
                const stars = 'â˜…'.repeat(review.rating) + 'â˜†'.repeat(5 - review.rating);
                const date = new Date(review.created_at).toLocaleDateString();
                const reviewerInitials = review.reviewer_name.split(' ').map(n => n[0]).join('').toUpperCase();
                
                return `
                    <div class="card mb-10" style="padding: 16px;">
                        <div class="flex items-start gap-12">
                            <div class="cover-img" style="width: 48px; height: 48px; font-size: 18px;">${reviewerInitials}</div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-8">
                                    <div>
                                        <div style="font-weight: 600;">${escapeHtml(review.reviewer_name)}</div>
                                        <div class="subtle" style="font-size: 14px;">${date}</div>
                                    </div>
                                    <div style="color: #ffc107; font-size: 20px;">${stars}</div>
                                </div>
                                ${review.gig_title ? `<div class="subtle mb-8">For: ${escapeHtml(review.gig_title)}</div>` : ''}
                                ${review.comment ? `<p style="margin: 0; line-height: 1.6;">${escapeHtml(review.comment)}</p>` : '<p class="subtle">No comment provided.</p>'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getStatusClass(status) {
            switch(status) {
                case 'accepted': return 'green';
                case 'pending': return 'yellow';
                case 'rejected': return 'red';
                case 'completed': return 'blue';
                default: return 'gray';
            }
        }
        
        // Profile photo upload functionality
        function setupProfilePhotoUpload() {
            const changePhotoBtn = document.getElementById('change-photo-btn');
            const photoInput = document.getElementById('profile-photo-input');
            const uploadProgress = document.getElementById('upload-progress');
            const progressBar = document.getElementById('progress-bar');
            const profileAvatar = document.getElementById('profile-avatar');
            const profileImage = document.getElementById('profile-image');
            
            if (!changePhotoBtn || !photoInput) return;
            
            // Trigger file input when button is clicked
            changePhotoBtn.addEventListener('click', () => {
                photoInput.click();
            });
            
            // Handle file selection
            photoInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    Toast.error('Please select an image file');
                    return;
                }
                
                // Validate file size (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    Toast.error('File size must be less than 5MB');
                    return;
                }
                
                try {
                    // Show preview
                    const previewUrl = await FileUpload.previewImage(file);
                    if (profileImage) {
                        profileImage.src = previewUrl;
                        profileImage.style.display = 'block';
                        profileAvatar.textContent = '';
                    }
                    
                    // Show upload progress
                    uploadProgress.style.display = 'block';
                    progressBar.style.width = '0%';
                    changePhotoBtn.disabled = true;
                    Loading.setButtonLoading(changePhotoBtn, true);
                    
                    // Upload file
                    const response = await FileUpload.upload(file, 'profile', {
                        onProgress: (loaded, total) => {
                            const percent = Math.round((loaded / total) * 100);
                            progressBar.style.width = percent + '%';
                        }
                    });
                    
                    // Update profile image with the correct path
                    if (response.file_path && profileImage) {
                        // Construct the correct URL - handle the /funagig/ base path
                        let imageUrl = response.file_path;
                        if (!imageUrl.startsWith('http') && !imageUrl.startsWith('/funagig/')) {
                            // Add /funagig/ prefix if not already present
                            if (imageUrl.startsWith('/')) {
                                imageUrl = '/funagig' + imageUrl;
                            } else {
                                imageUrl = '/funagig/' + imageUrl;
                            }
                        }
                        
                        // Set image source with cache busting
                        const timestamp = new Date().getTime();
                        
                        // Clear avatar text first
                        profileAvatar.textContent = '';
                        profileAvatar.style.background = 'transparent';
                        
                        // Set up load handlers before setting src
                        profileImage.onload = function() {
                            console.log('Profile image loaded successfully:', imageUrl);
                            
                            // Remove all text nodes from avatar
                            const textNodes = [];
                            const walker = document.createTreeWalker(
                                profileAvatar,
                                NodeFilter.SHOW_TEXT,
                                null,
                                false
                            );
                            let node;
                            while (node = walker.nextNode()) {
                                if (node.textContent.trim()) {
                                    textNodes.push(node);
                                }
                            }
                            textNodes.forEach(textNode => textNode.remove());
                            
                            // Clear all child text nodes
                            Array.from(profileAvatar.childNodes).forEach(child => {
                                if (child.nodeType === Node.TEXT_NODE) {
                                    child.remove();
                                }
                            });
                            
                            // Clear textContent completely - this is critical
                            profileAvatar.textContent = '';
                            profileAvatar.innerHTML = profileAvatar.innerHTML.replace(/[^<]*/, ''); // Remove any remaining text
                            
                            // Ensure image is visible and on top with all necessary styles using !important
                            profileImage.setAttribute('style', 
                                'display: block !important; ' +
                                'visibility: visible !important; ' +
                                'opacity: 1 !important; ' +
                                'z-index: 999 !important; ' +
                                'position: absolute !important; ' +
                                'top: 0 !important; ' +
                                'left: 0 !important; ' +
                                'width: 100% !important; ' +
                                'height: 100% !important; ' +
                                'object-fit: cover !important; ' +
                                'border-radius: 50% !important; ' +
                                'background: #fff !important;'
                            );
                            
                            // Clear avatar background and ensure no text shows
                            profileAvatar.style.background = 'transparent';
                            profileAvatar.style.color = 'transparent';
                            profileAvatar.style.fontSize = '0'; // Hide any remaining text
                            
                            // Force browser repaint
                            void profileAvatar.offsetHeight;
                            void profileImage.offsetHeight;
                            
                            // Verify image is actually visible
                            const computedStyle = window.getComputedStyle(profileImage);
                            console.log('=== IMAGE VISIBILITY CHECK ===');
                            console.log('Computed display:', computedStyle.display);
                            console.log('Computed visibility:', computedStyle.visibility);
                            console.log('Computed opacity:', computedStyle.opacity);
                            console.log('Computed z-index:', computedStyle.zIndex);
                            console.log('Computed position:', computedStyle.position);
                            console.log('Image complete:', profileImage.complete);
                            console.log('Image natural dimensions:', profileImage.naturalWidth, 'x', profileImage.naturalHeight);
                            console.log('Avatar textContent length:', profileAvatar.textContent.length);
                            console.log('Avatar innerHTML:', profileAvatar.innerHTML.substring(0, 100));
                        };
                        
                        profileImage.onerror = function(e) {
                            console.error('Failed to load profile image:', imageUrl);
                            console.error('Trying alternative URLs...');
                            
                            // Try alternative URL formats
                            const alternatives = [
                                '/funagig/' + response.file_path,
                                '/' + response.file_path,
                                response.file_url,
                                'http://localhost/funagig/' + response.file_path
                            ];
                            
                            let altIndex = 0;
                            const tryNext = () => {
                                if (altIndex < alternatives.length && alternatives[altIndex]) {
                                    const altUrl = alternatives[altIndex] + '?t=' + timestamp;
                                    console.log('Trying alternative URL:', altUrl);
                                    profileImage.src = altUrl;
                                    altIndex++;
                                } else {
                                    // Fallback to initials if all URLs fail
                                    console.error('All image URLs failed, falling back to initials');
                                    profileImage.style.display = 'none';
                                    const user = Auth.getUser();
                                    if (user && profileAvatar) {
                                        profileAvatar.textContent = user.name ? user.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'U';
                                        profileAvatar.style.background = '#e2e8f0';
                                    }
                                }
                            };
                            
                            // Set new error handler that tries next alternative
                            profileImage.onerror = tryNext;
                            tryNext();
                        };
                        
                        // Clear text immediately before setting image
                        profileAvatar.textContent = '';
                        profileAvatar.style.color = 'transparent';
                        
                        // Ensure image element is properly configured
                        profileImage.style.position = 'absolute';
                        profileImage.style.top = '0';
                        profileImage.style.left = '0';
                        profileImage.style.width = '100%';
                        profileImage.style.height = '100%';
                        profileImage.style.zIndex = '10';
                        
                        // Now set the image source
                        profileImage.src = imageUrl + '?t=' + timestamp;
                        profileImage.style.display = 'block';
                        profileImage.style.visibility = 'visible';
                        profileImage.style.opacity = '1';
                    }
                    
                    // Update user data in localStorage
                    const user = Auth.getUser();
                    if (user) {
                        user.profile_image = response.file_path;
                        Auth.setUser(user);
                    }
                    
                    // Reload profile data to ensure consistency
                    await loadProfileData();
                    
                    Toast.success('Profile picture updated successfully');
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    Toast.error(error.message || 'Failed to upload profile picture');
                    
                    // Revert to initials if upload fails
                    const user = Auth.getUser();
                    if (user && profileAvatar) {
                        profileAvatar.textContent = user.name ? user.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'U';
                        if (profileImage) {
                            profileImage.style.display = 'none';
                        }
                    }
                } finally {
                    uploadProgress.style.display = 'none';
                    progressBar.style.width = '0%';
                    changePhotoBtn.disabled = false;
                    Loading.setButtonLoading(changePhotoBtn, false);
                    photoInput.value = '';
                }
            });
        }
        
        // Load profile data from API
        async function loadProfileData() {
            try {
                const response = await apiFetch('/profile');
                if (response.success && response.user) {
                    updateProfileForm(response.user);
                } else {
                    // Fallback to stored user data
                    const user = Auth.getUser();
                    updateProfileForm(user);
                }
            } catch (error) {
                console.error('Failed to load profile:', error);
                // Use stored user data as fallback
                const user = Auth.getUser();
                updateProfileForm(user);
            }
        }
        
        // Handle profile form submission
        document.getElementById('profile-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
            
            const formData = {
                    name: document.querySelector('input[name="name"]').value.trim(),
                    email: document.querySelector('input[name="email"]').value.trim(),
                    phone: document.querySelector('input[name="phone"]').value.trim(),
                    university: document.querySelector('input[name="university"]').value.trim(),
                    major: document.querySelector('input[name="major"]').value.trim()
                };
                
                // Validate
                if (!formData.name) {
                    showNotification('Name is required', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
                
                if (!formData.university) {
                    showNotification('University is required', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
                
                if (!formData.major) {
                    showNotification('Major is required', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
                
                const response = await apiFetch('/profile', {
                method: 'POST',
                body: JSON.stringify(formData)
                });
                
                if (response.success) {
                    showNotification('Profile updated successfully!', 'success');
                    
                    // Update stored user data
                    const user = Auth.getUser();
                    Object.assign(user, formData);
                    Auth.setUser(user);
                    
                    // Update sidebar
                    const sidebarTitle = document.querySelector('.sidebar .title');
                    if (sidebarTitle) {
                        const initials = formData.name.split(' ').map(n => n[0]).join('').toUpperCase();
                        sidebarTitle.innerHTML = `<div class="cover-img" style="width:36px;height:36px;">${initials}</div> ${formData.name}`;
                    }
                    
                    // Update avatar
                    const avatar = document.querySelector('.cover-img');
                    if (avatar) {
                        avatar.textContent = formData.name.split(' ').map(n => n[0]).join('').toUpperCase();
                    }
                } else {
                    showNotification(response.error || 'Failed to update profile', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            } catch (error) {
                console.error('Profile update error:', error);
                showNotification('Failed to update profile. Please try again.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Portfolio Functions
        async function loadPortfolio() {
            try {
                const response = await apiFetch('/portfolio');
                if (response.success) {
                    displayPortfolio(response.files || []);
                }
            } catch (error) {
                console.error('Failed to load portfolio:', error);
                Toast.error('Failed to load portfolio items');
            }
        }

        function displayPortfolio(files) {
            const gallery = document.getElementById('portfolio-gallery');
            if (!gallery) return;

            if (files.length === 0) {
                gallery.innerHTML = `
                    <div class="empty-state">
                        <p>No portfolio items yet. Add your projects and work samples.</p>
                    </div>
                `;
                return;
            }

            gallery.innerHTML = files.map(file => {
                const isImage = file.file_type && ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(file.file_type.toLowerCase());
                const fileUrl = file.file_url || ('/' + file.file_path);
                const fileSize = file.file_size ? formatFileSize(file.file_size) : '';
                
                return `
                    <div class="portfolio-item" data-file-id="${file.id}">
                        <div class="portfolio-item-content">
                            ${isImage ? `
                                <a href="${fileUrl}" target="_blank" class="portfolio-item-image">
                                    <img src="${fileUrl}" alt="${escapeHtml(file.file_name)}" />
                                </a>
                            ` : `
                                <a href="${fileUrl}" target="_blank" download="${escapeHtml(file.file_name)}" class="portfolio-item-file">
                                    <div class="portfolio-item-icon">ðŸ“„</div>
                                    <div class="portfolio-item-name">${escapeHtml(file.file_name)}</div>
                                </a>
                            `}
                            <div class="portfolio-item-info">
                                <div class="portfolio-item-title">${escapeHtml(file.file_name)}</div>
                                ${file.description ? `<div class="portfolio-item-description">${escapeHtml(file.description)}</div>` : ''}
                                <div class="portfolio-item-meta">
                                    <span class="portfolio-item-category">${escapeHtml(file.file_category || 'portfolio')}</span>
                                    ${fileSize ? `<span class="portfolio-item-size">${fileSize}</span>` : ''}
                                </div>
                            </div>
                            <button type="button" class="portfolio-item-delete" onclick="deletePortfolioItem(${file.id})" title="Delete">Ã—</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatFileSize(bytes) {
            if (!bytes) return '';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Portfolio Modal Functions
        document.getElementById('add-portfolio-btn').addEventListener('click', function() {
            document.getElementById('portfolio-upload-modal').style.display = 'flex';
        });

        function closePortfolioModal() {
            document.getElementById('portfolio-upload-modal').style.display = 'none';
            document.getElementById('portfolio-upload-form').reset();
            document.getElementById('portfolio-upload-progress').style.display = 'none';
            document.getElementById('portfolio-progress-fill').style.width = '0%';
        }

        // Close modal on backdrop click
        document.getElementById('portfolio-upload-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePortfolioModal();
            }
        });

        async function uploadPortfolioItem() {
            const fileInput = document.getElementById('portfolio-file-input');
            const category = document.getElementById('portfolio-category').value;
            const description = document.getElementById('portfolio-description').value.trim();
            const submitBtn = document.getElementById('portfolio-upload-submit');
            const progressContainer = document.getElementById('portfolio-upload-progress');
            const progressFill = document.getElementById('portfolio-progress-fill');

            if (!fileInput.files || !fileInput.files[0]) {
                Toast.error('Please select a file');
                return;
            }

            const file = fileInput.files[0];

            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                Toast.error('File size must be less than 5MB');
                return;
            }

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Uploading...';
                progressContainer.style.display = 'block';

                // Upload file
                const result = await FileUpload.upload(file, 'portfolio', {
                    category: category,
                    description: description,
                    onProgress: (loaded, total) => {
                        const progress = Math.round((loaded / total) * 100);
                        progressFill.style.width = progress + '%';
                    }
                });

                if (result.success) {
                    Toast.success('Portfolio item added successfully');
                    closePortfolioModal();
                    await loadPortfolio(); // Reload portfolio
                } else {
                    Toast.error(result.error || 'Failed to upload portfolio item');
                }
            } catch (error) {
                console.error('Upload error:', error);
                Toast.error(error.message || 'Failed to upload portfolio item');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Upload';
                progressContainer.style.display = 'none';
                progressFill.style.width = '0%';
            }
        }

        async function deletePortfolioItem(fileId) {
            const confirmed = await Confirm.delete('Delete Portfolio Item', 'Are you sure you want to delete this portfolio item? This action cannot be undone.');
            if (!confirmed) return;

            try {
                const response = await apiFetch('/portfolio', {
                    method: 'DELETE',
                    body: JSON.stringify({ file_id: fileId })
                });

                if (response.success) {
                    Toast.success('Portfolio item deleted successfully');
                    await loadPortfolio(); // Reload portfolio
                } else {
                    Toast.error(response.error || 'Failed to delete portfolio item');
                }
            } catch (error) {
                console.error('Delete error:', error);
                Toast.error('Failed to delete portfolio item');
            }
        }
    </script>
</body>
</html>