<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reset Password - FunaGig</title>
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <header class="navbar">
        <div class="brand">
            <div class="logo"></div> FunaGig
        </div>
        <nav class="nav-actions">
            <a class="btn ghost" href="index.html">Home</a>
            <a class="btn" href="auth.html">Log In</a>
        </nav>
    </header>

    <main class="auth-wrap">
        <form class="card card-lg" id="reset-password-form">
            <h1 class="h1" style="font-size:32px; text-align:center;">Reset Password</h1>
            <p class="subtle mb-10" style="text-align:center;">Enter your new password below</p>
            
            <input type="hidden" id="reset-token" name="token" />
            
            <div class="field">
                <label class="label">New Password *</label>
                <input type="password" class="input" id="password" name="password" placeholder="Enter new password" required minlength="6" />
                <div class="subtle" style="font-size: 12px; margin-top: 4px;">Password must be at least 6 characters</div>
                <div class="error-message" id="passwordError"></div>
            </div>
            
            <div class="field">
                <label class="label">Confirm Password *</label>
                <input type="password" class="input" id="confirmPassword" name="confirmPassword" placeholder="Confirm new password" required minlength="6" />
                <div class="error-message" id="confirmPasswordError"></div>
            </div>
            
            <button type="submit" class="btn" style="width: 100%;">Reset Password</button>
            
            <div class="section mt-20" style="text-align:center;">
                <p class="subtle">Remember your password? 
                    <a href="auth.html" style="color: var(--primary);">Log in</a>
                </p>
            </div>
        </form>
    </main>

    <script src="app.js"></script>
    <script>
        // Get token from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        
        if (token) {
            document.getElementById('reset-token').value = token;
        } else {
            // If no token in URL, check if user entered it manually (development mode)
            // Show input field for token
            const tokenInput = document.createElement('div');
            tokenInput.className = 'field';
            tokenInput.innerHTML = `
                <label class="label">Reset Token *</label>
                <input type="text" class="input" id="manual-token" placeholder="Enter reset token" />
                <div class="error-message" id="tokenError"></div>
            `;
            document.getElementById('reset-password-form').insertBefore(tokenInput, document.querySelector('.field'));
        }
        
        document.getElementById('reset-password-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            clearErrors();
            
            const resetToken = document.getElementById('reset-token').value || document.getElementById('manual-token')?.value || '';
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            let isValid = true;
            
            if (!resetToken) {
                showError('tokenError', 'Reset token is required');
                isValid = false;
            }
            
            if (!password) {
                showError('passwordError', 'Password is required');
                isValid = false;
            } else if (password.length < 6) {
                showError('passwordError', 'Password must be at least 6 characters');
                isValid = false;
            }
            
            if (!confirmPassword) {
                showError('confirmPasswordError', 'Please confirm your password');
                isValid = false;
            } else if (password !== confirmPassword) {
                showError('confirmPasswordError', 'Passwords do not match');
                isValid = false;
            }
            
            if (isValid) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Resetting...';
                
                apiFetch('/auth/reset-password', {
                    method: 'POST',
                    body: JSON.stringify({
                        token: resetToken,
                        password: password,
                        confirmPassword: confirmPassword
                    })
                })
                .then(response => {
                    if (response.success) {
                        Toast.success(response.message || 'Password reset successfully!');
                        
                        // Redirect to login page after 2 seconds
                        setTimeout(() => {
                            window.location.href = 'auth.html';
                        }, 2000);
                    } else {
                        showError('passwordError', response.error || 'Failed to reset password');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                })
                .catch(error => {
                    console.error('Reset password error:', error);
                    showError('passwordError', 'Error: Could not connect to server');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                });
            }
        });
        
        function clearErrors() {
            const errorElements = document.querySelectorAll('.error-message');
            errorElements.forEach(element => {
                element.textContent = '';
                element.style.display = 'none';
            });
        }
        
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                errorElement.style.color = 'var(--danger)';
                errorElement.style.fontSize = '12px';
                errorElement.style.marginTop = '4px';
            }
        }
    </script>
</body>
</html>

