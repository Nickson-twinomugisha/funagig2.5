<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gigs - FunaGig</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <header class="navbar">
        <div class="brand">
            <div class="logo"></div> FunaGig
        </div>
    </header>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="title" style="display:flex; align-items:center; gap:10px;">
                <div class="cover-img" style="width:36px;height:36px;">AP</div> Amanya Peter
            </div>
            <nav class="navlist">
                <a class="navitem" href="student-dashboard.html">Dashboard</a>
                <a class="navitem active" href="student-gigs.html">Gigs</a>
                <a class="navitem" href="student-messaging.html">Messages</a>
                <a class="navitem" href="student-profile.html">Profile</a>
                <a class="navitem" href="index.html">Log out</a>
            </nav>
        </aside>
        <main class="content">
            <h1 class="h1">Gigs</h1>
            <div class="tabs">
                <button class="tab active" data-tab="browse" onclick="showTab('browse', this)">Browse</button>
                <button class="tab" data-tab="saved" onclick="showTab('saved', this)">Saved</button>
                <button class="tab" data-tab="interested" onclick="showTab('interested', this)">Interested</button>
                <button class="tab" data-tab="applications" onclick="showTab('applications', this)">Applications</button>
            </div>

            <!-- Browse Tab -->
            <div id="browse" class="tab-content" style="display:block;">
                <div class="flex items-center justify-between mb-20">
                    <h2>Find Gigs</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" class="input" id="searchInput" placeholder="Search gigs..." style="width: 300px;" />
                        <select class="select" id="sortBy" style="width: 180px;">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="budget_high">Budget: High to Low</option>
                            <option value="budget_low">Budget: Low to High</option>
                            <option value="title_asc">Title: A to Z</option>
                            <option value="title_desc">Title: Z to A</option>
                        </select>
                    </div>
                </div>
                
                <!-- Advanced Filters -->
                <div class="section mb-20" id="filtersSection">
                    <div class="flex items-center justify-between mb-10">
                        <h3 style="margin: 0;">Filters</h3>
                        <div style="display: flex; gap: 8px;">
                            <button type="button" class="btn secondary" onclick="clearAllFilters()" style="font-size: 12px; padding: 6px 12px;">Clear All</button>
                            <button type="button" class="btn secondary" onclick="toggleFilters()" id="toggleFiltersBtn" style="font-size: 12px; padding: 6px 12px;">Show Filters</button>
                        </div>
                    </div>
                    
                    <div id="filtersContent" style="display: none;">
                        <div class="grid-3" style="gap: 16px;">
                            <!-- Budget Range -->
                            <div class="field">
                                <label class="label">Budget Range</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="number" class="input" id="budgetMin" placeholder="Min" min="0" style="flex: 1;" />
                                    <span class="subtle">-</span>
                                    <input type="number" class="input" id="budgetMax" placeholder="Max" min="0" style="flex: 1;" />
                                </div>
                            </div>
                            
                            <!-- Gig Type -->
                            <div class="field">
                                <label class="label">Gig Type</label>
                                <select class="select" id="typeFilter" multiple style="height: 80px;">
                                    <option value="one-time">One-Time</option>
                                    <option value="ongoing">Ongoing</option>
                                    <option value="contract">Contract</option>
                                </select>
                                <div class="subtle" style="font-size: 11px; margin-top: 4px;">Hold Ctrl/Cmd to select multiple</div>
                            </div>
                            
                            <!-- Location -->
                            <div class="field">
                                <label class="label">Location</label>
                                <input type="text" class="input" id="locationFilter" list="locationSuggestions" placeholder="Enter location..." />
                                <datalist id="locationSuggestions"></datalist>
                            </div>
                        </div>
                        
                        <div class="grid-3 mt-10" style="gap: 16px;">
                            <!-- Skills Multi-Select -->
                            <div class="field">
                                <label class="label">Skills</label>
                                <input type="text" class="input" id="skillsFilter" placeholder="Enter skills (comma-separated)" />
                                <div class="subtle" style="font-size: 11px; margin-top: 4px;">e.g., JavaScript, Python, Design</div>
                            </div>
                            
                            <!-- Date Posted -->
                            <div class="field">
                                <label class="label">Posted Date</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="date" class="input" id="postedDateFrom" style="flex: 1;" />
                                    <span class="subtle">to</span>
                                    <input type="date" class="input" id="postedDateTo" style="flex: 1;" />
                                </div>
                            </div>
                            
                            <!-- Deadline -->
                            <div class="field">
                                <label class="label">Deadline</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="date" class="input" id="deadlineFrom" style="flex: 1;" />
                                    <span class="subtle">to</span>
                                    <input type="date" class="input" id="deadlineTo" style="flex: 1;" />
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-10 mt-10">
                            <button type="button" class="btn" onclick="applyFilters()">Apply Filters</button>
                            <button type="button" class="btn secondary" onclick="saveFilterPreferences()">Save Preferences</button>
                </div>
                    </div>
                </div>
                <!-- Gig List -->
                <div id="browseGigsList" class="card-grid mt-20">
                    <!-- Gigs will be loaded here via JavaScript -->
                </div>
            </div>

            <!-- Saved Tab -->
            <div id="saved" class="tab-content" style="display:none;">
                <h2>Saved Gigs</h2>
                <div id="saved-list" class="card-grid">
                    <!-- Load via JS, similar to gigs -->
                </div>
            </div>

            <!-- Interested Tab -->
            <div id="interested" class="tab-content" style="display:none;">
                <h2>Interested Gigs</h2>
                <div id="interested-list" class="card-grid">
                    <!-- Load via JS -->
                </div>
            </div>

            <!-- Applications Tab -->
            <div id="applications" class="tab-content" style="display:none;">
                <div class="flex items-center justify-between mb-20">
                    <h2>My Applications</h2>
                    <div class="flex items-center gap-10">
                        <select id="applicationStatusFilter" class="select" onchange="filterApplications()">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="accepted">Accepted</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                </div>
                
                <div id="applications-list">
                    <!-- Applications will be loaded here -->
                </div>
            </div>
        </main>
    </div>
    <script>
        let allGigs = [];
        let savedGigs = [];
        let savedGigIds = new Set();
        let currentPage = 1;
        let savedCurrentPage = 1;
        const itemsPerPage = 12;
        let currentSort = 'newest';
        
        // Load user data and update sidebar
        document.addEventListener('DOMContentLoaded', async function() {
            // Verify session and check user type
            if (!Auth.requireUserType('student')) {
                return;
            }
            
            // Verify session is still valid
            const user = await Auth.verifySession();
            if (!user) {
                return; // verifySession already handles logout/redirect
            }
            
            if (user) {
                
                // Update user name in sidebar
                const userName = user.name;
                const userInitials = userName.split(' ').map(n => n[0]).join('').toUpperCase();
                
                // Update sidebar
                const sidebarTitle = document.querySelector('.sidebar .title');
                if (sidebarTitle) {
                    sidebarTitle.innerHTML = `<div class="cover-img" style="width:36px;height:36px;">${userInitials}</div> ${userName}`;
                }
                
                // Load saved gigs first to track which are saved
                loadSavedGigs().then(() => {
                    // Then load all gigs
                    return loadGigs();
                }).then(() => {
                    // Load location suggestions after gigs are loaded
                    loadLocationSuggestions();
                    
                    // Setup search and filters after data is loaded
                    setupSearch();
                    
                    // Apply initial filters if any are set
                    const hasFilters = document.getElementById('budgetMin')?.value || 
                                     document.getElementById('budgetMax')?.value ||
                                     document.getElementById('typeFilter')?.selectedOptions.length > 0 ||
                                     document.getElementById('locationFilter')?.value ||
                                     document.getElementById('skillsFilter')?.value ||
                                     document.getElementById('postedDateFrom')?.value ||
                                     document.getElementById('postedDateTo')?.value ||
                                     document.getElementById('deadlineFrom')?.value ||
                                     document.getElementById('deadlineTo')?.value;
                    
                    if (hasFilters) {
                        filterGigs();
                    }
                    
                    // Handle hash-based navigation (for quick action buttons) after data loads
                    const handleHashNavigation = () => {
                        const hash = window.location.hash.substring(1); // Remove #
                        if (hash && ['browse', 'saved', 'interested', 'applications'].includes(hash)) {
                            showTab(hash);
                        }
                    };
                    
                    // Check hash on page load (after data is loaded)
                    handleHashNavigation();
                    
                    // Listen for hash changes
                    window.addEventListener('hashchange', handleHashNavigation);
                });
            }
        });
        
        // Load all available gigs
        async function loadGigs() {
            const browseContainer = document.getElementById('browseGigsList');
            if (!browseContainer) return;
            
            // Show loading state
            Loading.show(browseContainer, 'Loading gigs...');
            
            try {
                const response = await apiFetch('/gigs');
                Loading.hide(browseContainer);
                
                if (response.success && response.gigs) {
                    allGigs = response.gigs;
                    if (allGigs.length === 0) {
                        EmptyState.show(
                            browseContainer,
                            'üîç',
                            'No Gigs Available',
                            'There are no gigs available at the moment. Check back later for new opportunities.',
                            null
                        );
                    } else {
                        updateGigsList(response.gigs, true);
                    }
                } else {
                    EmptyState.show(
                        browseContainer,
                        '‚ö†Ô∏è',
                        'Unable to Load Gigs',
                        'There was an error loading gigs. Please try refreshing the page.',
                        '<button class="btn" onclick="loadGigs()">Retry</button>'
                    );
                }
            } catch (error) {
                Loading.hide(browseContainer);
                console.error('Failed to load gigs:', error);
                EmptyState.show(
                    browseContainer,
                    '‚ö†Ô∏è',
                    'Unable to Load Gigs',
                    'There was an error loading gigs. Please check your connection and try again.',
                    '<button class="btn" onclick="loadGigs()">Retry</button>'
                );
            }
        }
        
        // Load saved gigs
        async function loadSavedGigs() {
            try {
                const response = await apiFetch('/saved-gigs');
                if (response.success && response.saved_gigs) {
                    savedGigs = response.saved_gigs;
                    savedGigIds = new Set(savedGigs.map(g => g.id));
                    
                    // Update saved tab if it's currently visible
                    const savedTab = document.getElementById('saved');
                    if (savedTab && savedTab.style.display !== 'none') {
                        updateSavedGigsList(savedGigs, true);
                    }
                }
            } catch (error) {
                console.error('Failed to load saved gigs:', error);
                // Don't show error - just continue
            }
        }
        
        // Update gigs list in browse tab with pagination
        function updateGigsList(gigs, resetPage = false) {
            const gigsContainer = document.getElementById('browseGigsList') || document.querySelector('#browse .card-grid');
            if (!gigsContainer) return;
            
            // Reset to first page when filtering
            if (resetPage) {
                currentPage = 1;
            }
            
            if (!gigs || gigs.length === 0) {
                EmptyState.show(
                    gigsContainer,
                    'üîç',
                    'No Gigs Found',
                    'No gigs match your search. Try adjusting your search terms.',
                    '<button class="btn secondary" onclick="document.getElementById(\'searchInput\').value=\'\'; setupSearch();">Clear Search</button>'
                );
                // Remove pagination if it exists
                const existingPagination = document.getElementById('browsePagination');
                if (existingPagination) existingPagination.remove();
                return;
            }
            
            // Paginate the results
            const paginated = Pagination.paginate(gigs, currentPage, itemsPerPage);
            
            gigsContainer.innerHTML = paginated.data.map(gig => {
                const isSaved = savedGigIds.has(gig.id);
                const deadline = new Date(gig.deadline).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                return `
                    <article class="section" style="display:grid; grid-template-columns:160px 1fr auto; gap:16px;">
                        <div style="height:120px; background:#dbeafe; border-radius:12px;"></div>
                        <div>
                            <h3 style="margin:0 0 8px 0;">${escapeHtml(gig.title || 'Untitled Gig')}</h3>
                            <p class="subtle" style="margin-bottom:8px;">${escapeHtml((gig.description || '').substring(0, 100))}${(gig.description || '').length > 100 ? '...' : ''}</p>
                            <div class="flex items-center gap-10" style="flex-wrap: wrap; margin-top: 8px;">
                                ${gig.skills ? `<span class="pill blue">${escapeHtml(gig.skills.split(',')[0].trim())}</span>` : ''}
                                <span class="subtle" style="font-size: 12px;">Budget: sh.${parseInt(gig.budget || 0).toLocaleString()}</span>
                                <span class="subtle" style="font-size: 12px;">Deadline: ${deadline}</span>
                            </div>
                            ${gig.business_name ? `<div class="subtle mt-5" style="font-size: 12px;">By: ${escapeHtml(gig.business_name)}</div>` : ''}
                        </div>
                        <div style="display:grid; gap:10px;">
                            <button class="btn ${isSaved ? 'secondary' : ''}" onclick="toggleSaveGig(${gig.id}, ${isSaved})" id="saveBtn_${gig.id}" style="${isSaved ? 'opacity: 0.8;' : ''}">
                                ${isSaved ? '‚úì Saved' : 'Save'}
                            </button>
                            <button class="btn" onclick="applyToGig(${gig.id}, '${escapeHtml(gig.title)}')">Apply</button>
                            <button class="btn secondary" onclick="showInterest(${gig.id}, '${escapeHtml(gig.title)}')">Interest</button>
                        </div>
                    </article>
                `;
            }).join('');
        }
        
        // Update saved gigs list with pagination
        function updateSavedGigsList(gigs, resetPage = false) {
            const savedContainer = document.getElementById('saved-list');
            if (!savedContainer) return;
            
            // Reset to first page when reloading
            if (resetPage) {
                savedCurrentPage = 1;
            }
            
            if (!gigs || gigs.length === 0) {
                EmptyState.show(
                    savedContainer,
                    '‚≠ê',
                    'No Saved Gigs',
                    'You haven\'t saved any gigs yet. Browse gigs and save the ones you\'re interested in.',
                    '<button class="btn" onclick="showTab(\'browse\')">Browse Gigs</button>'
                );
                // Remove pagination if it exists
                const existingPagination = document.getElementById('savedPagination');
                if (existingPagination) existingPagination.remove();
                return;
            }
            
            // Paginate the results
            const paginated = Pagination.paginate(gigs, savedCurrentPage, itemsPerPage);
            
            savedContainer.innerHTML = paginated.data.map(gig => {
                const deadline = new Date(gig.deadline).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                return `
                    <article class="section" style="display:grid; grid-template-columns:160px 1fr auto; gap:16px;">
                        <div style="height:120px; background:#dbeafe; border-radius:12px;"></div>
                        <div>
                            <h3 style="margin:0 0 8px 0;">${escapeHtml(gig.title || 'Untitled Gig')}</h3>
                            <p class="subtle" style="margin-bottom:8px;">${escapeHtml((gig.description || '').substring(0, 100))}${(gig.description || '').length > 100 ? '...' : ''}</p>
                            <div class="flex items-center gap-10" style="flex-wrap: wrap; margin-top: 8px;">
                                ${gig.skills ? `<span class="pill blue">${escapeHtml(gig.skills.split(',')[0].trim())}</span>` : ''}
                                <span class="subtle" style="font-size: 12px;">Budget: sh.${parseInt(gig.budget || 0).toLocaleString()}</span>
                                <span class="subtle" style="font-size: 12px;">Deadline: ${deadline}</span>
                            </div>
                            ${gig.business_name ? `<div class="subtle mt-5" style="font-size: 12px;">By: ${escapeHtml(gig.business_name)}</div>` : ''}
                        </div>
                        <div style="display:grid; gap:10px;">
                            <button class="btn secondary" onclick="toggleSaveGig(${gig.id}, true)">Remove</button>
                            <button class="btn" onclick="applyToGig(${gig.id}, '${escapeHtml(gig.title)}')">Apply</button>
                        </div>
                    </article>
                `;
            }).join('');
            
            // Remove existing pagination
            const existingPagination = document.getElementById('savedPagination');
            if (existingPagination) existingPagination.remove();
            
            // Add pagination if needed
            if (paginated.totalPages > 1) {
                const paginationContainer = Pagination.create(
                    savedCurrentPage,
                    paginated.totalPages,
                    (page) => {
                        savedCurrentPage = page;
                        updateSavedGigsList(gigs, false);
                        // Scroll to top of list
                        savedContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                );
                paginationContainer.id = 'savedPagination';
                savedContainer.parentElement.appendChild(paginationContainer);
            }
        }
        
        // Toggle save/unsave gig
        async function toggleSaveGig(gigId, isCurrentlySaved) {
            try {
                if (isCurrentlySaved) {
                    // Unsave
                    const response = await apiFetch(`/saved-gigs?gig_id=${gigId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.success) {
                        savedGigIds.delete(gigId);
                        savedGigs = savedGigs.filter(g => g.id !== gigId);
                        showNotification('Gig removed from saved', 'info');
                        
                        // Update button in browse tab
                        const saveBtn = document.getElementById(`saveBtn_${gigId}`);
                        if (saveBtn) {
                            saveBtn.textContent = 'Save';
                            saveBtn.classList.remove('secondary');
                            saveBtn.style.opacity = '1';
                        }
                        
                        // Update saved tab if visible
                        const savedTab = document.getElementById('saved');
                        if (savedTab && savedTab.style.display !== 'none') {
                            updateSavedGigsList(savedGigs, true);
                        }
                    }
                } else {
                    // Save
                    const response = await apiFetch('/saved-gigs', {
                        method: 'POST',
                        body: JSON.stringify({
                            gig_id: gigId
                        })
                    });
                    
                    if (response.success) {
                        savedGigIds.add(gigId);
                        const savedGig = allGigs.find(g => g.id === gigId);
                        if (savedGig) {
                            savedGigs.push(savedGig);
                        }
            showNotification('Gig saved!', 'success');
                        
                        // Update button
                        const saveBtn = document.getElementById(`saveBtn_${gigId}`);
                        if (saveBtn) {
                            saveBtn.textContent = '‚úì Saved';
                            saveBtn.classList.add('secondary');
                            saveBtn.style.opacity = '0.8';
                        }
                    } else {
                        showNotification(response.error || 'Failed to save gig', 'error');
                    }
                }
            } catch (error) {
                console.error('Error toggling save:', error);
                showNotification('Failed to save/unsave gig', 'error');
            }
        }
        
        // Apply to gig with better UI
        async function applyToGig(gigId, gigTitle) {
            // Check if already applied
            try {
                const applicationsResponse = await apiFetch('/applications');
                if (applicationsResponse.success && applicationsResponse.applications) {
                    const alreadyApplied = applicationsResponse.applications.find(
                        app => app.gig_id == gigId
                    );
                    
                    if (alreadyApplied) {
                        showNotification('You have already applied to this gig', 'info');
                        return;
                    }
                }
            } catch (error) {
                // Continue even if check fails
            }
            
            // Show application modal
            const applicationData = await ApplicationModal.show(gigTitle, gigId);
            if (!applicationData) {
                return; // User cancelled
            }
            
            try {
                const response = await apiFetch('/applications', {
                    method: 'POST',
                    body: JSON.stringify({
                        gig_id: gigId,
                        message: applicationData.message.trim(),
                        resume_path: applicationData.resume_path || null
                    })
                });
                
                    if (response.success) {
                        showNotification('Application submitted successfully!', 'success');
                    } else {
                    showNotification(response.error || 'Failed to submit application', 'error');
                    }
            } catch (error) {
                    console.error('Application error:', error);
                showNotification('Failed to submit application. Please try again.', 'error');
            }
        }
        
        // Show interest (placeholder - could be enhanced later)
        function showInterest(gigId, gigTitle) {
            showNotification(`Interest noted for "${gigTitle}"!`, 'info');
            // TODO: Could store interest in database or send notification to business
        }
        
        // Setup search and sort functionality
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            const sortBy = document.getElementById('sortBy');
            
            // Load state from URL on page load
            const urlSearch = URLState.get('search', '');
            const urlSort = URLState.get('sort', 'newest');
            
            if (urlSearch && searchInput) {
                searchInput.value = urlSearch;
            }
            if (urlSort && sortBy) {
                sortBy.value = urlSort;
                currentSort = urlSort;
            }
            
            // Load filters from URL
            loadFiltersFromURL();
            
            // Load saved preferences (will override URL if both exist)
            loadFilterPreferences();
            
            // Load location suggestions after gigs are loaded
            if (allGigs.length > 0) {
                loadLocationSuggestions();
            }
            
            // Search functionality with debouncing and loading indicator
            if (searchInput) {
                const debouncedFilter = Debounce.create(() => {
                    // Update URL with search term
                    URLState.set('search', searchInput.value || null);
                    filterGigs(searchInput.value);
                }, 300, {
                    showLoading: true,
                    loadingElement: searchInput
                });
                
                searchInput.addEventListener('input', debouncedFilter);
            }
            
            // Sort functionality
            if (sortBy) {
                sortBy.addEventListener('change', function() {
                    currentSort = this.value;
                    // Update URL with sort option
                    URLState.set('sort', this.value || null);
                    filterGigs();
                });
            }
            
            // Filter input event listeners
            const filterInputs = ['budgetMin', 'budgetMax', 'locationFilter', 'skillsFilter', 
                                 'postedDateFrom', 'postedDateTo', 'deadlineFrom', 'deadlineTo'];
            filterInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('change', function() {
                        updateFiltersURLState();
                        filterGigs();
                    });
                    
                    // For text inputs, use debouncing
                    if (input.type === 'text') {
                        const debouncedFilter = Debounce.create(() => {
                            updateFiltersURLState();
                            filterGigs();
                        }, 500);
                        input.addEventListener('input', debouncedFilter);
                    }
                }
            });
            
            // Type filter change
            const typeFilter = document.getElementById('typeFilter');
            if (typeFilter) {
                typeFilter.addEventListener('change', function() {
                    updateFiltersURLState();
                    filterGigs();
                });
            }
            
            // Watch for URL changes (browser back/forward)
            URLState.watch(() => {
                const urlSearch = URLState.get('search', '');
                const urlSort = URLState.get('sort', 'newest');
                
                if (searchInput && urlSearch !== searchInput.value) {
                    searchInput.value = urlSearch;
                }
                if (sortBy && urlSort !== sortBy.value) {
                    sortBy.value = urlSort;
                    currentSort = urlSort;
                }
                
                // Reload filters from URL
                loadFiltersFromURL();
                
                // Apply filters
                filterGigs();
            });
        }
        
        // Sort gigs based on selected sort option
        function sortGigs(gigs) {
            if (!gigs || gigs.length === 0) return gigs;
            
            let sorted = [...gigs];
            
            switch (currentSort) {
                case 'newest':
                    sorted = Sort.byDate(sorted, 'created_at', 'desc');
                    break;
                case 'oldest':
                    sorted = Sort.byDate(sorted, 'created_at', 'asc');
                    break;
                case 'budget_high':
                    sorted = Sort.byNumber(sorted, 'budget', 'desc');
                    break;
                case 'budget_low':
                    sorted = Sort.byNumber(sorted, 'budget', 'asc');
                    break;
                case 'title_asc':
                    sorted = Sort.byString(sorted, 'title', 'asc');
                    break;
                case 'title_desc':
                    sorted = Sort.byString(sorted, 'title', 'desc');
                    break;
                default:
                    sorted = Sort.byDate(sorted, 'created_at', 'desc');
            }
            
            return sorted;
        }
        
        // Filter gigs with advanced filters
        function filterGigs(searchTerm = null) {
            let filtered = allGigs;
            
            // Get search term from input if not provided
            if (searchTerm === null) {
                const searchInput = document.getElementById('searchInput');
                searchTerm = searchInput ? searchInput.value.trim() : '';
            }
            
            // Text search
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(gig => {
                    const title = (gig.title || '').toLowerCase();
                    const description = (gig.description || '').toLowerCase();
                    const skills = (gig.skills || '').toLowerCase();
                    const businessName = (gig.business_name || '').toLowerCase();
                    const location = (gig.location || '').toLowerCase();
                    
                    return title.includes(term) || 
                           description.includes(term) || 
                           skills.includes(term) ||
                           businessName.includes(term) ||
                           location.includes(term);
                });
            }
            
            // Budget range filter
            const budgetMin = document.getElementById('budgetMin')?.value;
            const budgetMax = document.getElementById('budgetMax')?.value;
            if (budgetMin) {
                filtered = filtered.filter(gig => parseFloat(gig.budget || 0) >= parseFloat(budgetMin));
            }
            if (budgetMax) {
                filtered = filtered.filter(gig => parseFloat(gig.budget || 0) <= parseFloat(budgetMax));
            }
            
            // Gig type filter
            const typeFilter = document.getElementById('typeFilter');
            if (typeFilter) {
                const selectedTypes = Array.from(typeFilter.selectedOptions).map(opt => opt.value);
                if (selectedTypes.length > 0) {
                    filtered = filtered.filter(gig => selectedTypes.includes(gig.type || 'one-time'));
                }
            }
            
            // Location filter
            const locationFilter = document.getElementById('locationFilter')?.value.trim();
            if (locationFilter) {
                filtered = filtered.filter(gig => {
                    const location = (gig.location || '').toLowerCase();
                    return location.includes(locationFilter.toLowerCase());
                });
            }
            
            // Skills filter
            const skillsFilter = document.getElementById('skillsFilter')?.value.trim();
            if (skillsFilter) {
                const requiredSkills = skillsFilter.split(',').map(s => s.trim().toLowerCase()).filter(s => s);
                if (requiredSkills.length > 0) {
                    filtered = filtered.filter(gig => {
                        const gigSkills = (gig.skills || '').toLowerCase();
                        return requiredSkills.some(skill => gigSkills.includes(skill));
                });
            }
        }
        
            // Posted date filter
            const postedDateFrom = document.getElementById('postedDateFrom')?.value;
            const postedDateTo = document.getElementById('postedDateTo')?.value;
            if (postedDateFrom) {
                const fromDate = new Date(postedDateFrom);
                filtered = filtered.filter(gig => {
                    const gigDate = new Date(gig.created_at);
                    return gigDate >= fromDate;
                });
            }
            if (postedDateTo) {
                const toDate = new Date(postedDateTo);
                toDate.setHours(23, 59, 59, 999); // End of day
                filtered = filtered.filter(gig => {
                    const gigDate = new Date(gig.created_at);
                    return gigDate <= toDate;
                });
            }
            
            // Deadline filter
            const deadlineFrom = document.getElementById('deadlineFrom')?.value;
            const deadlineTo = document.getElementById('deadlineTo')?.value;
            if (deadlineFrom) {
                const fromDate = new Date(deadlineFrom);
                filtered = filtered.filter(gig => {
                    const gigDeadline = new Date(gig.deadline);
                    return gigDeadline >= fromDate;
                });
            }
            if (deadlineTo) {
                const toDate = new Date(deadlineTo);
                toDate.setHours(23, 59, 59, 999); // End of day
                filtered = filtered.filter(gig => {
                    const gigDeadline = new Date(gig.deadline);
                    return gigDeadline <= toDate;
                });
            }
            
            // Sort the filtered results
            filtered = sortGigs(filtered);
            
            updateGigsList(filtered, true); // Reset to page 1 when filtering
        }
        
        // Apply filters
        function applyFilters() {
            filterGigs();
            
            // Update URL state with filter values
            updateFiltersURLState();
        }
        
        // Clear all filters
        function clearAllFilters() {
            document.getElementById('budgetMin').value = '';
            document.getElementById('budgetMax').value = '';
            document.getElementById('typeFilter').selectedIndex = -1;
            document.getElementById('locationFilter').value = '';
            document.getElementById('skillsFilter').value = '';
            document.getElementById('postedDateFrom').value = '';
            document.getElementById('postedDateTo').value = '';
            document.getElementById('deadlineFrom').value = '';
            document.getElementById('deadlineTo').value = '';
            
            // Clear URL state
            URLState.set('budget_min', null);
            URLState.set('budget_max', null);
            URLState.set('type', null);
            URLState.set('location', null);
            URLState.set('skills', null);
            URLState.set('posted_from', null);
            URLState.set('posted_to', null);
            URLState.set('deadline_from', null);
            URLState.set('deadline_to', null);
            
            // Reapply search only
            const searchTerm = document.getElementById('searchInput')?.value || '';
            filterGigs(searchTerm);
        }
        
        // Toggle filters visibility
        function toggleFilters() {
            const filtersContent = document.getElementById('filtersContent');
            const toggleBtn = document.getElementById('toggleFiltersBtn');
            
            if (filtersContent.style.display === 'none') {
                filtersContent.style.display = 'block';
                toggleBtn.textContent = 'Hide Filters';
            } else {
                filtersContent.style.display = 'none';
                toggleBtn.textContent = 'Show Filters';
            }
        }
        
        // Load location suggestions from existing gigs
        function loadLocationSuggestions() {
            const locations = new Set();
            allGigs.forEach(gig => {
                if (gig.location) {
                    locations.add(gig.location);
                }
            });
            
            const datalist = document.getElementById('locationSuggestions');
            if (datalist) {
                datalist.innerHTML = Array.from(locations).sort().map(loc => 
                    `<option value="${escapeHtml(loc)}">`
                ).join('');
            }
        }
        
        // Save filter preferences to localStorage
        function saveFilterPreferences() {
            const preferences = {
                budgetMin: document.getElementById('budgetMin')?.value || '',
                budgetMax: document.getElementById('budgetMax')?.value || '',
                type: Array.from(document.getElementById('typeFilter')?.selectedOptions || []).map(opt => opt.value),
                location: document.getElementById('locationFilter')?.value || '',
                skills: document.getElementById('skillsFilter')?.value || '',
                postedDateFrom: document.getElementById('postedDateFrom')?.value || '',
                postedDateTo: document.getElementById('postedDateTo')?.value || '',
                deadlineFrom: document.getElementById('deadlineFrom')?.value || '',
                deadlineTo: document.getElementById('deadlineTo')?.value || '',
                filtersVisible: document.getElementById('filtersContent')?.style.display !== 'none'
            };
            
            localStorage.setItem('gigFilterPreferences', JSON.stringify(preferences));
            Toast.success('Filter preferences saved!');
        }
        
        // Load filter preferences from localStorage
        function loadFilterPreferences() {
            try {
                const saved = localStorage.getItem('gigFilterPreferences');
                if (saved) {
                    const preferences = JSON.parse(saved);
                    
                    if (preferences.budgetMin) document.getElementById('budgetMin').value = preferences.budgetMin;
                    if (preferences.budgetMax) document.getElementById('budgetMax').value = preferences.budgetMax;
                    if (preferences.location) document.getElementById('locationFilter').value = preferences.location;
                    if (preferences.skills) document.getElementById('skillsFilter').value = preferences.skills;
                    if (preferences.postedDateFrom) document.getElementById('postedDateFrom').value = preferences.postedDateFrom;
                    if (preferences.postedDateTo) document.getElementById('postedDateTo').value = preferences.postedDateTo;
                    if (preferences.deadlineFrom) document.getElementById('deadlineFrom').value = preferences.deadlineFrom;
                    if (preferences.deadlineTo) document.getElementById('deadlineTo').value = preferences.deadlineTo;
                    
                    // Restore type selections
                    if (preferences.type && preferences.type.length > 0) {
                        const typeFilter = document.getElementById('typeFilter');
                        preferences.type.forEach(type => {
                            const option = Array.from(typeFilter.options).find(opt => opt.value === type);
                            if (option) option.selected = true;
                        });
                    }
                    
                    // Restore filters visibility
                    if (preferences.filtersVisible) {
                        document.getElementById('filtersContent').style.display = 'block';
                        document.getElementById('toggleFiltersBtn').textContent = 'Hide Filters';
                    }
                }
            } catch (error) {
                console.error('Failed to load filter preferences:', error);
            }
        }
        
        // Update URL state with current filter values
        function updateFiltersURLState() {
            const budgetMin = document.getElementById('budgetMin')?.value;
            const budgetMax = document.getElementById('budgetMax')?.value;
            const typeFilter = document.getElementById('typeFilter');
            const selectedTypes = typeFilter ? Array.from(typeFilter.selectedOptions).map(opt => opt.value) : [];
            const location = document.getElementById('locationFilter')?.value;
            const skills = document.getElementById('skillsFilter')?.value;
            const postedFrom = document.getElementById('postedDateFrom')?.value;
            const postedTo = document.getElementById('postedDateTo')?.value;
            const deadlineFrom = document.getElementById('deadlineFrom')?.value;
            const deadlineTo = document.getElementById('deadlineTo')?.value;
            
            URLState.set('budget_min', budgetMin || null);
            URLState.set('budget_max', budgetMax || null);
            URLState.set('type', selectedTypes.length > 0 ? selectedTypes.join(',') : null);
            URLState.set('location', location || null);
            URLState.set('skills', skills || null);
            URLState.set('posted_from', postedFrom || null);
            URLState.set('posted_to', postedTo || null);
            URLState.set('deadline_from', deadlineFrom || null);
            URLState.set('deadline_to', deadlineTo || null);
        }
        
        // Load filters from URL state
        function loadFiltersFromURL() {
            const budgetMin = URLState.get('budget_min', '');
            const budgetMax = URLState.get('budget_max', '');
            const type = URLState.get('type', '');
            const location = URLState.get('location', '');
            const skills = URLState.get('skills', '');
            const postedFrom = URLState.get('posted_from', '');
            const postedTo = URLState.get('posted_to', '');
            const deadlineFrom = URLState.get('deadline_from', '');
            const deadlineTo = URLState.get('deadline_to', '');
            
            if (budgetMin) document.getElementById('budgetMin').value = budgetMin;
            if (budgetMax) document.getElementById('budgetMax').value = budgetMax;
            if (location) document.getElementById('locationFilter').value = location;
            if (skills) document.getElementById('skillsFilter').value = skills;
            if (postedFrom) document.getElementById('postedDateFrom').value = postedFrom;
            if (postedTo) document.getElementById('postedDateTo').value = postedTo;
            if (deadlineFrom) document.getElementById('deadlineFrom').value = deadlineFrom;
            if (deadlineTo) document.getElementById('deadlineTo').value = deadlineTo;
            
            // Load type selections
            if (type) {
                const types = type.split(',');
                const typeFilter = document.getElementById('typeFilter');
                types.forEach(typeValue => {
                    const option = Array.from(typeFilter.options).find(opt => opt.value === typeValue.trim());
                    if (option) option.selected = true;
                });
            }
        }
        
        // Show tab content
        function showTab(tabId, buttonElement = null) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            
            // Show selected tab content
            const tabContent = document.getElementById(tabId);
            if (tabContent) {
                tabContent.style.display = 'block';
            }
            
            // Update tab button states
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            
            // Activate the clicked button or find it by tabId
            if (buttonElement) {
                buttonElement.classList.add('active');
            } else {
                // Find button by text content or data attribute
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach(tab => {
                    if (tab.textContent.toLowerCase().includes(tabId) || tab.getAttribute('data-tab') === tabId) {
                        tab.classList.add('active');
                    }
                });
                // Fallback: activate first tab if browse, second if saved, etc.
                if (!document.querySelector('.tab.active')) {
                    const tabIndex = ['browse', 'saved', 'interested', 'applications'].indexOf(tabId);
                    if (tabIndex >= 0 && tabs[tabIndex]) {
                        tabs[tabIndex].classList.add('active');
                    }
                }
            }
            
            // Update URL hash
            if (tabId && window.location.hash !== '#' + tabId) {
                window.history.replaceState(null, '', '#' + tabId);
            }
            
            // Load data for specific tabs
            if (tabId === 'saved') {
                updateSavedGigsList(savedGigs, true);
            } else if (tabId === 'browse') {
                filterGigs();
            } else if (tabId === 'interested') {
                // For now, show message - could implement later
                const interestedContainer = document.getElementById('interested-list');
                if (interestedContainer) {
                    interestedContainer.innerHTML = '<p class="subtle" style="text-align: center; padding: 40px;">Interested gigs feature coming soon.</p>';
                }
            } else if (tabId === 'applications') {
                loadApplications();
            }
        }
        
        // Load applications
        let allApplications = [];
        let applicationsCurrentPage = 1;
        const applicationsPerPage = 12;

        async function loadApplications() {
            const applicationsContainer = document.getElementById('applications-list');
            if (!applicationsContainer) return;

            // Show loading state
            Loading.show(applicationsContainer, 'Loading applications...');

            try {
                const statusFilter = document.getElementById('applicationStatusFilter')?.value || '';
                const url = statusFilter ? `/applications?status=${statusFilter}` : '/applications';
                
                const response = await apiFetch(url);
                Loading.hide(applicationsContainer);

                if (response.success && response.applications) {
                    allApplications = response.applications;
                    displayApplications(allApplications);
                } else {
                    EmptyState.show(
                        applicationsContainer,
                        'üìã',
                        'No Applications',
                        'You haven\'t applied to any gigs yet. Browse gigs and apply to get started!',
                        '<button class="btn" onclick="showTab(\'browse\')">Browse Gigs</button>'
                    );
                }
            } catch (error) {
                console.error('Failed to load applications:', error);
                Loading.hide(applicationsContainer);
                ErrorRecovery.handleApiError(error, applicationsContainer, () => loadApplications());
            }
        }

        function displayApplications(applications) {
            const applicationsContainer = document.getElementById('applications-list');
            if (!applicationsContainer) return;

            if (!applications || applications.length === 0) {
                EmptyState.show(
                    applicationsContainer,
                    'üìã',
                    'No Applications Found',
                    'No applications match your filter. Try selecting a different status.',
                    '<button class="btn secondary" onclick="document.getElementById(\'applicationStatusFilter\').value=\'\'; filterApplications();">Clear Filter</button>'
                );
                return;
            }

            // Paginate the results
            const paginated = Pagination.paginate(applications, applicationsCurrentPage, applicationsPerPage);

            applicationsContainer.innerHTML = paginated.data.map(app => {
                const appliedDate = new Date(app.applied_at).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                let statusClass = 'yellow';
                let statusText = 'Pending';
                if (app.status === 'accepted') {
                    statusClass = 'green';
                    statusText = 'Accepted';
                } else if (app.status === 'rejected') {
                    statusClass = 'red';
                    statusText = 'Rejected';
                }

                return `
                    <div class="section" style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 16px;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 8px 0;">${escapeHtml(app.gig_title || 'Untitled Gig')}</h3>
                                ${app.business_name ? `<p class="subtle" style="margin-bottom: 8px;">Business: ${escapeHtml(app.business_name)}</p>` : ''}
                                ${app.budget ? `<p class="subtle" style="margin-bottom: 8px;">Budget: sh.${parseInt(app.budget).toLocaleString()}</p>` : ''}
                                ${app.message ? `<p class="subtle" style="margin-top: 8px; padding: 8px; background: #f5f5f5; border-radius: 4px;">${escapeHtml(app.message)}</p>` : ''}
                                ${app.resume_url || app.resume_path ? `<p class="subtle" style="margin-top: 8px; font-size: 12px;">
                                    <a href="${app.resume_url || (app.resume_path.startsWith('http') ? app.resume_path : '/' + app.resume_path)}" target="_blank" style="color: var(--primary);">üìÑ View Resume</a>
                                </p>` : ''}
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
                                <span class="pill ${statusClass}">${statusText}</span>
                                <span class="subtle" style="font-size: 12px;">Applied: ${appliedDate}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('') + Pagination.create(
                'applicationsPagination',
                applicationsCurrentPage,
                paginated.totalPages,
                (page) => {
                    applicationsCurrentPage = page;
                    displayApplications(allApplications);
                    applicationsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            );
        }

        function filterApplications() {
            applicationsCurrentPage = 1;
            loadApplications();
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
    <script src="app.js"></script>
</body>
</html>