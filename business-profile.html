<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Business Profile - FunaGig</title>
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <header class="navbar">
        <div class="brand">
            <div class="logo"></div> FunaGig
        </div>
    </header>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="title" style="display:flex; align-items:center; gap:10px;">
                <div class="cover-img" style="width:36px;height:36px;">TS</div> Tech Solutions Inc.
            </div>
            <nav class="navlist">
                <a class="navitem" href="business-dashboard.html">Dashboard</a>
                <a class="navitem" href="business-post-gig.html">Post Gig</a>
                <a class="navitem" href="business-posted-gigs.html">My Gigs</a>
                <a class="navitem" href="business-applicants.html">Applicants</a>
                <a class="navitem" href="business-messaging.html">Messages</a>
                <a class="navitem active" href="business-profile.html">Profile</a>
                <a class="navitem" href="#" onclick="Auth.logout(); return false;">Log out</a>
            </nav>
        </aside>
        <main class="content">
            <div class="section">
                <div class="flex items-center justify-between mb-20">
                    <div>
                        <h1 class="h1" style="font-size:28px; margin:0;">Business Profile</h1>
                        <p class="subtle">Manage your business information and settings</p>
                    </div>
                    <div class="flex gap-10">
                        <button class="btn" onclick="editProfile()">Edit Profile</button>
                        <a href="business-dashboard.html" class="btn secondary">Back to Dashboard</a>
                    </div>
                </div>

                <!-- Company Overview -->
                <div class="section mb-20">
                <div class="flex items-center justify-between">
                        <div class="flex items-center gap-16">
                            <div class="cover-img" id="business-profile-avatar" style="width:80px;height:80px;font-size:32px;position:relative;overflow:hidden;">
                                <img id="business-profile-image" src="" alt="Profile" style="display: none;" />
                            </div>
                            <div>
                                <button type="button" class="btn secondary" id="change-business-photo-btn" style="margin-top: 8px;">Change Photo</button>
                                <input type="file" id="business-photo-input" accept="image/*" style="display: none;" />
                                <div id="business-upload-progress" style="display: none; margin-top: 8px;">
                                    <div style="background: #eee; height: 4px; border-radius: 2px; overflow: hidden;">
                                        <div id="business-progress-bar" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
                                    </div>
                                    <div class="subtle" style="font-size: 12px; margin-top: 4px;">Uploading...</div>
                                </div>
                        </div>
                        <div>
                                <h2 id="profileCompanyName" style="margin: 0; font-size: 24px;">Loading...</h2>
                                <p id="profileIndustry" class="subtle" style="margin: 4px 0;">Loading...</p>
                                <p id="profileEstablished" class="subtle" style="display: none;"></p>
                                <div class="flex items-center gap-10 mt-8">
                                    <span id="verifiedBadge" class="pill green" style="display: none;">Verified Business</span>
                                    <span id="premiumBadge" class="pill blue" style="display: none;">Premium Member</span>
                                </div>
                        </div>
                    </div>
                        <div class="text-right">
                            <div id="profileAverageRating" style="font-size: 18px; font-weight: 600;">-</div>
                            <div class="subtle">Average Rating</div>
                            <div id="profileTotalReviews" class="subtle" style="font-size: 12px;">0 reviews</div>
                        </div>
                </div>
            </div>

                <!-- Business Information -->
                <div class="grid-2 mb-20">
                    <div class="section">
                        <h3 class="h3" style="margin-bottom: 16px;">Company Information</h3>
                        <div class="info-item">
                            <span class="label">Industry</span>
                            <span id="displayIndustry">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Location</span>
                            <span id="displayLocation">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Website</span>
                            <span id="displayWebsite">-</span>
                        </div>
                    </div>
            <div class="section">
                        <h3 class="h3" style="margin-bottom: 16px;">Contact Information</h3>
                        <div class="info-item">
                            <span class="label">Primary Contact</span>
                            <span id="displayName">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Email</span>
                            <span id="displayEmail">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Phone</span>
                            <span id="displayPhone">-</span>
                        </div>
                </div>
            </div>

                <!-- Business Description -->
                <div class="section mb-20">
                    <h3 class="h3" style="margin-bottom: 16px;">About Us</h3>
                    <div id="displayBio" style="line-height: 1.6; margin-bottom: 16px; white-space: pre-wrap;">
                        <p class="subtle">No description provided.</p>
                    </div>
                    <div id="displaySkills" class="flex gap-10" style="flex-wrap: wrap;">
                        <!-- Skills will be loaded here -->
                    </div>
                </div>

                <!-- Statistics -->
                <div class="grid-4 mb-20">
                    <div class="section" style="text-align: center;">
                        <div id="profileActiveGigs" style="font-size: 32px; font-weight: 800; color: var(--primary);">-</div>
                        <div class="subtle">Active Gigs</div>
                    </div>
                    <div class="section" style="text-align: center;">
                        <div id="profileTotalApplicants" style="font-size: 32px; font-weight: 800; color: var(--success);">-</div>
                        <div class="subtle">Total Applicants</div>
                    </div>
                    <div class="section" style="text-align: center;">
                        <div id="profileHiredStudents" style="font-size: 32px; font-weight: 800; color: var(--warning);">-</div>
                        <div class="subtle">Hired Students</div>
                    </div>
                    <div class="section" style="text-align: center;">
                        <div id="profileStatsRating" style="font-size: 32px; font-weight: 800; color: var(--info);">-</div>
                        <div class="subtle">Average Rating</div>
                    </div>
                </div>

                <!-- Reviews & Ratings -->
                <div id="reviews-section" class="section mb-20">
                    <div class="flex items-center justify-between mb-20">
                        <h3 class="h3" style="margin: 0;">Reviews & Ratings</h3>
                        <div id="rating-summary" class="text-right">
                            <div style="font-size: 24px; font-weight: 600;" id="avg-rating">-</div>
                            <div class="subtle" id="total-reviews">0 reviews</div>
                        </div>
                    </div>
                    
                    <!-- Rating Breakdown -->
                    <div id="rating-breakdown" class="mb-20" style="display: none;">
                        <div class="flex items-center gap-10 mb-8">
                            <span>5★</span>
                            <div class="flex-1" style="background: #eee; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="five-star-bar" style="background: #28a745; height: 100%; width: 0%;"></div>
                            </div>
                            <span id="five-star-count" class="subtle">0</span>
                        </div>
                        <div class="flex items-center gap-10 mb-8">
                            <span>4★</span>
                            <div class="flex-1" style="background: #eee; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="four-star-bar" style="background: #28a745; height: 100%; width: 0%;"></div>
                            </div>
                            <span id="four-star-count" class="subtle">0</span>
                        </div>
                        <div class="flex items-center gap-10 mb-8">
                            <span>3★</span>
                            <div class="flex-1" style="background: #eee; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="three-star-bar" style="background: #ffc107; height: 100%; width: 0%;"></div>
                            </div>
                            <span id="three-star-count" class="subtle">0</span>
                        </div>
                        <div class="flex items-center gap-10 mb-8">
                            <span>2★</span>
                            <div class="flex-1" style="background: #eee; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="two-star-bar" style="background: #ff9800; height: 100%; width: 0%;"></div>
                            </div>
                            <span id="two-star-count" class="subtle">0</span>
                        </div>
                        <div class="flex items-center gap-10 mb-8">
                            <span>1★</span>
                            <div class="flex-1" style="background: #eee; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="one-star-bar" style="background: #dc3545; height: 100%; width: 0%;"></div>
                            </div>
                            <span id="one-star-count" class="subtle">0</span>
                        </div>
                    </div>
                    
                    <!-- Reviews List -->
                    <div id="reviews-list">
                        <div class="empty-state">
                            <p>No reviews yet.</p>
                        </div>
                    </div>
                </div>

                <!-- Account Settings -->
            <div class="section">
                    <h3 class="h3" style="margin-bottom: 16px;">Account Settings</h3>
                    <div class="grid-2">
                        <div>
                            <div class="setting-item">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div style="font-weight: 600;">Email Notifications</div>
                                        <div class="subtle">Receive notifications about new applications and messages</div>
                                    </div>
                                    <label class="toggle">
                                        <input type="checkbox" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="setting-item">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div style="font-weight: 600;">SMS Notifications</div>
                                        <div class="subtle">Receive SMS alerts for urgent updates</div>
                                    </div>
                                    <label class="toggle">
                                        <input type="checkbox">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="setting-item">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div style="font-weight: 600;">Profile Visibility</div>
                                        <div class="subtle">Make your profile visible to students</div>
                                    </div>
                                    <label class="toggle">
                                        <input type="checkbox" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="setting-item">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div style="font-weight: 600;">Auto-approve Applications</div>
                                        <div class="subtle">Automatically approve applications from verified students</div>
                                    </div>
                                    <label class="toggle">
                                        <input type="checkbox">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="setting-item">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div style="font-weight: 600;">Weekly Reports</div>
                                        <div class="subtle">Receive weekly performance reports</div>
                                    </div>
                                    <label class="toggle">
                                        <input type="checkbox" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="setting-item">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div style="font-weight: 600;">Two-Factor Authentication</div>
                                        <div class="subtle">Add an extra layer of security to your account</div>
                                    </div>
                                    <label class="toggle">
                                        <input type="checkbox">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Business Profile</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <div class="field">
                        <label class="label">Company Name *</label>
                        <input class="input" id="editCompanyName" value="Tech Solutions Inc." required />
                    </div>
                    <div class="field">
                        <label class="label">Industry *</label>
                        <select class="select" id="editIndustry" required>
                            <option value="technology" selected>Technology</option>
                            <option value="finance">Finance</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="education">Education</option>
                            <option value="retail">Retail</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="field">
                        <label class="label">Company Size</label>
                        <select class="select" id="editCompanySize">
                            <option value="1-10">1-10 employees</option>
                            <option value="11-50">11-50 employees</option>
                            <option value="51-100" selected>51-100 employees</option>
                            <option value="100+">100+ employees</option>
                        </select>
                    </div>
                    <div class="field">
                        <label class="label">Founded Year</label>
                        <input type="number" class="input" id="editFounded" value="2015" min="1900" max="2025" />
                    </div>
                    <div class="field">
                        <label class="label">Location *</label>
                        <input class="input" id="editLocation" value="123 Innovation Drive, Tech City, Kampala" required />
                    </div>
                    <div class="field">
                        <label class="label">Website</label>
                        <input type="url" class="input" id="editWebsite" placeholder="https://www.example.com" />
                    </div>
                    <div class="field">
                        <label class="label">Phone</label>
                        <input type="tel" class="input" id="editPhone" placeholder="+256 700 123 456" />
                    </div>
                    <div class="field">
                        <label class="label">Description (Bio)</label>
                        <textarea class="textarea" id="editDescription" rows="6" placeholder="Tell us about your business..."></textarea>
                    </div>
                    <div class="field">
                        <label class="label">Skills (comma-separated)</label>
                        <textarea class="textarea" id="editSkills" rows="3" placeholder="e.g., Web Development, Mobile Apps, Cloud Solutions"></textarea>
                    </div>
                    <div class="flex gap-10 mt-20">
                        <button type="button" class="btn secondary" onclick="closeEditModal()">Cancel</button>
                        <button type="submit" class="btn">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Load user data and update profile
        document.addEventListener('DOMContentLoaded', async function() {
            // Setup real-time validation
            setupBusinessProfileValidation();
            // Verify session and check user type
            if (!Auth.requireUserType('business')) {
                return;
            }
            
            // Verify session is still valid
            const user = await Auth.verifySession();
            if (!user) {
                return; // verifySession already handles logout/redirect
            }
            
            if (user) {
                
                // Update user name in sidebar
                const userName = user.name;
                const userInitials = userName.split(' ').map(n => n[0]).join('').toUpperCase();
                
                // Update sidebar
                const sidebarTitle = document.querySelector('.sidebar .title');
                if (sidebarTitle) {
                    sidebarTitle.innerHTML = `<div class="cover-img" style="width:36px;height:36px;">${userInitials}</div> ${userName}`;
                }
                
                // Load profile data from API
                loadProfileData();
                
                // Load business stats
                loadBusinessStats();
                
                // Setup modal close on outside click
                setupModalClose();
                
                // Setup profile photo upload
                setupBusinessProfilePhotoUpload();
            }
        });
        
        // Load profile data from API
        async function loadProfileData() {
            try {
                const response = await apiFetch('/profile');
                if (response.success && response.user) {
                    updateProfileInfo(response.user);
                    populateEditForm(response.user);
                    loadReviews();
                } else {
                    // Fallback to stored user data
                    const user = Auth.getUser();
                    updateProfileInfo(user);
                    populateEditForm(user);
                    loadReviews();
                }
            } catch (error) {
                console.error('Failed to load profile:', error);
                // Use stored user data as fallback
                const user = Auth.getUser();
                updateProfileInfo(user);
                populateEditForm(user);
                loadReviews();
            }
        }
        
        async function loadReviews() {
            try {
                const user = await Auth.verifySession();
                if (!user) return;
                
                const response = await apiFetch(`/reviews/${user.id}`);
                if (response.success) {
                    displayReviews(response.reviews || [], response.rating_stats || {});
                }
            } catch (error) {
                console.error('Failed to load reviews:', error);
                const reviewsSection = document.getElementById('reviews-section');
                if (reviewsSection) reviewsSection.style.display = 'none';
            }
        }
        
        function displayReviews(reviews, ratingStats) {
            const reviewsSection = document.getElementById('reviews-section');
            if (!reviewsSection) return;
            
            const avgRatingEl = document.getElementById('avg-rating');
            const totalReviewsEl = document.getElementById('total-reviews');
            
            if (ratingStats.total_reviews > 0) {
                avgRatingEl.textContent = `${ratingStats.average_rating.toFixed(1)}/5`;
                totalReviewsEl.textContent = `${ratingStats.total_reviews} review${ratingStats.total_reviews !== 1 ? 's' : ''}`;
                
                const breakdown = document.getElementById('rating-breakdown');
                if (breakdown && ratingStats.total_reviews > 0) {
                    breakdown.style.display = 'block';
                    const total = ratingStats.total_reviews;
                    
                    document.getElementById('five-star-bar').style.width = `${(ratingStats.five_star / total) * 100}%`;
                    document.getElementById('four-star-bar').style.width = `${(ratingStats.four_star / total) * 100}%`;
                    document.getElementById('three-star-bar').style.width = `${(ratingStats.three_star / total) * 100}%`;
                    document.getElementById('two-star-bar').style.width = `${(ratingStats.two_star / total) * 100}%`;
                    document.getElementById('one-star-bar').style.width = `${(ratingStats.one_star / total) * 100}%`;
                    
                    document.getElementById('five-star-count').textContent = ratingStats.five_star;
                    document.getElementById('four-star-count').textContent = ratingStats.four_star;
                    document.getElementById('three-star-count').textContent = ratingStats.three_star;
                    document.getElementById('two-star-count').textContent = ratingStats.two_star;
                    document.getElementById('one-star-count').textContent = ratingStats.one_star;
                }
            } else {
                avgRatingEl.textContent = 'No ratings';
                totalReviewsEl.textContent = '0 reviews';
            }
            
            const reviewsList = document.getElementById('reviews-list');
            if (!reviewsList) return;
            
            if (reviews.length === 0) {
                reviewsList.innerHTML = '<div class="empty-state"><p>No reviews yet.</p></div>';
                return;
            }
            
            reviewsList.innerHTML = reviews.map(review => {
                const stars = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating);
                const date = new Date(review.created_at).toLocaleDateString();
                const reviewerInitials = review.reviewer_name.split(' ').map(n => n[0]).join('').toUpperCase();
                
                return `
                    <div class="card mb-10" style="padding: 16px;">
                        <div class="flex items-start gap-12">
                            <div class="cover-img" style="width: 48px; height: 48px; font-size: 18px;">${reviewerInitials}</div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-8">
                                    <div>
                                        <div style="font-weight: 600;">${escapeHtml(review.reviewer_name)}</div>
                                        <div class="subtle" style="font-size: 14px;">${date}</div>
                                    </div>
                                    <div style="color: #ffc107; font-size: 20px;">${stars}</div>
                                </div>
                                ${review.gig_title ? `<div class="subtle mb-8">For: ${escapeHtml(review.gig_title)}</div>` : ''}
                                ${review.comment ? `<p style="margin: 0; line-height: 1.6;">${escapeHtml(review.comment)}</p>` : '<p class="subtle">No comment provided.</p>'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Business profile photo upload functionality
        function setupBusinessProfilePhotoUpload() {
            const changePhotoBtn = document.getElementById('change-business-photo-btn');
            const photoInput = document.getElementById('business-photo-input');
            const uploadProgress = document.getElementById('business-upload-progress');
            const progressBar = document.getElementById('business-progress-bar');
            const profileAvatar = document.getElementById('business-profile-avatar');
            const profileImage = document.getElementById('business-profile-image');
            
            if (!changePhotoBtn || !photoInput) return;
            
            changePhotoBtn.addEventListener('click', () => {
                photoInput.click();
            });
            
            photoInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.type.startsWith('image/')) {
                    Toast.error('Please select an image file');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    Toast.error('File size must be less than 5MB');
                    return;
                }
                
                try {
                    const previewUrl = await FileUpload.previewImage(file);
                    if (profileImage) {
                        profileImage.src = previewUrl;
                        profileImage.style.display = 'block';
                        profileAvatar.textContent = '';
                    }
                    
                    uploadProgress.style.display = 'block';
                    progressBar.style.width = '0%';
                    changePhotoBtn.disabled = true;
                    Loading.setButtonLoading(changePhotoBtn, true);
                    
                    const response = await FileUpload.upload(file, 'profile', {
                        onProgress: (loaded, total) => {
                            const percent = Math.round((loaded / total) * 100);
                            progressBar.style.width = percent + '%';
                        }
                    });
                    
                    // Update profile image with the correct path
                    if (response.file_path && profileImage) {
                        // Construct the correct URL - handle the /funagig/ base path
                        let imageUrl = response.file_path;
                        if (!imageUrl.startsWith('http') && !imageUrl.startsWith('/funagig/')) {
                            // Add /funagig/ prefix if not already present
                            if (imageUrl.startsWith('/')) {
                                imageUrl = '/funagig' + imageUrl;
                            } else {
                                imageUrl = '/funagig/' + imageUrl;
                            }
                        }
                        
                        // Set image source with cache busting
                        const timestamp = new Date().getTime();
                        
                        // Clear avatar text first
                        profileAvatar.textContent = '';
                        profileAvatar.style.background = 'transparent';
                        
                        // Set up load handlers before setting src
                        profileImage.onload = function() {
                            console.log('Profile image loaded successfully:', imageUrl);
                            console.log('Image natural width:', profileImage.naturalWidth, 'height:', profileImage.naturalHeight);
                            
                            // Remove all text nodes from avatar
                            const textNodes = [];
                            const walker = document.createTreeWalker(
                                profileAvatar,
                                NodeFilter.SHOW_TEXT,
                                null,
                                false
                            );
                            let node;
                            while (node = walker.nextNode()) {
                                if (node.textContent.trim()) {
                                    textNodes.push(node);
                                }
                            }
                            textNodes.forEach(textNode => textNode.remove());
                            
                            // Clear all child text nodes
                            Array.from(profileAvatar.childNodes).forEach(child => {
                                if (child.nodeType === Node.TEXT_NODE) {
                                    child.remove();
                                }
                            });
                            
                            // Clear textContent completely
                            profileAvatar.textContent = '';
                            
                            // Ensure image is visible and on top with all necessary styles
                            profileImage.setAttribute('style', 
                                'display: block !important; ' +
                                'visibility: visible !important; ' +
                                'opacity: 1 !important; ' +
                                'z-index: 10 !important; ' +
                                'position: absolute !important; ' +
                                'top: 0 !important; ' +
                                'left: 0 !important; ' +
                                'width: 100% !important; ' +
                                'height: 100% !important; ' +
                                'object-fit: cover !important; ' +
                                'border-radius: 50% !important; ' +
                                'background: #fff !important;'
                            );
                            
                            // Clear avatar background and text
                            profileAvatar.style.background = 'transparent';
                            profileAvatar.style.color = 'transparent';
                            
                            // Force browser repaint
                            void profileAvatar.offsetHeight;
                            profileImage.offsetHeight;
                            
                            // Verify image is actually visible
                            const computedStyle = window.getComputedStyle(profileImage);
                            console.log('Computed display:', computedStyle.display);
                            console.log('Computed visibility:', computedStyle.visibility);
                            console.log('Computed opacity:', computedStyle.opacity);
                            console.log('Computed z-index:', computedStyle.zIndex);
                            console.log('Image complete:', profileImage.complete);
                            console.log('Image natural dimensions:', profileImage.naturalWidth, 'x', profileImage.naturalHeight);
                        };
                        
                        profileImage.onerror = function(e) {
                            console.error('Failed to load profile image:', imageUrl);
                            console.error('Trying alternative URLs...');
                            
                            // Try alternative URL formats
                            const alternatives = [
                                '/funagig/' + response.file_path,
                                '/' + response.file_path,
                                response.file_url,
                                'http://localhost/funagig/' + response.file_path
                            ];
                            
                            let altIndex = 0;
                            const tryNext = () => {
                                if (altIndex < alternatives.length && alternatives[altIndex]) {
                                    const altUrl = alternatives[altIndex] + '?t=' + timestamp;
                                    console.log('Trying alternative URL:', altUrl);
                                    profileImage.src = altUrl;
                                    altIndex++;
                                } else {
                                    // Fallback to initials if all URLs fail
                                    console.error('All image URLs failed, falling back to initials');
                                    profileImage.style.display = 'none';
                                    const user = Auth.getUser();
                                    if (user && profileAvatar) {
                                        const initials = user.name ? user.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'B';
                                        profileAvatar.textContent = initials;
                                        profileAvatar.style.background = '#e2e8f0';
                                    }
                                }
                            };
                            
                            // Set new error handler that tries next alternative
                            profileImage.onerror = tryNext;
                            tryNext();
                        };
                        
                        // Clear text immediately before setting image
                        profileAvatar.textContent = '';
                        profileAvatar.style.color = 'transparent';
                        
                        // Ensure image element is properly configured
                        profileImage.style.position = 'absolute';
                        profileImage.style.top = '0';
                        profileImage.style.left = '0';
                        profileImage.style.width = '100%';
                        profileImage.style.height = '100%';
                        profileImage.style.zIndex = '10';
                        
                        // Now set the image source
                        profileImage.src = imageUrl + '?t=' + timestamp;
                        profileImage.style.display = 'block';
                        profileImage.style.visibility = 'visible';
                        profileImage.style.opacity = '1';
                    }
                    
                    const user = Auth.getUser();
                    if (user) {
                        user.profile_image = response.file_path;
                        Auth.setUser(user);
                    }
                    
                    // Reload profile data to ensure consistency
                    await loadProfileData();
                    
                    Toast.success('Profile picture updated successfully');
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    Toast.error(error.message || 'Failed to upload profile picture');
                    
                    const user = Auth.getUser();
                    if (user && profileAvatar) {
                        const initials = user.name ? user.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'B';
                        profileAvatar.textContent = initials;
                        if (profileImage) {
                            profileImage.style.display = 'none';
                        }
                    }
                } finally {
                    uploadProgress.style.display = 'none';
                    progressBar.style.width = '0%';
                    changePhotoBtn.disabled = false;
                    Loading.setButtonLoading(changePhotoBtn, false);
                    photoInput.value = '';
                }
            });
        }
        
        function updateProfileInfo(user) {
            // Update company name in header
            const companyName = document.getElementById('profileCompanyName');
            if (companyName) {
                companyName.textContent = user.name || 'Business Name';
            }
            
            // Update industry
            const industryEl = document.getElementById('profileIndustry');
            if (industryEl) {
                industryEl.textContent = user.industry || 'No industry specified';
            }
            
            // Update verified badge
            const verifiedBadge = document.getElementById('verifiedBadge');
            if (verifiedBadge) {
                verifiedBadge.style.display = user.is_verified ? 'inline-block' : 'none';
            }
            
            // Update display fields
            const displayIndustry = document.getElementById('displayIndustry');
            const displayLocation = document.getElementById('displayLocation');
            const displayWebsite = document.getElementById('displayWebsite');
            const displayName = document.getElementById('displayName');
            const displayEmail = document.getElementById('displayEmail');
            const displayPhone = document.getElementById('displayPhone');
            const displayBio = document.getElementById('displayBio');
            const displaySkills = document.getElementById('displaySkills');
            
            if (displayIndustry) displayIndustry.textContent = user.industry || '-';
            if (displayLocation) displayLocation.textContent = user.location || '-';
            if (displayWebsite) {
                if (user.website) {
                    const websiteUrl = user.website.startsWith('http') ? user.website : `https://${user.website}`;
                    displayWebsite.innerHTML = `<a href="${escapeHtml(websiteUrl)}" target="_blank" style="color: var(--primary);">${escapeHtml(user.website)}</a>`;
                } else {
                    displayWebsite.textContent = '-';
                }
            }
            if (displayName) displayName.textContent = user.name || '-';
            if (displayEmail) displayEmail.textContent = user.email || '-';
            if (displayPhone) displayPhone.textContent = user.phone || '-';
            if (displayBio) {
                if (user.bio) {
                    displayBio.innerHTML = `<p style="margin: 0; line-height: 1.6; white-space: pre-wrap;">${escapeHtml(user.bio)}</p>`;
                } else {
                    displayBio.innerHTML = '<p class="subtle">No description provided.</p>';
                }
            }
            if (displaySkills) {
                if (user.skills) {
                    const skills = user.skills.split(',').map(s => s.trim()).filter(s => s);
                    displaySkills.innerHTML = skills.map(skill => 
                        `<span class="pill blue">${escapeHtml(skill)}</span>`
                    ).join('');
                } else {
                    displaySkills.innerHTML = '<span class="subtle">No skills specified.</span>';
                }
            }
            
            // Update avatar initials and image
            const avatar = document.getElementById('business-profile-avatar');
            const profileImage = document.getElementById('business-profile-image');
            if (avatar && user.name) {
                if (user.profile_image) {
                    // Show profile image if available
                    if (profileImage) {
                        // Construct image URL - handle both absolute and relative paths
                        let imageUrl = user.profile_image;
                        
                        // Normalize the URL to include /funagig/ prefix
                        if (imageUrl.startsWith('http://localhost/funagig/')) {
                            imageUrl = imageUrl.replace('http://localhost/funagig', '');
                        } else if (!imageUrl.startsWith('/funagig/') && !imageUrl.startsWith('http')) {
                            // Add /funagig/ prefix if not present
                            if (imageUrl.startsWith('/')) {
                                imageUrl = '/funagig' + imageUrl;
                            } else {
                                imageUrl = '/funagig/' + imageUrl;
                            }
                        }
                        
                        // Add cache busting timestamp
                        const timestamp = new Date().getTime();
                        profileImage.src = imageUrl + '?t=' + timestamp;
                        profileImage.style.display = 'block';
                        avatar.textContent = '';
                        
                        // Handle image load errors
                        profileImage.onerror = function() {
                            console.error('Failed to load profile image:', imageUrl);
                            // Try alternative paths
                            const altUrl = imageUrl.includes('/funagig/') 
                                ? imageUrl.replace('/funagig/', '/')
                                : '/funagig/' + imageUrl.replace(/^\//, '');
                            
                            console.log('Trying alternative URL:', altUrl);
                            profileImage.src = altUrl + '?t=' + timestamp;
                            
                            // If still fails, fallback to initials
                            profileImage.onerror = function() {
                                console.error('All image URLs failed');
                                profileImage.style.display = 'none';
                                const initials = user.name ? user.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'B';
                                avatar.textContent = initials;
                            };
                        };
                        
                        // Clear text immediately before loading
                        avatar.textContent = '';
                        avatar.style.color = 'transparent';
                        avatar.style.fontSize = '0';
                        
                        // Verify image loaded successfully
                        profileImage.onload = function() {
                            console.log('Profile image loaded successfully (initial load):', imageUrl);
                            
                            // Remove all text nodes
                            Array.from(avatar.childNodes).forEach(child => {
                                if (child.nodeType === Node.TEXT_NODE) {
                                    child.remove();
                                }
                            });
                            avatar.textContent = '';
                            
                            // Set image styles with !important to ensure visibility
                            profileImage.setAttribute('style', 
                                'display: block !important; ' +
                                'visibility: visible !important; ' +
                                'opacity: 1 !important; ' +
                                'z-index: 999 !important; ' +
                                'position: absolute !important; ' +
                                'top: 0 !important; ' +
                                'left: 0 !important; ' +
                                'width: 100% !important; ' +
                                'height: 100% !important; ' +
                                'object-fit: cover !important; ' +
                                'border-radius: 50% !important;'
                            );
                            
                            avatar.style.background = 'transparent';
                            avatar.style.color = 'transparent';
                            avatar.style.fontSize = '0';
                            
                            // Force repaint
                            void avatar.offsetHeight;
                            void profileImage.offsetHeight;
                        };
                    }
                } else {
                    // Show initials
                    const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
                    avatar.textContent = initials;
                    if (profileImage) {
                        profileImage.style.display = 'none';
                    }
                }
            }
            
        }
        
        function populateEditForm(user) {
            document.getElementById('editCompanyName').value = user.name || '';
            document.getElementById('editIndustry').value = user.industry || 'technology';
            document.getElementById('editLocation').value = user.location || '';
            document.getElementById('editWebsite').value = user.website || '';
            document.getElementById('editPhone').value = user.phone || '';
            document.getElementById('editDescription').value = user.bio || '';
            document.getElementById('editSkills').value = user.skills || '';
        }
        
        async function loadBusinessStats() {
            try {
                const response = await apiFetch('/dashboard');
                if (response.success && response.stats) {
                    updateBusinessStats(response.stats);
                }
            } catch (error) {
                console.error('Failed to load business stats:', error);
                // Don't show error - keep static data
            }
        }
        
        function updateBusinessStats(stats) {
            const activeGigs = document.getElementById('profileActiveGigs');
            const totalApplicants = document.getElementById('profileTotalApplicants');
            const hiredStudents = document.getElementById('profileHiredStudents');
            const averageRating = document.getElementById('profileStatsRating');
            const profileAverageRating = document.getElementById('profileAverageRating');
            const profileTotalReviews = document.getElementById('profileTotalReviews');
            
            if (activeGigs) activeGigs.textContent = stats.active_gigs || 0;
            if (totalApplicants) totalApplicants.textContent = stats.total_applicants || 0;
            if (hiredStudents) hiredStudents.textContent = stats.hired_students || 0;
            if (averageRating) {
                if (stats.average_rating && stats.average_rating > 0) {
                    averageRating.textContent = stats.average_rating.toFixed(1);
                } else {
                    averageRating.textContent = '-';
                }
            }
            if (profileAverageRating) {
                if (stats.average_rating && stats.average_rating > 0) {
                    profileAverageRating.textContent = `${stats.average_rating.toFixed(1)}/5`;
                } else {
                    profileAverageRating.textContent = '-';
                }
            }
            if (profileTotalReviews) {
                if (stats.total_reviews > 0) {
                    profileTotalReviews.textContent = `Based on ${stats.total_reviews} review${stats.total_reviews !== 1 ? 's' : ''}`;
                } else {
                    profileTotalReviews.textContent = 'No reviews yet';
                }
            }
        }
        
        // Setup modal to close when clicking outside
        function setupModalClose() {
            const modal = document.getElementById('editModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeEditModal();
                    }
                });
            }
        }
        
        // Edit profile functionality
        function editProfile() {
            // Load current user data to populate form
            const user = Auth.getUser();
            if (user) {
                populateEditForm(user);
            }
            document.getElementById('editModal').style.display = 'block';
        }
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        
        // Validation helper functions
        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }
        
        function validatePhone(phone) {
            if (!phone) return true; // Phone is optional
            // Allow + prefix and 10-15 digits
            return /^\+?[0-9]{10,15}$/.test(phone.replace(/[\s-]/g, ''));
        }
        
        function validateWebsite(website) {
            if (!website) return true; // Website is optional
            try {
                const url = new URL(website);
                return url.protocol === 'http:' || url.protocol === 'https:';
            } catch {
                // If URL constructor fails, try adding protocol
                try {
                    const url = new URL('https://' + website);
                    return true;
                } catch {
                    return false;
                }
            }
        }
        
        // Setup real-time validation for edit form
        function setupBusinessProfileValidation() {
            const websiteInput = document.getElementById('editWebsite');
            const phoneInput = document.getElementById('editPhone');
            
            if (websiteInput) {
                websiteInput.addEventListener('blur', function() {
                    const value = this.value.trim();
                    if (value && !validateWebsite(value)) {
                        this.classList.add('error');
                        Toast.error('Please enter a valid website URL (e.g., https://example.com)');
                    } else {
                        this.classList.remove('error');
                    }
                });
            }
            
            if (phoneInput) {
                phoneInput.addEventListener('blur', function() {
                    const value = this.value.trim();
                    if (value && !validatePhone(value)) {
                        this.classList.add('error');
                        Toast.error('Please enter a valid phone number (e.g., +256 700 123 456)');
                    } else {
                        this.classList.remove('error');
                    }
                });
            }
        }
        
        // Handle edit profile form submission
        document.getElementById('editProfileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
            
            const formData = {
                    name: document.getElementById('editCompanyName').value.trim(),
                    industry: document.getElementById('editIndustry').value,
                    location: document.getElementById('editLocation').value.trim(),
                    website: document.getElementById('editWebsite').value.trim(),
                    phone: document.getElementById('editPhone').value.trim(),
                    bio: document.getElementById('editDescription').value.trim(),
                    skills: document.getElementById('editSkills').value.trim()
                };
                
                // Validate
                if (!formData.name) {
                    showNotification('Company name is required', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
                
                if (formData.website && !validateWebsite(formData.website)) {
                    showNotification('Please enter a valid website URL (e.g., https://example.com)', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
                
                if (formData.phone && !validatePhone(formData.phone)) {
                    showNotification('Please enter a valid phone number (e.g., +256 700 123 456)', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
                
                const response = await apiFetch('/profile', {
                method: 'POST',
                body: JSON.stringify(formData)
                });
                
                if (response.success) {
                    Toast.success('Profile updated successfully!');
                    
                    closeEditModal();
                    
                    // Reload profile data from API to get updated info
                    await loadProfileData();
                    
                    // Reload business stats
                    await loadBusinessStats();
                } else {
                    showNotification(response.error || 'Failed to update profile', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            } catch (error) {
                console.error('Profile update error:', error);
                showNotification('Failed to update profile. Please try again.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>

</html>