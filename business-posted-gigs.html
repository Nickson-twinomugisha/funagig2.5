<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>My Gigs - FunaGig</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <header class="navbar">
        <div class="brand">
            <div class="logo"></div> FunaGig
        </div>
    </header>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="title" style="display:flex; align-items:center; gap:10px;">
                <div class="cover-img" style="width:36px;height:36px;">TS</div> Tech Solutions Inc.
            </div>
            <nav class="navlist">
                <a class="navitem" href="business-dashboard.html">Dashboard</a>
                <a class="navitem" href="business-post-gig.html">Post Gig</a>
                <a class="navitem active" href="business-posted-gigs.html">My Gigs</a>
                <a class="navitem" href="business-applicants.html">Applicants</a>
                <a class="navitem" href="business-messaging.html">Messages</a>
                <a class="navitem" href="business-profile.html">Profile</a>
                <a class="navitem" href="#" onclick="Auth.logout(); return false;">Log out</a>
            </nav>
        </aside>
        <main class="content">
            <div class="flex items-center justify-between mb-20">
                <div>
                    <h1 class="h1" style="font-size:28px; margin:0;">My Gigs</h1>
                    <p class="subtle">Manage and track all your posted gigs</p>
                </div>
                <div class="flex gap-10">
                    <a href="business-post-gig.html" class="btn">Post New Gig</a>
                    <a href="business-dashboard.html" class="btn secondary">Back to Dashboard</a>
                </div>
            </div>

            <!-- Filter and Search -->
            <div class="section mb-20">
                <div class="flex items-center gap-10" style="flex-wrap: wrap;">
                    <div class="field" style="flex: 1; min-width: 200px;">
                        <input type="text" class="input" placeholder="Search gigs..." id="searchInput">
                    </div>
                    <div class="field">
                        <select class="select" id="statusFilter">
                            <option value="">All Status</option>
                            <option value="draft">Drafts</option>
                            <option value="active">Active</option>
                            <option value="paused">Paused</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="field">
                        <select class="select" id="sortBy">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="budget_high">Budget: High to Low</option>
                            <option value="budget_low">Budget: Low to High</option>
                            <option value="title_asc">Title: A to Z</option>
                            <option value="title_desc">Title: Z to A</option>
                            <option value="applicants_high">Most Applicants</option>
                            <option value="applicants_low">Least Applicants</option>
                        </select>
                    </div>
                    <button class="btn secondary">Filter</button>
                </div>
            </div>

            <!-- Gigs List -->
            <div class="section">
                <h2 class="h2 mb-20">All Gigs</h2>
                <div id="gigsList">
                    <!-- Sample Gig Cards -->
                    <div class="card-compact mb-20">
                        <div class="flex items-center justify-between">
                            <div style="flex: 1;">
                                <div class="flex items-center gap-10 mb-10">
                                    <h3 style="margin: 0; font-size: 18px;">Website Development</h3>
                                    <span class="pill green">Active</span>
                                </div>
                                <p class="subtle mb-10">Need a modern website for our startup. Must be responsive and SEO-friendly.</p>
                                <div class="flex items-center gap-20" style="flex-wrap: wrap;">
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Budget:</span>
                                        <span style="font-weight: 600;">sh.500,000</span>
                                    </div>
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Deadline:</span>
                                        <span>Dec 31, 2024</span>
                                    </div>
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Applications:</span>
                                        <span style="font-weight: 600;">5</span>
                                    </div>
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Type:</span>
                                        <span>One-time</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-10" style="flex-direction: column;">
                                <a href="business-applicants.html?gig=1" class="btn secondary">View Applicants</a>
                                <button class="btn ghost">Edit</button>
                                <button class="btn ghost" style="color: var(--danger);">Delete</button>
                            </div>
                        </div>
                    </div>

                    <div class="card-compact mb-20">
                        <div class="flex items-center justify-between">
                            <div style="flex: 1;">
                                <div class="flex items-center gap-10 mb-10">
                                    <h3 style="margin: 0; font-size: 18px;">Social Media Management</h3>
                                    <span class="pill yellow">Paused</span>
                                </div>
                                <p class="subtle mb-10">Manage our social media accounts and create engaging content.</p>
                                <div class="flex items-center gap-20" style="flex-wrap: wrap;">
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Budget:</span>
                                        <span style="font-weight: 600;">sh.200,000</span>
                                    </div>
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Deadline:</span>
                                        <span>Dec 15, 2024</span>
                                    </div>
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Applications:</span>
                                        <span style="font-weight: 600;">3</span>
                                    </div>
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Type:</span>
                                        <span>Ongoing</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-10" style="flex-direction: column;">
                                <a href="business-applicants.html?gig=2" class="btn secondary">View Applicants</a>
                                <button class="btn ghost">Edit</button>
                                <button class="btn ghost" style="color: var(--danger);">Delete</button>
                            </div>
                        </div>
                    </div>

                    <div class="card-compact mb-20">
                        <div class="flex items-center justify-between">
                            <div style="flex: 1;">
                                <div class="flex items-center gap-10 mb-10">
                                    <h3 style="margin: 0; font-size: 18px;">Mobile App Development</h3>
                                    <span class="pill green">Active</span>
                                </div>
                                <p class="subtle mb-10">Develop a cross-platform mobile app for our business.</p>
                                <div class="flex items-center gap-20" style="flex-wrap: wrap;">
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Budget:</span>
                                        <span style="font-weight: 600;">sh.1,500,000</span>
                                    </div>
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Deadline:</span>
                                        <span>Jan 31, 2025</span>
                                    </div>
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Applications:</span>
                                        <span style="font-weight: 600;">8</span>
                                    </div>
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Type:</span>
                                        <span>Contract</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-10" style="flex-direction: column;">
                                <a href="business-applicants.html?gig=3" class="btn secondary">View Applicants</a>
                                <button class="btn ghost">Edit</button>
                                <button class="btn ghost" style="color: var(--danger);">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" style="display: none; text-align: center; padding: 40px;">
                    <p class="subtle" style="font-size: 18px;">No gigs found</p>
                    <a href="business-post-gig.html" class="btn mt-10">Post Your First Gig</a>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Gig Modal -->
    <div id="editGigModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">Edit Gig</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editGigForm" onsubmit="submitEditGig(event)">
                    <input type="hidden" id="editGigId">
                    
                    <div class="field">
                        <label class="label">Gig Title *</label>
                        <input type="text" id="editGigTitle" class="input" required>
                    </div>
                    
                    <div class="field">
                        <label class="label">Description *</label>
                        <textarea id="editGigDescription" class="textarea" rows="4" required></textarea>
                    </div>
                    
                    <div class="form-grid">
                        <div class="field">
                            <label class="label">Type *</label>
                            <select id="editGigType" class="select" required>
                                <option value="one-time">One-time</option>
                                <option value="ongoing">Ongoing</option>
                                <option value="contract">Contract</option>
                            </select>
                        </div>
                        
                        <div class="field">
                            <label class="label">Status *</label>
                            <select id="editGigStatus" class="select" required>
                                <option value="draft">Draft</option>
                                <option value="active">Active</option>
                                <option value="paused">Paused</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="field">
                        <label class="label">Required Skills *</label>
                        <textarea id="editGigSkills" class="textarea" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-grid">
                        <div class="field">
                            <label class="label">Budget (UGX) *</label>
                            <input type="number" id="editGigBudget" class="input" min="0" required>
                        </div>
                        
                        <div class="field">
                            <label class="label">Deadline *</label>
                            <input type="date" id="editGigDeadline" class="input" required>
                        </div>
                    </div>
                    
                    <div class="field">
                        <label class="label">Location</label>
                        <input type="text" id="editGigLocation" class="input" placeholder="e.g., Remote, Kampala">
                    </div>
                    
                    <div class="form-navigation mt-20">
                        <button type="button" class="btn ghost" onclick="closeEditModal()">Cancel</button>
                        <button type="submit" class="btn">Update Gig</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let allGigs = []; // Store all gigs for filtering
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentSort = 'newest';
        
        // Load user data and update sidebar
        document.addEventListener('DOMContentLoaded', async function() {
            // Verify session and check user type
            if (!Auth.requireUserType('business')) {
                return;
            }
            
            // Verify session is still valid
            const user = await Auth.verifySession();
            if (!user) {
                return; // verifySession already handles logout/redirect
            }
            
            if (user) {
                
                const userName = user.name;
                const userInitials = userName.split(' ').map(n => n[0]).join('').toUpperCase();
                
                const sidebarTitle = document.querySelector('.sidebar .title');
                if (sidebarTitle) {
                    sidebarTitle.innerHTML = `<div class="cover-img" style="width:36px;height:36px;">${escapeHtml(userInitials)}</div> ${escapeHtml(userName)}`;
                }
                
                // Load gigs from API
                loadGigs();
                
                // Setup search and filter
                setupSearchAndFilter();
                
                // Setup modal close on outside click
                setupModalClose();
                
                // Set minimum date for edit deadline
                const editDeadline = document.getElementById('editGigDeadline');
                if (editDeadline) {
                    const today = new Date().toISOString().split('T')[0];
                    editDeadline.setAttribute('min', today);
                }
            }
        });
        
        // Setup modal to close when clicking outside
        function setupModalClose() {
            const modal = document.getElementById('editGigModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeEditModal();
                    }
                });
            }
        }
        
        // Load gigs from API (including drafts)
        async function loadGigs() {
            const gigsList = document.getElementById('gigsList');
            if (!gigsList) return;
            
            // Show loading state
            Loading.show(gigsList, 'Loading gigs...');
            
            try {
                // Include drafts in the request
                const response = await apiFetch('/gigs/active?include_drafts=true');
                Loading.hide(gigsList);
                
                if (response.success && response.gigs) {
                    allGigs = response.gigs;
                    if (allGigs.length === 0) {
                        EmptyState.show(
                            gigsList,
                            'üìã',
                            'No Gigs Posted Yet',
                            'You haven\'t posted any gigs yet. Create your first gig to start connecting with students.',
                            '<a href="business-post-gig.html" class="btn">Post Your First Gig</a>'
                        );
                    } else {
                        displayGigs(allGigs, true);
                    }
                } else {
                    EmptyState.show(
                        gigsList,
                        '‚ö†Ô∏è',
                        'Unable to Load Gigs',
                        'There was an error loading your gigs. Please try refreshing the page.',
                        '<button class="btn" onclick="loadGigs()">Retry</button>'
                    );
                }
            } catch (error) {
                Loading.hide(gigsList);
                console.error('Failed to load gigs:', error);
                EmptyState.show(
                    gigsList,
                    '‚ö†Ô∏è',
                    'Unable to Load Gigs',
                    'There was an error loading your gigs. Please check your connection and try again.',
                    '<button class="btn" onclick="loadGigs()">Retry</button>'
                );
            }
        }
        
        // Display gigs in the list with pagination
        function displayGigs(gigs, resetPage = false) {
            const gigsList = document.getElementById('gigsList');
            const emptyState = document.getElementById('emptyState');
            
            if (!gigsList) return;
            
            // Reset to first page when filtering
            if (resetPage) {
                currentPage = 1;
            }
            
            if (!gigs || gigs.length === 0) {
                EmptyState.show(
                    gigsList,
                    'üìã',
                    'No Gigs Found',
                    'No gigs match your current filters. Try adjusting your search or filters.',
                    '<button class="btn secondary" onclick="document.getElementById(\'searchInput\').value=\'\'; document.getElementById(\'statusFilter\').value=\'\'; filterGigs();">Clear Filters</button>'
                );
                // Remove pagination if it exists
                const existingPagination = document.getElementById('gigsPagination');
                if (existingPagination) existingPagination.remove();
                return;
            }
            
            // Hide empty state if it exists
            if (emptyState) emptyState.style.display = 'none';
            gigsList.style.display = 'block';
            
            // Paginate the results
            const paginated = Pagination.paginate(gigs, currentPage, itemsPerPage);
            
            // Generate gig cards for current page
            gigsList.innerHTML = paginated.data.map(gig => {
                const statusColors = {
                    'draft': 'gray',
                    'active': 'green',
                    'paused': 'yellow',
                    'completed': 'blue',
                    'cancelled': 'red'
                };
                
                const statusColor = statusColors[gig.status] || 'yellow';
                const isDraft = gig.status === 'draft';
                const deadline = new Date(gig.deadline).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                return `
                    <div class="card-compact mb-20">
                        <div class="flex items-center justify-between" style="flex-wrap: wrap; gap: 16px;">
                            <div style="flex: 1; min-width: 300px;">
                                <div class="flex items-center gap-10 mb-10" style="flex-wrap: wrap;">
                                    <h3 style="margin: 0; font-size: 18px;">${escapeHtml(gig.title || 'Untitled Gig')}</h3>
                                    <span class="pill ${statusColor}">${gig.status || 'active'}</span>
                                </div>
                                <p class="subtle mb-10">${escapeHtml((gig.description || '').substring(0, 150))}${(gig.description || '').length > 150 ? '...' : ''}</p>
                                <div class="flex items-center gap-20" style="flex-wrap: wrap;">
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Budget:</span>
                                        <span style="font-weight: 600;">sh.${parseInt(gig.budget || 0).toLocaleString()}</span>
                                    </div>
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Deadline:</span>
                                        <span>${deadline}</span>
                                    </div>
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Applications:</span>
                                        <span style="font-weight: 600;">${gig.applicant_count || 0}</span>
                                    </div>
                                    <div class="flex items-center gap-5">
                                        <span class="subtle">Type:</span>
                                        <span>${formatGigType(gig.type || 'one-time')}</span>
                                    </div>
                                </div>
                                ${gig.skills ? `<div class="mt-10"><span class="subtle">Skills: </span>${escapeHtml(gig.skills)}</div>` : ''}
                            </div>
                            <div class="flex gap-10" style="flex-direction: column;">
                                ${isDraft ? `
                                    <button class="btn" onclick="publishDraft(${gig.id}, '${escapeHtml(gig.title)}')">Publish</button>
                                    <button class="btn ghost" onclick="editGig(${gig.id})">Edit</button>
                                    <button class="btn ghost" style="color: var(--danger);" onclick="deleteGig(${gig.id}, '${escapeHtml(gig.title)}')">Delete</button>
                                ` : `
                                    <a href="business-applicants.html?gig=${gig.id}" class="btn secondary">View Applicants</a>
                                    <button class="btn ghost" onclick="editGig(${gig.id})">Edit</button>
                                    <button class="btn ghost" style="color: var(--danger);" onclick="deleteGig(${gig.id}, '${escapeHtml(gig.title)}')">Delete</button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Remove existing pagination
            const existingPagination = document.getElementById('gigsPagination');
            if (existingPagination) existingPagination.remove();
            
            // Add pagination if needed
            if (paginated.totalPages > 1) {
                const paginationContainer = Pagination.create(
                    currentPage,
                    paginated.totalPages,
                    (page) => {
                        currentPage = page;
                        displayGigs(gigs, false);
                        // Scroll to top of list
                        gigsList.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                );
                paginationContainer.id = 'gigsPagination';
                gigsList.parentElement.appendChild(paginationContainer);
            }
        }
        
        // Handle page change
        function changePage(page) {
            currentPage = page;
            filterGigs();
        }
        
        // Setup search and filter functionality
        function setupSearchAndFilter() {
            const searchInput = document.getElementById('searchInput');
            const statusFilter = document.getElementById('statusFilter');
            const sortBy = document.getElementById('sortBy');
            const filterBtn = document.querySelector('.btn.secondary');
            
            // Load state from URL on page load
            const urlSearch = URLState.get('search', '');
            const urlStatus = URLState.get('status', '');
            const urlSort = URLState.get('sort', 'newest');
            
            if (urlSearch && searchInput) {
                searchInput.value = urlSearch;
            }
            if (urlStatus && statusFilter) {
                statusFilter.value = urlStatus;
            }
            if (urlSort && sortBy) {
                sortBy.value = urlSort;
                currentSort = urlSort;
            }
            
            // Search functionality with debouncing and loading indicator
            if (searchInput) {
                const gigsList = document.getElementById('gigsList');
                const debouncedFilter = Debounce.create(() => {
                    // Update URL with search term
                    URLState.set('search', searchInput.value || null);
                    filterGigs();
                }, 300, {
                    showLoading: true,
                    loadingElement: searchInput
                });
                
                searchInput.addEventListener('input', debouncedFilter);
            }
            
            // Status filter
            if (statusFilter) {
                statusFilter.addEventListener('change', function() {
                    // Update URL with status filter
                    URLState.set('status', this.value || null);
                    filterGigs();
                });
            }
            
            // Sort functionality
            if (sortBy) {
                sortBy.addEventListener('change', function() {
                    currentSort = this.value;
                    // Update URL with sort option
                    URLState.set('sort', this.value || null);
                    filterGigs();
                });
            }
            
            // Filter button (if needed for future advanced filters)
            if (filterBtn) {
                filterBtn.addEventListener('click', function() {
                    filterGigs();
                });
            }
            
            // Watch for URL changes (browser back/forward)
            URLState.watch(() => {
                const urlSearch = URLState.get('search', '');
                const urlStatus = URLState.get('status', '');
                const urlSort = URLState.get('sort', 'newest');
                
                if (searchInput && urlSearch !== searchInput.value) {
                    searchInput.value = urlSearch;
                }
                if (statusFilter && urlStatus !== statusFilter.value) {
                    statusFilter.value = urlStatus;
                }
                if (sortBy && urlSort !== sortBy.value) {
                    sortBy.value = urlSort;
                    currentSort = urlSort;
                }
                
                filterGigs();
            });
        }
        
        // Sort gigs based on selected sort option
        function sortGigs(gigs) {
            if (!gigs || gigs.length === 0) return gigs;
            
            let sorted = [...gigs];
            
            switch (currentSort) {
                case 'newest':
                    sorted = Sort.byDate(sorted, 'created_at', 'desc');
                    break;
                case 'oldest':
                    sorted = Sort.byDate(sorted, 'created_at', 'asc');
                    break;
                case 'budget_high':
                    sorted = Sort.byNumber(sorted, 'budget', 'desc');
                    break;
                case 'budget_low':
                    sorted = Sort.byNumber(sorted, 'budget', 'asc');
                    break;
                case 'title_asc':
                    sorted = Sort.byString(sorted, 'title', 'asc');
                    break;
                case 'title_desc':
                    sorted = Sort.byString(sorted, 'title', 'desc');
                    break;
                case 'applicants_high':
                    sorted = Sort.byNumber(sorted, 'applicant_count', 'desc');
                    break;
                case 'applicants_low':
                    sorted = Sort.byNumber(sorted, 'applicant_count', 'asc');
                    break;
                default:
                    sorted = Sort.byDate(sorted, 'created_at', 'desc');
            }
            
            return sorted;
        }
        
        // Filter gigs based on search and status
        function filterGigs() {
            const searchTerm = (document.getElementById('searchInput')?.value || '').toLowerCase();
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            
            let filtered = allGigs;
            
            // Filter by status
            if (statusFilter) {
                filtered = filtered.filter(gig => gig.status === statusFilter);
            }
            
            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(gig => {
                    const title = (gig.title || '').toLowerCase();
                    const description = (gig.description || '').toLowerCase();
                    const skills = (gig.skills || '').toLowerCase();
                    return title.includes(searchTerm) || 
                           description.includes(searchTerm) || 
                           skills.includes(searchTerm);
                });
            }
            
            // Sort the filtered results
            filtered = sortGigs(filtered);
            
            displayGigs(filtered, true); // Reset to page 1 when filtering
        }
        
        // Format gig type for display
        function formatGigType(type) {
            const types = {
                'one-time': 'One-time',
                'ongoing': 'Ongoing',
                'contract': 'Contract'
            };
            return types[type] || type;
        }
        
        // Edit gig - open modal with form
        function editGig(gigId) {
            const gig = allGigs.find(g => g.id === gigId);
            if (!gig) {
                showNotification('Gig not found', 'error');
                return;
            }
            
            // Populate edit form
            document.getElementById('editGigId').value = gig.id;
            document.getElementById('editGigTitle').value = gig.title || '';
            document.getElementById('editGigDescription').value = gig.description || '';
            document.getElementById('editGigType').value = gig.type || 'one-time';
            document.getElementById('editGigSkills').value = gig.skills || '';
            document.getElementById('editGigBudget').value = gig.budget || '';
            document.getElementById('editGigDeadline').value = gig.deadline ? gig.deadline.split(' ')[0] : '';
            document.getElementById('editGigLocation').value = gig.location || '';
            document.getElementById('editGigStatus').value = gig.status || 'active';
            
            // Show modal
            document.getElementById('editGigModal').style.display = 'block';
        }
        
        // Delete gig
        async function deleteGig(gigId, gigTitle) {
            const confirmed = await Confirm.delete(
                `Are you sure you want to delete "${gigTitle}"?\n\nThis action cannot be undone and will remove all associated applications.`
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                const response = await apiFetch('/gigs/delete', {
                    method: 'POST',
                    body: JSON.stringify({
                        gig_id: gigId
                    })
                });
                
                if (response.success) {
                    showNotification(`"${gigTitle}" has been deleted successfully.`, 'success');
                    
                    // Reload gigs
                    await loadGigs();
                } else {
                    showNotification('Failed to delete gig. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error deleting gig:', error);
                showNotification('Failed to delete gig. Please try again.', 'error');
            }
        }
        
        // Close edit modal
        function closeEditModal() {
            document.getElementById('editGigModal').style.display = 'none';
        }
        
        // Submit edit form
        async function submitEditGig(e) {
            e.preventDefault();
            
            const submitBtn = document.querySelector('#editGigForm button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            try {
                // Disable submit button
                submitBtn.disabled = true;
                submitBtn.textContent = 'Updating...';
                
                const gigData = {
                    gig_id: parseInt(document.getElementById('editGigId').value),
                    title: document.getElementById('editGigTitle').value.trim(),
                    description: document.getElementById('editGigDescription').value.trim(),
                    type: document.getElementById('editGigType').value,
                    skills: document.getElementById('editGigSkills').value.trim(),
                    budget: parseFloat(document.getElementById('editGigBudget').value),
                    deadline: document.getElementById('editGigDeadline').value,
                    location: document.getElementById('editGigLocation').value.trim() || 'Remote',
                    status: document.getElementById('editGigStatus').value
                };
                
                // Validate
                if (!gigData.title || !gigData.description || !gigData.budget || !gigData.deadline) {
                    showNotification('Please fill in all required fields', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
                
                const response = await apiFetch('/gigs/update', {
                    method: 'POST',
                    body: JSON.stringify(gigData)
                });
                
                if (response.success) {
                    showNotification('Gig updated successfully!', 'success');
                    closeEditModal();
                    await loadGigs();
                } else {
                    showNotification('Failed to update gig. Please try again.', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            } catch (error) {
                console.error('Error updating gig:', error);
                showNotification('Failed to update gig. Please try again.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }
        
        // Publish a draft gig
        async function publishDraft(gigId, gigTitle) {
            if (!confirm(`Are you sure you want to publish "${gigTitle}"? This will make it visible to all students.`)) {
                return;
            }
            
            try {
                // First, get the draft gig details
                const getResponse = await apiFetch(`/gigs/${gigId}`);
                
                if (!getResponse.success || !getResponse.gig) {
                    Toast.error('Failed to load draft details');
                    return;
                }
                
                const draft = getResponse.gig;
                
                // Validate that required fields are filled
                if (!draft.title || draft.title === 'Untitled Draft' || !draft.description || !draft.budget || !draft.deadline) {
                    Toast.error('Please complete all required fields (title, description, budget, deadline) before publishing.');
                    return;
                }
                
                // Validate deadline is in the future
                const deadlineDate = new Date(draft.deadline);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (deadlineDate <= today) {
                    Toast.error('Please set a future deadline before publishing.');
                    return;
                }
                
                // Update the gig status to 'active' - send all required fields
                const updateResponse = await apiFetch('/gigs/update', {
                    method: 'POST',
                    body: JSON.stringify({
                        gig_id: gigId,
                        title: draft.title,
                        description: draft.description,
                        budget: parseFloat(draft.budget),
                        deadline: draft.deadline,
                        type: draft.type || 'one-time',
                        skills: draft.skills || '',
                        location: draft.location || 'Remote',
                        status: 'active'
                    })
                });
                
                if (updateResponse.success) {
                    Toast.success('Gig published successfully!');
                    await loadGigs();
                } else {
                    Toast.error(updateResponse.error || 'Failed to publish gig');
                }
            } catch (error) {
                console.error('Error publishing draft:', error);
                Toast.error('Failed to publish gig. Please try again.');
            }
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

