<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login - FunaGig</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="app.js"></script>
</head>

<body>
    <header class="navbar">
        <div class="brand">
            <div class="logo"></div> FunaGig
        </div>
        <nav class="nav-actions">
            <a class="btn ghost" href="index.html">Home</a>
            <a class="btn" href="signup.html">Sign Up</a>
        </nav>
    </header>

    <main class="auth-wrap">
        <form class="card card-lg" id="login-form">
            <h1 class="h1" style="font-size:32px; text-align:center;">Welcome back</h1>
            <p class="subtle mb-10" style="text-align:center;">Sign in to access your dashboard</p>
            
            <div class="field">
                <label class="label">Email *</label>
                <input class="input" id="email" name="email" placeholder="Enter your email" required />
                <div class="error-message" id="emailError"></div>
            </div>
            
            <div class="field">
                <label class="label">Password *</label>
                <input type="password" class="input" id="password" name="password" placeholder="Enter your password" required />
                <div class="error-message" id="passwordError"></div>
            </div>
            
            <div class="flex items-center justify-between mb-10">
                <label class="label" style="display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" id="rememberMe" name="rememberMe" />
                    Remember me
                </label>
                <a href="forgot-password.html" style="color: var(--primary);">Forgot password?</a>
            </div>
            
            <button type="submit" class="btn" style="width: 100%;">Log in</button>
            
            <div class="section mt-20" style="text-align:center;">
                <p class="subtle">Don't have an account? 
                    <a href="signup.html" style="color: var(--primary);">Create one now</a>
                </p>
            </div>
            
            <div class="section mt-20" style="text-align:center;">
                <p class="subtle">Or continue with:</p>
                <div class="row" style="margin-top: 10px;">
                    <button type="button" class="btn secondary" style="flex: 1;">Google</button>
                    <button type="button" class="btn secondary" style="flex: 1;">Facebook</button>
                </div>
            </div>
        </form>
    </main>

    <script>
        // Wait for DOM and app.js to be ready
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure apiFetch is available
            if (typeof apiFetch === 'undefined') {
                console.error('apiFetch is not defined. Make sure app.js is loaded.');
                return;
            }
            
            document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            clearErrors();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            
            let isValid = true;
            
            if (!email) {
                showError('emailError', 'Email is required');
                isValid = false;
            } else if (!isValidEmail(email)) {
                showError('emailError', 'Please enter a valid email address');
                isValid = false;
            }
            
            if (!password) {
                showError('passwordError', 'Password is required');
                isValid = false;
            }
            
            if (isValid) {
                const loginData = {
                    email: email,
                    password: password,
                    rememberMe: rememberMe,
                    loginTime: new Date().toISOString()
                };
                
                // Use apiFetch from app.js
                apiFetch('/login', {
                    method: 'POST',
                    body: JSON.stringify(loginData)
                })
                .then(response => {
                    // Backend returns user type and status
                    if (response.success) {
                        // Store user data properly
                        localStorage.setItem('user', JSON.stringify(response.user));
                        localStorage.setItem('userType', response.userType);
                        localStorage.setItem('isLoggedIn', 'true');
                        
                        // Store CSRF token if provided
                        if (response.csrf_token && typeof CSRF !== 'undefined') {
                            CSRF.token = response.csrf_token;
                        }
                        
                        // Also use Auth utility if available
                        if (typeof Auth !== 'undefined' && Auth.setUser) {
                            Auth.setUser(response.user);
                        }
                        
                        // Redirect based on user type
                        if (response.userType === 'business') {
                            window.location.href = 'business-dashboard.html';
                        } else if (response.userType === 'student') {
                            window.location.href = 'student-dashboard.html';
                        } else {
                            showError('emailError', 'Unknown user type. Please contact support.');
                        }
                    } else {
                        showError('emailError', response.error || 'Login failed');
                    }
                })
                .catch(error => {
                    showError('emailError', 'Error: Could not connect to server');
                    console.error('Login error:', error);
                });
            }
            });
        });
        
        function clearErrors() {
            const errorElements = document.querySelectorAll('.error-message');
            errorElements.forEach(element => {
                element.textContent = '';
                element.style.display = 'none';
            });
        }
        
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            errorElement.style.color = 'var(--danger)';
            errorElement.style.fontSize = '12px';
            errorElement.style.marginTop = '4px';
        }
        
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
    </script>
</body>
</html>
