<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Browse Gigs - FunaGig</title>
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <header class="navbar">
        <div class="brand">
            <div class="logo"></div> FunaGig
        </div>
        <nav class="nav-actions">
            <a class="btn ghost" href="index.html">Home</a>
            <a class="btn ghost" href="index.html#contact">Contact</a>
            <a class="btn" href="signup.html">Get Started</a>
        </nav>
    </header>

    <main class="container" style="display:grid; grid-template-columns: 260px 1fr; gap:20px;">
        <aside class="section">
            <h3>Filters</h3>
            <div class="field">
                <label>Search</label>
                <input type="text" id="searchInput" placeholder="Search gigs..." />
            </div>
            <div class="field">
                <label>Type</label>
                <select id="typeFilter">
                    <option value="">Any</option>
                    <option value="one-time">One-time</option>
                    <option value="ongoing">Ongoing</option>
                    <option value="contract">Contract</option>
                </select>
            </div>
            <div class="field">
                <label>Location</label>
                <input type="text" id="locationFilter" placeholder="e.g., Remote, Kampala" />
            </div>
            <div class="field">
                <label>Budget Min (UGX)</label>
                <input type="number" id="budgetMin" placeholder="Min" min="0" />
            </div>
            <div class="field">
                <label>Budget Max (UGX)</label>
                <input type="number" id="budgetMax" placeholder="Max" min="0" />
            </div>
            <button class="btn" style="width:100%;" onclick="applyFilters()">Apply Filters</button>
            <button class="btn secondary" style="width:100%; margin-top:8px;" onclick="clearFilters()">Clear</button>
        </aside>

        <section>
            <div class="flex items-center justify-between">
                <h1 style="font-size:28px;">Find Your Next Gig</h1>
                <input type="text" id="mainSearchInput" style="max-width:280px;" placeholder="Search" />
            </div>
            
            <!-- Gig listings container -->
            <div id="gigsContainer" class="mt-20">
                <!-- Gigs will be loaded here -->
            </div>
            
            <!-- Pagination -->
            <div id="paginationContainer" class="text-right subtle mt-20"></div>
            
            <div class="section text-center mt-20">
                <p>Not finding what you want? <a href="index.html#get-started">Sign Up</a> for personalized matches.</p>
            </div>
        </section>
    </main>
    <script src="app.js"></script>
    <script>
        let allGigs = [];
        let currentPage = 1;
        const itemsPerPage = 12;
        let isAuthenticated = false;
        
        // Check authentication and load gigs
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if user is authenticated
            try {
                const user = await Auth.verifySession();
                isAuthenticated = !!user;
            } catch (error) {
                isAuthenticated = false;
            }
            
            // Load gigs if authenticated, otherwise show sign-up prompt
            if (isAuthenticated) {
                await loadGigs();
                setupSearchAndFilters();
            } else {
                showSignUpPrompt();
            }
        });
        
        // Load gigs from API
        async function loadGigs() {
            const container = document.getElementById('gigsContainer');
            if (!container) return;
            
            Loading.show(container, 'Loading gigs...');
            
            try {
                const response = await apiFetch(`/gigs?page=${currentPage}&limit=${itemsPerPage}`);
                Loading.hide(container);
                
                if (response.success && response.gigs) {
                    allGigs = response.gigs;
                    displayGigs(allGigs);
                    
                    // Show pagination if available
                    if (response.pagination && response.pagination.total_pages > 1) {
                        displayPagination(response.pagination);
                    } else {
                        document.getElementById('paginationContainer').innerHTML = '';
                    }
                } else {
                    EmptyState.show(
                        container,
                        'üîç',
                        'No Gigs Available',
                        'There are no gigs available at the moment. Check back later for new opportunities.',
                        null
                    );
                }
            } catch (error) {
                Loading.hide(container);
                console.error('Failed to load gigs:', error);
                
                // If error is due to authentication, show sign-up prompt
                if (error.message && error.message.includes('authentication')) {
                    showSignUpPrompt();
                } else {
                    EmptyState.show(
                        container,
                        '‚ö†Ô∏è',
                        'Unable to Load Gigs',
                        'There was an error loading gigs. Please try refreshing the page.',
                        '<button class="btn" onclick="loadGigs()">Retry</button>'
                    );
                }
            }
        }
        
        // Display gigs
        function displayGigs(gigs) {
            const container = document.getElementById('gigsContainer');
            if (!container) return;
            
            if (!gigs || gigs.length === 0) {
                EmptyState.show(
                    container,
                    'üîç',
                    'No Gigs Found',
                    'No gigs match your search. Try adjusting your filters.',
                    '<button class="btn secondary" onclick="clearFilters()">Clear Filters</button>'
                );
                return;
            }
            
            container.innerHTML = gigs.map(gig => {
                const deadline = new Date(gig.deadline).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                const skills = gig.skills ? gig.skills.split(',').slice(0, 2) : [];
                
                return `
                    <article class="section" style="display:grid; grid-template-columns:160px 1fr auto; gap:16px; align-items:center; margin-top:20px;">
                        <div style="height:120px; background:#dbeafe; border-radius:12px;"></div>
                        <div>
                            <div class="subtle">Deadline: ${deadline}</div>
                            <h3 style="margin:8px 0;">${escapeHtml(gig.title || 'Untitled Gig')}</h3>
                            <p class="subtle" style="margin-bottom:8px;">${escapeHtml((gig.description || '').substring(0, 100))}${(gig.description || '').length > 100 ? '...' : ''}</p>
                            <div style="margin-top:8px;">
                                ${skills.map(skill => `<span class="pill blue">${escapeHtml(skill.trim())}</span>`).join(' ')}
                                <span class="pill" style="background:#e0e0e0;">${escapeHtml(gig.location || 'Remote')}</span>
                            </div>
                            <div class="subtle mt-5" style="font-size:12px;">
                                Budget: sh.${parseInt(gig.budget || 0).toLocaleString()} | 
                                ${gig.business_name ? `By: ${escapeHtml(gig.business_name)}` : ''}
                            </div>
                        </div>
                        <div style="display:grid; gap:10px;">
                            ${isAuthenticated ? `
                                <button class="btn secondary" onclick="saveGig(${gig.id})">Save</button>
                                <button class="btn" onclick="showInterest(${gig.id})">Interest</button>
                            ` : `
                                <button class="btn secondary" onclick="window.location.href='auth.html'">Save</button>
                                <button class="btn" onclick="window.location.href='auth.html'">Interest</button>
                            `}
                        </div>
                    </article>
                `;
            }).join('');
        }
        
        // Display pagination
        function displayPagination(pagination) {
            const container = document.getElementById('paginationContainer');
            if (!container) return;
            
            let html = '';
            if (pagination.has_prev) {
                html += `<a href="#" onclick="changePage(${pagination.page - 1}); return false;" style="margin-right:8px;">¬´ Previous</a>`;
            }
            
            html += `<span>Page ${pagination.page} of ${pagination.total_pages}</span>`;
            
            if (pagination.has_next) {
                html += `<a href="#" onclick="changePage(${pagination.page + 1}); return false;" style="margin-left:8px;">Next ¬ª</a>`;
            }
            
            container.innerHTML = html;
        }
        
        // Change page
        function changePage(page) {
            currentPage = page;
            loadGigs();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Setup search and filters
        function setupSearchAndFilters() {
            const mainSearch = document.getElementById('mainSearchInput');
            const sidebarSearch = document.getElementById('searchInput');
            
            // Sync search inputs
            if (mainSearch && sidebarSearch) {
                mainSearch.addEventListener('input', function() {
                    sidebarSearch.value = this.value;
                    filterGigs();
                });
                
                sidebarSearch.addEventListener('input', function() {
                    mainSearch.value = this.value;
                    filterGigs();
                });
            }
        }
        
        // Filter gigs
        function filterGigs() {
            const searchTerm = (document.getElementById('mainSearchInput')?.value || document.getElementById('searchInput')?.value || '').toLowerCase();
            const typeFilter = document.getElementById('typeFilter')?.value || '';
            const locationFilter = (document.getElementById('locationFilter')?.value || '').toLowerCase();
            const budgetMin = parseFloat(document.getElementById('budgetMin')?.value) || 0;
            const budgetMax = parseFloat(document.getElementById('budgetMax')?.value) || Infinity;
            
            let filtered = [...allGigs];
            
            // Search filter
            if (searchTerm) {
                filtered = filtered.filter(gig => {
                    const title = (gig.title || '').toLowerCase();
                    const description = (gig.description || '').toLowerCase();
                    const skills = (gig.skills || '').toLowerCase();
                    return title.includes(searchTerm) || description.includes(searchTerm) || skills.includes(searchTerm);
                });
            }
            
            // Type filter
            if (typeFilter) {
                filtered = filtered.filter(gig => gig.type === typeFilter);
            }
            
            // Location filter
            if (locationFilter) {
                filtered = filtered.filter(gig => {
                    const location = (gig.location || '').toLowerCase();
                    return location.includes(locationFilter);
                });
            }
            
            // Budget filter
            filtered = filtered.filter(gig => {
                const budget = parseFloat(gig.budget || 0);
                return budget >= budgetMin && budget <= budgetMax;
            });
            
            displayGigs(filtered);
        }
        
        // Apply filters
        function applyFilters() {
            filterGigs();
        }
        
        // Clear filters
        function clearFilters() {
            document.getElementById('mainSearchInput').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('locationFilter').value = '';
            document.getElementById('budgetMin').value = '';
            document.getElementById('budgetMax').value = '';
            filterGigs();
        }
        
        // Show sign-up prompt
        function showSignUpPrompt() {
            const container = document.getElementById('gigsContainer');
            if (!container) return;
            
            container.innerHTML = `
                <div class="section text-center" style="padding:60px 20px;">
                    <h2 style="margin-bottom:16px;">Browse Available Gigs</h2>
                    <p class="subtle" style="margin-bottom:24px;">
                        Sign up or log in to browse and apply for gigs, save favorites, and track your applications.
                    </p>
                    <div style="display:flex; gap:12px; justify-content:center;">
                        <a href="signup.html" class="btn">Sign Up</a>
                        <a href="auth.html" class="btn secondary">Log In</a>
                    </div>
                </div>
            `;
        }
        
        // Save gig (authenticated users only)
        async function saveGig(gigId) {
            if (!isAuthenticated) {
                window.location.href = 'auth.html';
                return;
            }
            
            try {
                const response = await apiFetch('/saved-gigs', {
                    method: 'POST',
                    body: JSON.stringify({ gig_id: gigId })
                });
                
                if (response.success) {
                    Toast.success('Gig saved!');
                } else {
                    Toast.error(response.error || 'Failed to save gig');
                }
            } catch (error) {
                console.error('Error saving gig:', error);
                Toast.error('Failed to save gig');
            }
        }
        
        // Show interest (authenticated users only)
        async function showInterest(gigId) {
            if (!isAuthenticated) {
                window.location.href = 'auth.html';
                return;
            }
            
            try {
                const response = await apiFetch(`/gigs/${gigId}/interest`, {
                    method: 'POST'
                });
                
                if (response.success) {
                    Toast.success('Interest noted!');
                } else {
                    Toast.error(response.error || 'Failed to show interest');
                }
            } catch (error) {
                console.error('Error showing interest:', error);
                Toast.error('Failed to show interest');
            }
        }
        
        // Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>